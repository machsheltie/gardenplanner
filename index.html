<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026 Garden Planner ‚Äî Shepherdsville, KY 40165</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#f8faf5;color:#2d3b2d;padding:16px;max-width:1500px;margin:0 auto}
header{text-align:center;padding:24px 20px;background:linear-gradient(135deg,#2d5a27,#4a8c3f);border-radius:16px;color:#fff;margin-bottom:20px}
header h1{font-size:1.7em;font-weight:800;margin-bottom:6px}
header .sub{font-size:.9em;opacity:.9}
.fi{display:flex;justify-content:center;gap:20px;margin-top:14px;flex-wrap:wrap}
.fb{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:8px 16px;text-align:center}
.fb .l{font-size:.7em;text-transform:uppercase;letter-spacing:.05em;opacity:.85}
.fb .d{font-size:1.1em;font-weight:700}
.tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:3px solid #2d5a27}
.tab{padding:10px 20px;font-family:inherit;font-size:.9em;font-weight:600;background:#e8f0e4;border:none;border-radius:10px 10px 0 0;cursor:pointer;color:#2d5a27;transition:.2s}
.tab:hover{background:#d0e0cc}
.tab.active{background:#2d5a27;color:#fff}
.tc{display:none}.tc.active{display:block}
.ctrls{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.ctrls input{flex:1;min-width:180px;padding:9px 12px;border:2px solid #d4ddd4;border-radius:10px;font-size:.88em;font-family:inherit;background:#fff}
.ctrls input:focus{outline:none;border-color:#4a8c3f}
.fbtn{padding:7px 14px;border:2px solid #d4ddd4;border-radius:10px;background:#fff;font-family:inherit;font-size:.82em;cursor:pointer;transition:.2s;white-space:nowrap}
.fbtn:hover{border-color:#4a8c3f;background:#f0f7f0}
.fbtn.active{background:#4a8c3f;color:#fff;border-color:#4a8c3f}
.legend{display:flex;gap:14px;margin-bottom:14px;flex-wrap:wrap;font-size:.82em;background:#fff;padding:10px 14px;border-radius:10px;border:2px solid #d4ddd4;position:sticky;top:0;z-index:20;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.legend-item{display:flex;align-items:center;gap:5px;font-weight:500}
.lb{display:inline-block;width:26px;height:20px;line-height:20px;text-align:center;border-radius:4px;font-weight:700;font-size:.75em}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06);font-size:.82em}
thead th{background:#2d5a27;color:#fff;padding:10px 6px;text-align:center;font-weight:600;font-size:.82em;position:sticky;top:44px;z-index:10}
thead th:first-child{text-align:left;padding-left:12px;min-width:160px}
thead th:nth-child(2){min-width:90px;text-align:left}
tbody tr{border-bottom:1px solid #e8ede8}
tbody tr:hover{background:#f5faf5}
tbody tr.hl{background:#fffbeb}
tbody td{padding:8px 6px;text-align:center;vertical-align:middle}
tbody td:first-child{text-align:left;padding-left:12px;font-weight:600}
tbody td:nth-child(2){text-align:left;font-size:.82em;color:#6b7b6b}
.ch{background:#e8f0e4!important;font-weight:700!important;font-size:.88em!important;color:#2d5a27;text-transform:uppercase;letter-spacing:.04em}
.ch td{padding:8px 12px!important}
.ci{background:#dbeafe;color:#1e40af;border-radius:4px;font-weight:700;font-size:.78em}
.cd{background:#d1fae5;color:#065f46;border-radius:4px;font-weight:700;font-size:.78em}
.ct{background:#fef3c7;color:#92400e;border-radius:4px;font-weight:700;font-size:.78em}
.cv{background:#fce7f3;color:#9d174d;border-radius:4px;font-weight:700;font-size:.78em}
.cf{background:#e0e7ff;color:#3730a3;border-radius:4px;font-weight:700;font-size:.78em}
.tc2{border-left:3px solid #f59e0b!important;border-right:3px solid #f59e0b!important}
.th2{background:#f59e0b!important;color:#000!important}
.ms{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;line-height:1;font-size:.62em;font-weight:700;padding:1px 0}
.nc{font-size:.78em;color:#6b7b6b;text-align:left!important;max-width:180px;line-height:1.3}
.hid{display:none}
.dl{display:flex;gap:20px}
.ds{width:280px;flex-shrink:0}
.dm{flex:1;min-width:0}
.vl{background:#fff;border-radius:12px;border:2px solid #d4ddd4;overflow:hidden;max-height:82vh;overflow-y:auto}
.vlh{padding:12px 14px;background:#2d5a27;color:#fff;font-weight:700;font-size:.9em;position:sticky;top:0;z-index:5}
.vls{width:100%;padding:8px 12px;border:none;border-bottom:2px solid #e8ede8;font-family:inherit;font-size:.85em;position:sticky;top:38px;z-index:4;background:#fff}
.vls:focus{outline:none;border-bottom-color:#4a8c3f}
.vc2{padding:8px 14px;font-weight:700;font-size:.78em;color:#2d5a27;background:#f0f5ee;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid #e8ede8}
.vi{padding:9px 14px;cursor:pointer;border-bottom:1px solid #f0f5f0;font-size:.88em;transition:.15s;display:flex;justify-content:space-between;align-items:center}
.vi:hover{background:#f5faf5}
.vi.act{background:#e8f5e0;border-left:4px solid #4a8c3f;font-weight:600}
.tg{font-size:.7em;padding:2px 6px;border-radius:6px;font-weight:600}
.tg-c{background:#dbeafe;color:#1e40af}
.tg-w{background:#fef3c7;color:#92400e}
.vnc{font-size:.72em;color:#4a8c3f;font-weight:600;background:#e8f5e0;padding:2px 7px;border-radius:8px}
.dc{background:#fff;border-radius:12px;border:2px solid #d4ddd4;overflow:hidden}
.dch{padding:16px 20px;background:linear-gradient(135deg,#2d5a27,#4a8c3f);color:#fff}
.dch h2{font-size:1.3em;font-weight:700}
.dch .mt{font-size:.85em;opacity:.9;margin-top:4px}
.dcb{padding:20px}
.ig{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.ib{background:#f8faf5;border-radius:10px;padding:12px 14px;border:1px solid #e8ede8}
.ib .il{font-size:.72em;text-transform:uppercase;letter-spacing:.05em;color:#6b7b6b;font-weight:600;margin-bottom:4px}
.ib .iv{font-size:.95em;font-weight:600;color:#2d3b2d}
.st{font-size:1em;font-weight:700;color:#2d5a27;margin:20px 0 10px;padding-bottom:6px;border-bottom:2px solid #e8f0e4}
.tp{background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px 14px;margin-bottom:10px;font-size:.88em;line-height:1.5}
.tp strong{color:#92400e}
.vc{background:#fff;border:2px solid #d4ddd4;border-radius:12px;padding:16px;margin-bottom:14px}
.vc:hover{border-color:#4a8c3f}
.vc h3{font-size:1.05em;font-weight:700;color:#2d5a27;margin-bottom:4px}
.vc .vm{font-size:.82em;color:#6b7b6b;margin-bottom:10px}
.vc .vd{font-size:.88em;line-height:1.55;margin-bottom:10px}
.vc .vdt{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.82em}
.vc .vdi{display:flex;gap:6px}
.vc .vdl{color:#6b7b6b;font-weight:500}
.vc .vdv{font-weight:600}
.vc .qt{font-style:italic;color:#6b7b6b;font-size:.85em;margin:8px 0;padding-left:12px;border-left:3px solid #d4ddd4;line-height:1.4}
.stg{display:inline-block;font-size:.72em;background:#e8f5e0;color:#2d5a27;padding:2px 8px;border-radius:6px;font-weight:600;margin-right:4px;margin-top:6px}
.es{text-align:center;padding:60px 20px;color:#6b7b6b}
.es .icon{font-size:3em;margin-bottom:12px}
.es h3{font-size:1.1em;margin-bottom:8px;color:#2d3b2d}
.nb{background:linear-gradient(90deg,#fef3c7,#fde68a);border:2px solid #f59e0b;border-radius:12px;padding:12px 18px;margin-bottom:18px;font-size:.88em;line-height:1.5}
.nb strong{color:#92400e}
.nv{padding:20px;text-align:center;color:#6b7b6b;background:#f8faf5;border-radius:10px;font-size:.9em}
.tdx{margin-top:14px;background:#f8faf5;border:1px solid #e0e8de;border-radius:10px;padding:12px}
.tdx h4{font-size:.9em;color:#2d5a27;margin-bottom:8px}
.tdx-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}
.tdx-item{background:#fff;border:1px solid #e5ece4;border-radius:8px;padding:8px 10px;font-size:.82em}
.tdx-item b{display:block;color:#6b7b6b;font-size:.72em;text-transform:uppercase;letter-spacing:.04em;margin-bottom:2px}
.tdx-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tdx-tags span{background:#eef6ea;color:#2d5a27;border-radius:999px;padding:3px 8px;font-size:.72em;font-weight:600}
.symx{margin-top:10px;background:#fff;border:1px solid #e5ece4;border-radius:10px;padding:10px}
.symx-head{font-size:.78em;font-weight:700;color:#2d5a27;margin-bottom:6px}
.symx-row{display:flex;gap:6px;flex-wrap:wrap}
.symx-row input{flex:1;min-width:220px;padding:7px 9px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.8em;background:#fff}
.symx-row button{padding:7px 9px;border:2px solid #d4ddd4;border-radius:8px;background:#fff;font-family:inherit;font-size:.78em;cursor:pointer}
.symx-row button:hover{border-color:#4a8c3f;background:#f0f7f0}
.symx-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.symx-chips button{border:1px solid #d8e4d4;background:#f6faf4;color:#355335;border-radius:999px;padding:4px 8px;font-size:.72em;cursor:pointer}
.symx-chips button:hover{background:#eaf5e4;border-color:#bcd3b8}
.symx-result{margin-top:8px;background:#f8fbf6;border:1px solid #e0e8de;border-radius:8px;padding:8px 10px;font-size:.78em;line-height:1.35;color:#4f5f4f}
.symx-issue{padding:6px 0;border-top:1px dashed #dbe6d7}
.symx-issue:first-child{border-top:none;padding-top:0}
.symx-issue b{color:#2d5a27}
.obx-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.obx-item{background:#fff;border:1px solid #e0e8de;border-radius:8px;padding:8px 10px}
.obx-head{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
.obx-head b{color:#2d5a27;font-size:.82em}
.obx-meta{font-size:.72em;color:#5b6b5b}
.obx-body{font-size:.78em;color:#4f5f4f;line-height:1.35;margin-top:4px}
.obx-actions{display:flex;gap:6px;flex-wrap:wrap}
.obx-actions button{padding:4px 7px;border:1px solid #d4ddd4;border-radius:999px;background:#fff;font-size:.68em;cursor:pointer}
.obx-actions button.danger{border-color:#fca5a5;background:#fff5f5;color:#991b1b}
.anx-wrap{margin-top:8px;display:grid;gap:8px}
.anx-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px}
.anx-kpi{background:#fff;border:1px solid #e0e8de;border-radius:8px;padding:8px}
.anx-kpi b{display:block;font-size:.7em;text-transform:uppercase;letter-spacing:.04em;color:#5f6f5f;margin-bottom:3px}
.anx-kpi span{font-size:.95em;font-weight:700;color:#2d5a27}
.anx-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.anx-card{background:#fff;border:1px solid #e0e8de;border-radius:8px;padding:8px}
.anx-card h5{font-size:.77em;color:#2d5a27;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em}
.anx-list{display:flex;flex-direction:column;gap:5px}
.anx-item{font-size:.75em;line-height:1.35;color:#4f5f4f;background:#f8fbf6;border:1px solid #e8efE6;border-radius:7px;padding:6px 7px}
.anx-item strong{color:#2d5a27}
.anx-item .meta{display:block;color:#6a7a69;font-size:.92em}
.anx-empty{font-size:.75em;color:#6a7a69;background:#f8fbf6;border:1px dashed #dbe5d9;border-radius:7px;padding:7px}
.anx-recs{display:flex;flex-direction:column;gap:6px}
.anx-rec{font-size:.75em;line-height:1.35;background:#eef6ea;border:1px solid #d8e4d4;color:#355335;border-radius:7px;padding:7px}
.anx-rec.warn{background:#fffbeb;border-color:#fde68a;color:#7c5200}
.anx-chip{display:inline-block;margin-left:4px;padding:1px 6px;border-radius:999px;font-size:.66em;font-weight:700;background:#eef6ea;color:#355335}
.tx-box{margin:10px 0;background:#f9fbf8;border:1px solid #e0e8de;border-radius:10px;padding:10px}
.tx-head{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.tx-head h4{font-size:.84em;color:#2d5a27}
.tx-ctrls{display:flex;gap:8px;flex-wrap:wrap}
.tx-ctrls select{padding:6px 8px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.76em;background:#fff}
.tx-ctrls button{padding:6px 8px;border:2px solid #d4ddd4;border-radius:8px;background:#fff;font-family:inherit;font-size:.75em;cursor:pointer}
.tx-list{display:flex;flex-direction:column;gap:6px}
.tx-item{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;background:#fff;border:1px solid #e0e8de;border-radius:8px;padding:7px 8px}
.tx-item.done{opacity:.72;background:#f7faf6}
.tx-item.snoozed{border-style:dashed}
.tx-pri{display:inline-flex;align-items:center;justify-content:center;min-width:38px;height:20px;padding:0 6px;border-radius:999px;font-size:.66em;font-weight:700}
.tx-pri.high{background:#fee2e2;color:#991b1b}
.tx-pri.med{background:#fef3c7;color:#92400e}
.tx-pri.low{background:#e0f2fe;color:#075985}
.tx-body{font-size:.76em;color:#435343;line-height:1.35}
.tx-title{font-weight:700;color:#2d5a27}
.tx-meta{display:flex;flex-wrap:wrap;gap:5px;margin-top:3px}
.tx-meta span{font-size:.67em;background:#f3f7f1;border:1px solid #e0e8de;color:#5d6d5d;border-radius:999px;padding:2px 6px}
.tx-actions{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px}
.tx-actions button{padding:3px 7px;border:1px solid #d4ddd4;border-radius:999px;background:#fff;font-size:.67em;cursor:pointer}
.tx-actions button.done{border-color:#86efac;background:#f0fdf4;color:#166534}
.tx-actions button.warn{border-color:#fde68a;background:#fffbeb;color:#7c5200}
.tx-actions button.note{border-color:#bfdbfe;background:#eff6ff;color:#1d4ed8}
.tx-empty{font-size:.76em;color:#6a7a69;background:#fff;border:1px dashed #dbe5d9;border-radius:8px;padding:8px}
.pt-wrap{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
.pt-card{background:#fff;border:2px solid #d4ddd4;border-radius:12px;padding:14px}
.pt-card h3{font-size:1em;color:#2d5a27;margin-bottom:10px}
.pt-ctrls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.pt-ctrls input,.pt-ctrls select{padding:8px 10px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.84em;background:#fff}
.pt-ctrls input{width:110px}
.pt-recipes{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:10px}
.pt-recipes label{font-size:.78em;color:#4f5f4f}
.pt-recipes input{width:100%;margin-top:4px;padding:8px 10px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.84em;background:#fff}
.pt-recipes-note{font-size:.78em;color:#5f6f5f;background:#f8fbf6;border:1px solid #e0e8de;border-radius:8px;padding:8px 10px;margin-bottom:10px}
.pt-mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.pt-mini-card{background:#f9fbf8;border:1px solid #e0e8de;border-radius:10px;padding:10px}
.pt-mini-card h4{font-size:.84em;color:#2d5a27;margin-bottom:8px}
.pt-subhead{margin-top:10px;font-size:.76em;font-weight:700;color:#2d5a27;text-transform:uppercase;letter-spacing:.04em}
.pt-callout{font-size:.76em;color:#4b5a4b;background:#f6faf4;border:1px solid #dfe8dc;border-radius:8px;padding:8px 10px;margin-top:8px;line-height:1.35}
.pt-callout.warn{background:#fffbeb;border-color:#fde68a;color:#7c5200}
.pt-mini-ctrls{display:grid;grid-template-columns:repeat(2,minmax(110px,1fr));gap:8px}
.pt-mini-ctrls label{font-size:.74em;color:#4f5f4f}
.pt-mini-ctrls input:not([type="checkbox"]):not([type="file"]),.pt-mini-ctrls select{width:100%;margin-top:4px;padding:7px 8px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.8em;background:#fff}
.pt-mini-ctrls input[type="checkbox"]{width:auto;margin-right:6px;vertical-align:middle;accent-color:#4a8c3f}
.pt-mini-ctrls textarea{width:100%;margin-top:4px;padding:7px 8px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.8em;background:#fff;resize:vertical}
.pt-alert-box{font-size:.78em;color:#4b5a4b;background:#f6faf4;border:1px solid #dfe8dc;border-radius:8px;padding:8px 10px;margin-top:8px;line-height:1.35}
.pt-alert-box .warn{color:#92400e;font-weight:700}
.pt-alert-box .good{color:#166534;font-weight:700}
.pt-beds-list{display:flex;flex-direction:column;gap:6px}
.pt-bed-row{display:grid;grid-template-columns:1.15fr .7fr .7fr .85fr .85fr auto;gap:6px;align-items:end}
.pt-bed-row input,.pt-bed-row select{width:100%;padding:6px 8px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.78em;background:#fff}
.pt-bed-row label{font-size:.72em;color:#4f5f4f}
.pt-bed-row button{padding:7px 8px;border:2px solid #d4ddd4;border-radius:8px;background:#fff;font-family:inherit;font-size:.75em;cursor:pointer}
.pt-bed-row-extra{display:grid;grid-template-columns:1fr .8fr .9fr .9fr;gap:6px;align-items:end;margin-top:4px}
.pt-bed-row-extra input,.pt-bed-row-extra select{width:100%;padding:6px 8px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.78em;background:#fff}
.pt-bed-row-extra label{font-size:.72em;color:#4f5f4f}
.pt-bed-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pt-bed-actions button{padding:7px 9px;border:2px solid #d4ddd4;border-radius:8px;background:#fff;font-family:inherit;font-size:.78em;cursor:pointer}
.pt-bed-actions button.danger{border-color:#fca5a5;background:#fff5f5;color:#991b1b}
.pt-bed-actions button.warn{border-color:#fde68a;background:#fffbeb;color:#7c5200}
.pt-bed-summary,.pt-bed-alloc{font-size:.78em;color:#4f5f4f;background:#f8fbf6;border:1px solid #e0e8de;border-radius:8px;padding:8px 10px;margin-top:8px;line-height:1.35}
.pt-bed-alloc code{font-size:.9em}
.pt-bed-maps{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
.pt-bed-map-card{background:#fff;border:1px solid #e0e8de;border-radius:10px;padding:10px}
.pt-bed-map-head{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.pt-bed-map-head b{color:#2d5a27}
.pt-bed-map-meta{font-size:.74em;color:#5a6a5a}
.pt-bed-map-grid{display:grid;gap:3px;background:#eef4eb;border:1px solid #dfe8dc;border-radius:8px;padding:6px}
.pt-bed-map-grid.drop-target{outline:2px dashed #4a8c3f;outline-offset:2px;background:#e8f5e0}
.pt-bed-cell{min-height:20px;border-radius:4px;border:1px solid rgba(255,255,255,.45);position:relative}
.pt-bed-cell.empty{background:repeating-linear-gradient(45deg,#f6faf4,#f6faf4 6px,#edf4ea 6px,#edf4ea 12px);border-color:#e5ece2}
.pt-bed-cell.dragging{opacity:.55}
.pt-bed-cell.locked{box-shadow:inset 0 0 0 2px #f59e0b}
.pt-bed-cell span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.62em;font-weight:700;color:#173117;text-shadow:0 1px 0 rgba(255,255,255,.6)}
.pt-bed-legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.pt-bed-legend-item{display:flex;align-items:center;gap:5px;background:#f8fbf6;border:1px solid #e0e8de;border-radius:999px;padding:3px 8px;font-size:.72em;color:#425242}
.pt-bed-legend-item[draggable="true"]{cursor:grab}
.pt-bed-legend-item.locked{border-color:#f59e0b;background:#fffbeb}
.pt-bed-legend-swatch{width:11px;height:11px;border-radius:3px;border:1px solid rgba(0,0,0,.08)}
.pt-bed-legend-item button{padding:2px 6px;border:1px solid #d4ddd4;background:#fff;border-radius:999px;font-size:.68em;cursor:pointer}
.pt-bed-empty{font-size:.76em;color:#617161}
.pt-bed-rowmap{margin-top:8px;background:#f8fbf6;border:1px solid #e0e8de;border-radius:8px;padding:8px}
.pt-bed-rowmap-head{font-size:.74em;color:#536353;margin-bottom:6px}
.pt-rowlane{display:grid;grid-template-columns:54px 1fr;gap:6px;align-items:center;margin-bottom:5px}
.pt-rowlane:last-child{margin-bottom:0}
.pt-rowlane-label{font-size:.72em;color:#4f5f4f;font-weight:600}
.pt-rowlane-label .trellis{color:#7c5200}
.pt-rowlane-label .risk{color:#991b1b}
.pt-rowlane-prev{display:block;margin-top:2px}
.pt-rowlane-prev select{width:100%;font-size:.68em;border:1px solid #d4ddd4;border-radius:6px;padding:1px 4px;background:#fff;color:#465646}
.pt-rowlane-track{position:relative;height:20px;background:#eef4eb;border:1px solid #dfe8dc;border-radius:999px;overflow:hidden}
.pt-rowlane-track.trellis{box-shadow:inset 0 0 0 2px #f59e0b33}
.pt-rowlane-track.drop-target{outline:2px dashed #4a8c3f;outline-offset:1px;background:#e8f5e0}
.pt-rowlane-seg{position:absolute;top:1px;bottom:1px;border-radius:999px;border:1px solid rgba(255,255,255,.55);display:flex;align-items:center;justify-content:center;font-size:.62em;font-weight:700;color:#173117;overflow:hidden;white-space:nowrap;padding:0 4px}
.pt-rowlane-seg.tight{box-shadow:inset 0 0 0 2px #ef4444}
.pt-rowlane-overflow{font-size:.68em;color:#92400e;margin-left:60px;margin-top:-2px;margin-bottom:4px}
.pt-rowlane-warning{font-size:.68em;color:#92400e;margin-left:60px;margin-top:-2px;margin-bottom:4px}
.pt-rowlane-hint{font-size:.68em;color:#5a6a5a;margin-left:60px;margin-top:-2px;margin-bottom:4px}
.vrtags{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.vrtag{display:inline-block;background:#eef6ea;color:#2d5a27;border-radius:999px;padding:2px 7px;font-size:.7em;font-weight:600}
.vrtag.recipe{background:#fff3cd;color:#7c5200}
.vrtag.role{background:#e0f2fe;color:#075985}
.pt-sum{font-size:.84em;color:#4a5a49;background:#f6faf4;border:1px solid #e0e8de;border-radius:8px;padding:8px 10px;margin-bottom:10px}
.pt-tbl-wrap{max-height:60vh;overflow:auto;border:1px solid #e5ece4;border-radius:10px}
.pt-tbl{width:100%;border-collapse:collapse;font-size:.8em}
.pt-tbl th,.pt-tbl td{padding:8px 6px;border-bottom:1px solid #eef2ed;text-align:left;vertical-align:top}
.pt-tbl th{position:sticky;top:0;background:#f1f6ef;color:#2d5a27;font-weight:700}
.pt-tbl td:nth-child(n+3){text-align:center}
.pt-chip{display:inline-block;background:#e8f5e0;color:#2d5a27;border-radius:999px;padding:2px 8px;font-size:.72em;font-weight:600}
.mg-box{display:flex;flex-direction:column;gap:10px}
.mg-note{font-size:.82em;color:#5f6f5f;background:#f6faf4;border:1px solid #e0e8de;border-radius:8px;padding:8px 10px}
.mg-q{display:flex;gap:8px;flex-wrap:wrap}
.mg-q input{flex:1;min-width:220px;padding:9px 10px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.85em}
.mg-q button,.mg-quick button{padding:8px 10px;border:2px solid #d4ddd4;border-radius:8px;background:#fff;font-family:inherit;font-size:.8em;cursor:pointer}
.mg-q button:hover,.mg-quick button:hover{border-color:#4a8c3f;background:#f0f7f0}
.mg-quick{display:flex;gap:6px;flex-wrap:wrap}
.mg-config{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px}
.mg-config label{font-size:.76em;color:#536353}
.mg-config input,.mg-config select{width:100%;margin-top:4px;padding:7px 9px;border:2px solid #d4ddd4;border-radius:8px;font-family:inherit;font-size:.8em;background:#fff}
.mg-config-actions{display:flex;gap:8px;align-items:center}
.mg-config-actions button{padding:7px 10px;border:2px solid #d4ddd4;border-radius:8px;background:#fff;font-family:inherit;font-size:.78em;cursor:pointer}
.mg-status{font-size:.75em;color:#647464}
.mg-resp{background:#fff;border:1px solid #e5ece4;border-radius:10px;padding:10px 12px;font-size:.86em;line-height:1.45;min-height:120px}
.mg-src{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
.mg-src span{background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;font-size:.72em;font-weight:600}
.mg-ctx{background:#0f172a;color:#dbeafe;border-radius:10px;padding:10px 12px;font-size:.75em;max-height:220px;overflow:auto;white-space:pre-wrap}
@media(max-width:900px){.dl{flex-direction:column}.ds{width:100%}.vl{max-height:300px}.ig{grid-template-columns:1fr 1fr}.vc .vdt{grid-template-columns:1fr}}
@media(max-width:900px){.pt-wrap{grid-template-columns:1fr}.pt-mini-grid{grid-template-columns:1fr}.pt-bed-row{grid-template-columns:1fr 1fr 1fr}.pt-bed-row button{grid-column:1/-1}.pt-bed-row-extra{grid-template-columns:1fr 1fr}.pt-bed-cell{min-height:16px}.pt-rowlane{grid-template-columns:44px 1fr}.anx-grid{grid-template-columns:1fr}}
@media(max-width:600px){.tabs{overflow-x:auto}.tab{padding:8px 12px;font-size:.8em;white-space:nowrap}table{font-size:.72em}header h1{font-size:1.3em}.pt-ctrls input{width:95px}}
</style>
</head>
<body>
<header>
<h1>üå± 2026 Garden Planner</h1>
<div class="sub">Shepherdsville, KY 40165 ¬∑ Zone 6b/7a ¬∑ Bullitt County</div>
<div class="fi">
<div class="fb"><div class="l">Last Spring Frost</div><div class="d">April 18</div></div>
<div class="fb"><div class="l">First Fall Frost</div><div class="d">October 15</div></div>
<div class="fb"><div class="l">Growing Season</div><div class="d">~180 Days</div></div>
</div>
</header>
<div class="tabs">
<button class="tab active" onclick="switchTab('cal',this)">üìÖ Planting Calendar</button>
<button class="tab" onclick="switchTab('det',this)">üåø Varieties & Tips</button>
<button class="tab" onclick="switchTab('plan',this)">üß† Planner & AI</button>
</div>
<div class="tc active" id="tab-cal">
<div class="nb" id="todaySummary"></div>
<div class="ctrls">
<input type="text" id="searchBox" placeholder="Search vegetables..." oninput="filterTable()">
<button class="fbtn active" onclick="setFilter('all',this)">All</button>
<button class="fbtn" id="btnCurrentMonth" onclick="setFilter('current',this)">This Month</button>
<button class="fbtn" id="btnNextMonth" onclick="setFilter('next',this)">Next Month</button>
<button class="fbtn" onclick="setFilter('cool',this)">Cool Season</button>
<button class="fbtn" onclick="setFilter('warm',this)">Warm Season</button>
</div>
<div class="legend">
<div class="legend-item"><span class="lb ci">IN</span> Start Indoors</div>
<div class="legend-item"><span class="lb ct">TP</span> Transplant Out</div>
<div class="legend-item"><span class="lb cd">DS</span> Direct Sow</div>
<div class="legend-item"><span class="lb cf">FS</span> Fall Sowing</div>
<div class="legend-item"><span class="lb cv">H</span> Harvest</div>
</div>
<div style="overflow-x:auto"><table><thead><tr><th>Vegetable</th><th>Method</th><th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th><th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th><th>Notes</th></tr></thead><tbody id="tb"></tbody></table></div>
</div>
<div class="tc" id="tab-det">
<div class="dl">
<div class="ds"><div class="vl"><div class="vlh">Select a Vegetable</div><input type="text" class="vls" id="vegSearch" placeholder="Search..." oninput="filterVL()"><div id="vli"></div></div></div>
<div class="dm" id="dMain"><div class="es"><div class="icon">üå±</div><h3>Select a vegetable from the list</h3><p>View growing tips, planting dates, and your selected varieties.</p></div></div>
</div>
</div>
<div class="tc" id="tab-plan">
<div class="pt-wrap">
<div class="pt-card">
<h3>People Planner (MVP)</h3>
<div class="pt-ctrls">
<label>People <input id="peopleCountInput" type="number" min="1" max="20" value="2" oninput="handlePlannerControls()"></label>
<label>Goal <select id="plannerMode" onchange="handlePlannerControls()"><option value="fresh">Fresh</option><option value="balanced" selected>Balanced</option><option value="preserve">Preserve-heavy</option></select></label>
<label>Bed Space (sq ft) <input id="bedSpaceLimitInput" type="number" min="0" max="5000" step="1" value="0" oninput="handlePlannerControls()" title="0 = no limit"></label>
<label>When Tight <select id="plannerPriorityMode" onchange="handlePlannerControls()"><option value="balanced" selected>Balanced priority</option><option value="recipe_first">Recipe targets first</option><option value="fresh_first">Fresh staples first</option></select></label>
<label>Search <input id="plannerSearch" type="text" placeholder="Filter crops..." oninput="handlePlannerControls()"></label>
</div>
<div class="pt-recipes">
<label>Salsa (pints)<input id="rtSalsaPints" type="number" min="0" value="0" oninput="handlePlannerControls()"></label>
<label>Pickles (quarts)<input id="rtPickleQuarts" type="number" min="0" value="0" oninput="handlePlannerControls()"></label>
<label>Pesto (batches)<input id="rtPestoBatches" type="number" min="0" value="0" oninput="handlePlannerControls()"></label>
<label>Curry (pots)<input id="rtCurryPots" type="number" min="0" value="0" oninput="handlePlannerControls()"></label>
</div>
<div class="pt-recipes-note" id="recipeDemandSummary">Recipe target boosts are off (all set to 0).</div>
<div class="tx-box">
<div class="tx-head">
<h4>Task Engine (MVP)</h4>
<div class="tx-ctrls">
<select id="taskWindowMode" onchange="handleTaskEngineControlsChange()">
<option value="today">Today</option>
<option value="week" selected>This Week</option>
<option value="month">This Month</option>
</select>
<select id="taskFocusMode" onchange="handleTaskEngineControlsChange()">
<option value="auto" selected>Auto focus</option>
<option value="selected">Selected crop</option>
<option value="all">All crops</option>
</select>
<button type="button" onclick="renderPeoplePlanner()">Refresh Tasks</button>
</div>
</div>
<div id="taskEngineList" class="tx-list"><div class="tx-empty">Task suggestions will appear after the planner renders.</div></div>
</div>
<div class="pt-mini-grid">
<div class="pt-mini-card">
<h4>Weather & Clay Risk (MVP)</h4>
<div class="pt-mini-ctrls">
<label>Rain Last 3d (in)<input id="wxRainLast3d" type="number" min="0" max="20" step="0.1" value="0" oninput="handleWeatherControls()"></label>
<label>Rain Next 3d (in)<input id="wxRainNext3d" type="number" min="0" max="20" step="0.1" value="0" oninput="handleWeatherControls()"></label>
<label>Humidity Risk<select id="wxHumidityRisk" onchange="handleWeatherControls()"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></label>
<label>Soil Condition<select id="wxSoilCondition" onchange="handleWeatherControls()"><option value="workable" selected>Workable</option><option value="damp">Damp</option><option value="wet">Wet</option></select></label>
</div>
<div class="pt-alert-box" id="plannerWeatherAlerts">Set weather conditions to generate clay-soil and mildew alerts.</div>
</div>
<div class="pt-mini-card">
<h4>Beds (MVP)</h4>
<div class="pt-subhead">Row History Presets</div>
<div class="pt-mini-ctrls">
<label>Planning Year <input id="rowHistoryPlanYear" type="number" min="2020" max="2100" value="2026" oninput="handleRowHistoryPresetUiChange()"></label>
<label>Preset Name <input id="rowHistoryPresetName" type="text" maxlength="40" placeholder="2025 bed state" oninput="handleRowHistoryPresetUiChange()"></label>
<label>Row History Preset <select id="rowHistoryPresetSelect" onchange="handleRowHistoryPresetSelectionChange()"><option value="">(none)</option></select></label>
</div>
<div class="pt-bed-actions">
<button type="button" onclick="saveRowHistoryPreset()">Save Row History</button>
<button type="button" onclick="loadSelectedRowHistoryPreset()">Load Selected</button>
<button type="button" onclick="loadPreviousYearRowHistoryPreset()">Load Prev Year</button>
<button type="button" class="danger" onclick="deleteSelectedRowHistoryPreset()">Delete Preset</button>
</div>
<div class="pt-bed-summary" id="rowHistoryPresetStatus">Save a season/year snapshot of row history, then load it next season.</div>
<div class="pt-subhead">Season Archive</div>
<div class="pt-mini-ctrls">
<label>Archive Name <input id="seasonArchiveName" type="text" maxlength="48" placeholder="2025 season review" oninput="handleSeasonArchiveUiChange()"></label>
<label>Season Archive <select id="seasonArchiveSelect" onchange="handleSeasonArchiveSelectionChange()"><option value="">(none)</option></select></label>
<label>Pest Pressure<select id="seasonArchivePestPressure" onchange="handleSeasonArchiveUiChange()"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></label>
<label>Disease Pressure<select id="seasonArchiveDiseasePressure" onchange="handleSeasonArchiveUiChange()"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></label>
</div>
<div class="pt-mini-ctrls">
<label>Yield Summary<input id="seasonArchiveYieldSummary" type="text" maxlength="220" placeholder="Tomatoes strong, peppers moderate, cucumbers struggled..."></label>
<label style="grid-column:1/-1">Season Notes<textarea id="seasonArchiveNotes" rows="3" maxlength="1200" placeholder="What worked, what failed, pest timing, variety winners, soil notes..." oninput="handleSeasonArchiveUiChange()"></textarea></label>
</div>
<div class="pt-bed-actions">
<button type="button" onclick="addSeasonArchiveCropOutcomeRow()">Add Crop Outcome Row</button>
<button type="button" onclick="seedSeasonArchiveCropOutcomesFromPlanner()">Seed From Planner</button>
<button type="button" onclick="suggestSeasonArchivePressureFromObservations()">Suggest Pressure from Logs</button>
<button type="button" onclick="mergeObservationLogsIntoSeasonArchiveCropOutcomes()">Promote Logs to Outcomes</button>
</div>
<div id="seasonArchiveCropOutcomesEditor" class="pt-beds-list"></div>
<div class="pt-bed-actions">
<button type="button" onclick="saveSeasonArchive()">Save Season Archive</button>
<button type="button" onclick="loadSelectedSeasonArchiveToForm()">Load Archive Notes</button>
<button type="button" class="warn" onclick="applySelectedSeasonArchiveRowHistory()">Apply Archive Row History</button>
<button type="button" class="danger" onclick="deleteSelectedSeasonArchive()">Delete Archive</button>
</div>
<div class="pt-bed-summary" id="seasonArchiveStatus">Archive end-of-season outcomes so rotation decisions are backed by real results.</div>
<div class="pt-bed-alloc" id="seasonArchiveSummary">No season archives saved yet.</div>
<div class="pt-subhead">Backup / Restore</div>
<div class="pt-callout warn">Importing a backup overwrites your current local beds, presets, archives, planner settings, and weather. Export a backup first if you want a rollback point.</div>
<div class="pt-mini-ctrls">
<label><input id="backupIncludeAssistantCfg" type="checkbox" checked onchange="handleBackupControlsChange()"> Include AI settings (endpoints/model only, no keys/tokens)</label>
<input id="gardenBackupImportFile" type="file" accept=".json,application/json" style="display:none" onchange="handleGardenBackupFileSelected(event)">
</div>
<div class="pt-bed-actions">
<button type="button" onclick="exportGardenBackup()">Export Backup JSON</button>
<button type="button" class="warn" onclick="triggerGardenBackupImport()">Import Backup JSON</button>
</div>
<div class="pt-bed-summary" id="gardenBackupStatus">Back up your beds, presets, archives, planner settings, and weather before major edits.</div>
<div class="pt-subhead">Observation Log</div>
<div class="pt-mini-ctrls">
<label>Date <input id="obsDate" type="date"></label>
<label>Crop <select id="obsCrop"></select></label>
<label>Bed <select id="obsBed" onchange="handleObservationBedChange()"></select></label>
<label>Row <select id="obsRow"></select></label>
<label>Symptom / Issue <input id="obsSymptom" type="text" maxlength="140" placeholder="yellow leaf spots, chewing, wilt..."></label>
<label>Photo Ref <input id="obsPhotoRef" type="text" maxlength="220" placeholder="file name, path, or URL"></label>
</div>
<div class="pt-mini-ctrls">
<label style="grid-column:1/-1">Notes<textarea id="obsNotes" rows="2" maxlength="1200" placeholder="What you observed, bed/row, weather context, what you did..."></textarea></label>
</div>
<div class="pt-bed-actions">
<button type="button" onclick="saveObservationLogEntry()">Add Observation</button>
<button type="button" onclick="prefillObservationFromSelectedCrop()">Use Selected Crop</button>
<button type="button" onclick="clearObservationLogForm()">Clear Form</button>
</div>
<div class="pt-bed-summary" id="observationLogStatus">Log field observations (including photo references) to build in-season memory for troubleshooting and next-year planning.</div>
<div class="obx-list" id="observationLogList"></div>
<div class="pt-subhead">Season Analytics</div>
<div class="pt-bed-actions">
<button type="button" onclick="renderSeasonAnalyticsPanel()">Refresh Analytics</button>
</div>
<div id="seasonAnalyticsPanel" class="anx-wrap"><div class="pt-bed-summary">Add season archives and observations to see trends, winners, and bed/row hotspots.</div></div>
<div id="bedsList" class="pt-beds-list"></div>
<div class="pt-bed-actions">
<button type="button" onclick="addBedRow()">Add Bed</button>
<button type="button" onclick="resetBeds()">Reset Beds</button>
<button type="button" onclick="clearPlacementPrefs()">Clear Placements</button>
<button type="button" onclick="saveBedAndWeatherState()">Save Beds/Weather</button>
</div>
<div class="pt-bed-summary" id="bedsSummary">No beds configured yet.</div>
<div class="pt-bed-alloc" id="plannerBedAllocSummary">Bed-level allocations will appear here.</div>
<div class="pt-bed-maps" id="plannerBedMaps"></div>
</div>
</div>
<div class="pt-sum" id="plannerSummary">Set household size to generate recommended plants and bed space.</div>
<div class="pt-tbl-wrap"><table class="pt-tbl"><thead><tr><th>Crop</th><th>Spacing</th><th>Plants</th><th>Sq Ft</th><th>Status</th><th>Notes</th></tr></thead><tbody id="plannerTableBody"></tbody></table></div>
</div>
<div class="pt-card">
<h3>Master Gardener (Garden-Aware MVP)</h3>
<div class="mg-box">
<div class="mg-note" id="mgCropContext">Select a crop in ‚ÄúVarieties & Tips‚Äù to ask crop-specific questions.</div>
<div class="mg-config">
<label>Mode<select id="mgMode" onchange="handleAssistantConfigChange()"><option value="local" selected>Local fallback</option><option value="proxy">Proxy (recommended)</option><option value="api">API (OpenAI-compatible)</option></select></label>
<label>Proxy URL<input id="mgProxyEndpoint" type="text" placeholder="/api/master-gardener" oninput="handleAssistantConfigChange()"></label>
<label>Proxy Token (opt)<input id="mgProxyToken" type="password" placeholder="optional shared token" oninput="handleAssistantConfigChange()"></label>
<label>Endpoint<input id="mgEndpoint" type="text" placeholder="https://.../chat/completions" oninput="handleAssistantConfigChange()"></label>
<label>Model<input id="mgModel" type="text" placeholder="gpt-4o-mini" oninput="handleAssistantConfigChange()"></label>
<label>API Key<input id="mgApiKey" type="password" placeholder="sk-..." oninput="handleAssistantConfigChange()"></label>
</div>
<div class="mg-config-actions">
<button type="button" onclick="saveAssistantConfig()">Save AI Settings</button>
<button type="button" onclick="clearAssistantConfig()">Clear</button>
<span class="mg-status" id="mgStatus">Using local fallback responses.</span>
</div>
<div class="mg-quick">
<button type="button" onclick="useQuickPrompt('what_now')">What should I do now?</button>
<button type="button" onclick="useQuickPrompt('spacing')">Spacing</button>
<button type="button" onclick="useQuickPrompt('how_many')">How many for my household?</button>
<button type="button" onclick="useQuickPrompt('pests')">Pests & diseases</button>
<button type="button" onclick="useQuickPrompt('weather')">Weather & clay risk</button>
</div>
<div class="mg-q">
<input id="mgQuestion" type="text" placeholder="Ask about timing, spacing, pests, clay soil, harvest, etc." onkeydown="if(event.key==='Enter'){askMasterGardener()}">
<button type="button" onclick="askMasterGardener()">Ask</button>
</div>
<div class="mg-resp" id="mgResponse">Ask a question to get a context-aware response using your selected crop, season, and household settings.</div>
<div class="mg-ctx" id="mgContextPayload">{}</div>
</div>
</div>
</div>
</div>
<script src="data/crops.js"></script>
<script>
// Calendar
const TM={i:{c:'ci',t:'IN'},t:{c:'ct',t:'TP'},d:{c:'cd',t:'DS'},f:{c:'cf',t:'FS'},h:{c:'cv',t:'H'}};
const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const CAL_NOW=new Date();
const CAL_MONTH=CAL_NOW.getMonth();
const NEXT_MONTH=(CAL_MONTH+1)%12;
const START_TYPES=new Set(['i','t','d','f']);
function hasMonthAction(crop,month,types=START_TYPES){
  return (crop?.mo||[]).some(e=>e.m===month&&types.has(e.t));
}
function cropNamesForMonthType(month,type){
  return V.filter(c=>(c.mo||[]).some(e=>e.m===month&&e.t===type)).map(c=>c.name);
}
function cropNamesForMonthStart(month){
  return V.filter(c=>hasMonthAction(c,month)).map(c=>c.name);
}
function compactList(arr,max=8){
  if(!arr.length)return '';
  if(arr.length<=max)return arr.join(', ');
  return `${arr.slice(0,max).join(', ')} +${arr.length-max} more`;
}
function renderTodaySummary(){
  const el=document.getElementById('todaySummary');
  if(!el)return;
  const dateTxt=CAL_NOW.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  const nowIndoor=compactList(cropNamesForMonthType(CAL_MONTH,'i'));
  const nowDirect=compactList(cropNamesForMonthType(CAL_MONTH,'d'));
  const nowTrans=compactList(cropNamesForMonthType(CAL_MONTH,'t'));
  const nextStarts=compactList(cropNamesForMonthStart(NEXT_MONTH));
  const parts=[`<strong>üìÖ TODAY: ${dateTxt}</strong>`];
  if(nowIndoor)parts.push(`<strong>Start indoors now:</strong> ${nowIndoor}`);
  if(nowDirect)parts.push(`<strong>Direct sow now:</strong> ${nowDirect}`);
  if(nowTrans)parts.push(`<strong>Transplant now:</strong> ${nowTrans}`);
  parts.push(`<strong>Next month (${MONTHS[NEXT_MONTH]}):</strong> ${nextStarts||'No sow/transplant actions listed.'}`);
  el.innerHTML=parts.join(' ‚Äî ');
}
function initCalendarButtons(){
  const cur=document.getElementById('btnCurrentMonth');
  const nxt=document.getElementById('btnNextMonth');
  if(cur)cur.textContent=`${MONTHS[CAL_MONTH]} Start/Plant`;
  if(nxt)nxt.textContent=`${MONTHS[NEXT_MONTH]} Preview`;
}
function highlightCurrentMonthHeader(){
  document.querySelectorAll('thead th').forEach(th=>th.classList.remove('th2'));
  const idx=2+CAL_MONTH;
  const heads=document.querySelectorAll('thead th');
  if(heads[idx])heads[idx].classList.add('th2');
}
const GARDEN_PROFILE={zip:'40165',zone:'6b/7a',soilType:'heavy Kentucky red clay',county:'Bullitt',location:'Shepherdsville, KY'};
const RECIPE_TARGET_DEFAULTS={salsaPints:0,pickleQuarts:0,pestoBatches:0,curryPots:0};
const WEATHER_STATE_DEFAULTS={rainLast3dIn:0,rainNext3dIn:0,humidityRisk:'medium',soilCondition:'workable'};
const DEFAULT_BEDS=[
  {id:'bed-a',name:'Bed A',lengthFt:8,widthFt:4,sun:'full',drainage:'good',layoutMode:'rows',rowSpacingIn:12,trellisSide:'north',trellisBandFt:1},
  {id:'bed-b',name:'Bed B',lengthFt:8,widthFt:4,sun:'full',drainage:'average',layoutMode:'rows',rowSpacingIn:12,trellisSide:'none',trellisBandFt:1},
  {id:'bed-c',name:'Bed C',lengthFt:12,widthFt:3,sun:'part',drainage:'good',layoutMode:'rows',rowSpacingIn:12,trellisSide:'south',trellisBandFt:1}
];
const ASSISTANT_CONFIG_DEFAULTS={mode:'local',proxyEndpoint:'/api/master-gardener',proxyToken:'',endpoint:'',model:'gpt-4o-mini',apiKey:''};
const BACKUP_SCHEMA_VERSION=3;
const APP_STATE={selectedCropIndex:null,peopleCount:2,plannerMode:'balanced',plannerSearch:'',bedSpaceLimit:0,plannerPriorityMode:'balanced',recipeTargets:{...RECIPE_TARGET_DEFAULTS},planningYear:(new Date()).getFullYear(),beds:DEFAULT_BEDS.map(b=>({...b})),bedPlacementPrefs:{},rowHistoryPresets:{},seasonArchives:{},seasonArchiveDraft:{cropOutcomes:[]},observationLogs:[],taskTracker:{},weather:{...WEATHER_STATE_DEFAULTS},assistantConfig:{...ASSISTANT_CONFIG_DEFAULTS}};
const STRUCT_CACHE=new Map();
const SEASON_ANALYTICS_CACHE={key:'',value:null};
const TASK_ENGINE_STATE={windowMode:'week',focus:'auto'};
const LS_KEYS={assistantCfg:'gardenPlanner.masterGardenerConfig',beds:'gardenPlanner.beds',weather:'gardenPlanner.weather',bedPlacementPrefs:'gardenPlanner.bedPlacementPrefs',rowHistoryPresets:'gardenPlanner.rowHistoryPresets',planningYear:'gardenPlanner.planningYear',seasonArchives:'gardenPlanner.seasonArchives',observationLogs:'gardenPlanner.observationLogs',taskTracker:'gardenPlanner.taskTracker'};
const RECIPE_TARGET_TO_PROFILE={salsaPints:'salsa',pickleQuarts:'pickles',pestoBatches:'pesto',curryPots:'curry'};
const RECIPE_TARGET_LABELS={salsaPints:'salsa pints',pickleQuarts:'pickle quarts',pestoBatches:'pesto batches',curryPots:'curry pots'};
const ROTATION_FAMILY_LABELS={
  none:'None / unknown',
  brassica:'Brassica',
  allium:'Allium',
  solanaceae:'Nightshade (tomato/pepper/etc.)',
  cucurbit:'Cucurbit (cucumber/squash)',
  legume:'Legume (peas/beans)',
  root:'Root crops',
  leafy:'Leafy greens',
  corn:'Corn',
  herb:'Herb',
  berry:'Berry',
  perennial:'Perennial'
};
const RECIPE_RULES={
  salsaPints:[
    {match:/^tomatoes$/i,plantsPerUnit:.5,label:'salsa tomatoes'},
    {match:/^peppers$/i,plantsPerUnit:.3,label:'salsa peppers'},
    {match:/^onions$/i,plantsPerUnit:.15,label:'salsa onions'},
    {match:/^garlic$/i,plantsPerUnit:.06,label:'salsa garlic'},
    {match:/^tomatillos$/i,plantsPerUnit:.18,label:'verde salsa tomatillos'},
    {match:/^cilantro \/ coriander$/i,plantsPerUnit:.08,label:'salsa cilantro'}
  ],
  pickleQuarts:[
    {match:/^cucumbers$/i,plantsPerUnit:.9,label:'pickling cucumbers'},
    {match:/^garlic$/i,plantsPerUnit:.04,label:'pickle garlic'},
    {match:/^dill$/i,plantsPerUnit:.2,label:'pickle dill'},
    {match:/^onions$/i,plantsPerUnit:.05,label:'pickle onions'},
    {match:/^peppers$/i,plantsPerUnit:.08,label:'mixed pickle peppers'}
  ],
  pestoBatches:[
    {match:/^basil \(genovese\)$/i,plantsPerUnit:.8,label:'pesto basil'},
    {match:/^garlic$/i,plantsPerUnit:.03,label:'pesto garlic'},
    {match:/^parsley$/i,plantsPerUnit:.06,label:'herb pesto parsley'}
  ],
  curryPots:[
    {match:/^peppers$/i,plantsPerUnit:.18,label:'curry peppers'},
    {match:/^onions$/i,plantsPerUnit:.12,label:'curry onions'},
    {match:/^garlic$/i,plantsPerUnit:.05,label:'curry garlic'},
    {match:/^eggplant$/i,plantsPerUnit:.15,label:'curry eggplant'},
    {match:/^tomatoes$/i,plantsPerUnit:.2,label:'curry tomatoes'},
    {match:/^cilantro \/ coriander$/i,plantsPerUnit:.08,label:'curry cilantro'},
    {match:/^lemongrass$/i,plantsPerUnit:.08,label:'curry lemongrass'}
  ]
};
const VARIETY_RECIPE_TAG_RULES={
  'Peppers':[
    {match:/jalape|serrano|habanero|aji|fatalii|paper lantern|chimayo/i,tags:['salsa','curry','hot'],role:'heat'},
    {match:/carmen|lipstick|jimmy nardello|corno|marconi|bell|marconi/i,tags:['salsa','roast','fresh'],role:'sweet/body'},
    {match:/pepperoncini|banana/i,tags:['pickles','fresh'],role:'pickling'}
  ],
  'Tomatillos':[
    {match:/cisineros/i,tags:['salsa','verde'],role:'verde workhorse'},
    {match:/purple|de milpa/i,tags:['salsa','fresh'],role:'purple salsa / fresh'},
    {match:/amarylla/i,tags:['salsa','fresh'],role:'golden sweet salsa'}
  ],
  'Onions':[
    {match:/superstar|white/i,tags:['salsa','fresh'],role:'white salsa onion'},
    {match:/patterson|wethersfield/i,tags:['curry','storage'],role:'storage cooking onion'},
    {match:/zebrune|shallot/i,tags:['curry','sauce'],role:'shallot / sauce base'},
    {match:/borettana|cipollini/i,tags:['pickles','roast'],role:'cipollini / pickled'}
  ],
  'Garlic':[
    {match:/georgian fire/i,tags:['salsa','hot'],role:'salsa heat garlic'},
    {match:/chesnok|persian star/i,tags:['roast','curry','sauce'],role:'cooked flavor garlic'},
    {match:/inchelium/i,tags:['storage','general'],role:'long storage garlic'}
  ],
  'Basil (Genovese)':[
    {match:/everleaf|genovese/i,tags:['pesto','sauce'],role:'classic pesto'},
    {match:/napoletano/i,tags:['pesto','fresh'],role:'mild pesto / pizza basil'},
    {match:/lemon basil/i,tags:['curry','fresh'],role:'citrus herb accent'}
  ],
  'Dill':[
    {match:/bouquet|mammoth/i,tags:['pickles'],role:'pickle heads'},
    {match:/fernleaf/i,tags:['fresh'],role:'leaf dill'},
    {match:/superdukat/i,tags:['pickles','fresh'],role:'dual-use dill'}
  ],
  'Cilantro / Coriander':[
    {match:/calypso/i,tags:['salsa','curry','fresh'],role:'slow-bolt leaf'},
    {match:/rak bai/i,tags:['curry','fresh'],role:'Thai/Vietnamese leaf'},
    {match:/santo/i,tags:['seed','curry'],role:'coriander seed'}
  ],
  'Cucumbers':[
    {match:/pickle|gherkin|national/i,tags:['pickles'],role:'pickling cucumber'},
    {match:/english|burpless|slicer/i,tags:['fresh'],role:'fresh slicer'}
  ]
};
function slugify(s){return String(s||'').toLowerCase().replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')}
function stripHtml(s){return String(s||'').replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim()}
function escapeHtml(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function cloneObj(v){return v&&typeof v==='object'?JSON.parse(JSON.stringify(v)):v}
function safeLocalStorageGet(key){
  try{return window.localStorage.getItem(key)}catch{return null}
}
function safeLocalStorageSet(key,val){
  try{window.localStorage.setItem(key,val);return true}catch{return false}
}
function safeLocalStorageRemove(key){
  try{window.localStorage.removeItem(key);return true}catch{return false}
}
function confirmUiAction(message){
  try{return window.confirm(message)}catch{return true}
}
function normalizeRecipeTargets(input){
  const src=(input&&typeof input==='object')?input:{};
  return {
    salsaPints:parseNum(src.salsaPints,0,500),
    pickleQuarts:parseNum(src.pickleQuarts,0,500),
    pestoBatches:parseNum(src.pestoBatches,0,500),
    curryPots:parseNum(src.curryPots,0,500)
  };
}
function setBackupStatus(msg){
  const el=document.getElementById('gardenBackupStatus');
  if(el) el.textContent=msg||'Back up your beds, presets, archives, planner settings, and weather before major edits.';
}
function getBackupIncludeAssistantCfg(){
  return Boolean(document.getElementById('backupIncludeAssistantCfg')?.checked);
}
function handleBackupControlsChange(){
  setBackupStatus(getBackupIncludeAssistantCfg()
    ? 'Backup will include AI mode/endpoints/model (secrets excluded).'
    : 'Backup will exclude AI settings. Beds, presets, archives, planner settings, and weather are still included.');
}
function syncPlannerControlsToUi(){
  const map={
    peopleCountInput:APP_STATE.peopleCount,
    plannerMode:APP_STATE.plannerMode,
    bedSpaceLimitInput:APP_STATE.bedSpaceLimit,
    plannerPriorityMode:APP_STATE.plannerPriorityMode,
    plannerSearch:APP_STATE.plannerSearch
  };
  for(const [id,val] of Object.entries(map)){ const el=document.getElementById(id); if(el!=null) el.value=String(val??''); }
  const t=normalizeRecipeTargets(APP_STATE.recipeTargets);
  const recipeMap={rtSalsaPints:t.salsaPints,rtPickleQuarts:t.pickleQuarts,rtPestoBatches:t.pestoBatches,rtCurryPots:t.curryPots};
  for(const [id,val] of Object.entries(recipeMap)){ const el=document.getElementById(id); if(el) el.value=String(val); }
}
function syncPlannerStateFromUiForBackup(){
  const people=document.getElementById('peopleCountInput');
  const mode=document.getElementById('plannerMode');
  const bedSpace=document.getElementById('bedSpaceLimitInput');
  const priority=document.getElementById('plannerPriorityMode');
  const search=document.getElementById('plannerSearch');
  if(people)APP_STATE.peopleCount=Math.max(1,Math.min(20,Number(people.value)||2));
  if(mode)APP_STATE.plannerMode=mode.value||'balanced';
  if(bedSpace)APP_STATE.bedSpaceLimit=Math.max(0,Math.min(5000,Number(bedSpace.value)||0));
  if(priority)APP_STATE.plannerPriorityMode=priority.value||'balanced';
  if(search)APP_STATE.plannerSearch=search.value||'';
  APP_STATE.recipeTargets=normalizeRecipeTargets(getRecipeTargetsFromUi());
}
function sanitizedAssistantConfigForBackup(cfg=APP_STATE.assistantConfig){
  const c={...ASSISTANT_CONFIG_DEFAULTS,...(cfg||{})};
  return {mode:c.mode,proxyEndpoint:c.proxyEndpoint||'',endpoint:c.endpoint||'',model:c.model||ASSISTANT_CONFIG_DEFAULTS.model};
}
function collectBackupStateSnapshot(){
  updateBedsFromUi();
  APP_STATE.weather=getWeatherFromUi();
  syncPlanningYearFromUi();
  syncPlannerStateFromUiForBackup();
  if(typeof syncSeasonArchiveCropOutcomesFromUi==='function') syncSeasonArchiveCropOutcomesFromUi();
  APP_STATE.assistantConfig={...APP_STATE.assistantConfig,...getAssistantConfigFromUi()};
  return {
    planningYear:APP_STATE.planningYear,
    planner:{
      peopleCount:APP_STATE.peopleCount,
      mode:APP_STATE.plannerMode,
      search:APP_STATE.plannerSearch,
      bedSpaceLimit:APP_STATE.bedSpaceLimit,
      priorityMode:APP_STATE.plannerPriorityMode,
      recipeTargets:normalizeRecipeTargets(APP_STATE.recipeTargets)
    },
    beds:cloneObj(APP_STATE.beds),
    bedPlacementPrefs:cloneObj(APP_STATE.bedPlacementPrefs||{}),
    rowHistoryPresets:cloneObj(APP_STATE.rowHistoryPresets||{}),
    seasonArchives:cloneObj(APP_STATE.seasonArchives||{}),
    observationLogs:cloneObj(APP_STATE.observationLogs||[]),
    taskTracker:cloneObj(APP_STATE.taskTracker||{}),
    weather:cloneObj(APP_STATE.weather),
    assistantConfig:getBackupIncludeAssistantCfg()?sanitizedAssistantConfigForBackup(APP_STATE.assistantConfig):null
  };
}
function buildGardenBackupPayload(){
  const data=collectBackupStateSnapshot();
  return {
    app:'gardenplanner',
    schemaVersion:BACKUP_SCHEMA_VERSION,
    exportedAt:new Date().toISOString(),
    gardenProfile:{...GARDEN_PROFILE},
    notes:'AI secrets are excluded from backups by design.',
    data
  };
}
function downloadTextFile(filename,text,mime='application/json'){
  const blob=new Blob([text],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),500);
}
function exportGardenBackup(){
  try{
    const payload=buildGardenBackupPayload();
    const d=new Date();
    const stamp=[d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('-');
    downloadTextFile(`gardenplanner-backup-${stamp}.json`,JSON.stringify(payload,null,2));
    const archiveCount=Object.keys(APP_STATE.seasonArchives||{}).length;
    const obsCount=(APP_STATE.observationLogs||[]).length;
    const taskCt=Object.keys(APP_STATE.taskTracker||{}).length;
    setBackupStatus(`Backup exported (${Object.keys(APP_STATE.rowHistoryPresets||{}).length} row presets, ${archiveCount} season archives, ${obsCount} observations, ${taskCt} task states). AI secrets were excluded.`);
  }catch(err){
    setBackupStatus(`Backup export failed: ${err?.message||err}`);
  }
}
function triggerGardenBackupImport(){
  const el=document.getElementById('gardenBackupImportFile');
  if(!el){ setBackupStatus('Import control not found.'); return; }
  el.value='';
  el.click();
}
function migrateGardenBackupDataV0ToV1(data){
  const d=(data&&typeof data==='object')?cloneObj(data):{};
  if(!d.planner || typeof d.planner!=='object'){
    const planner={};
    if(Object.hasOwn(d,'peopleCount')) planner.peopleCount=d.peopleCount;
    if(Object.hasOwn(d,'plannerMode')) planner.mode=d.plannerMode;
    if(Object.hasOwn(d,'plannerSearch')) planner.search=d.plannerSearch;
    if(Object.hasOwn(d,'bedSpaceLimit')) planner.bedSpaceLimit=d.bedSpaceLimit;
    if(Object.hasOwn(d,'plannerPriorityMode')) planner.priorityMode=d.plannerPriorityMode;
    if(Object.hasOwn(d,'recipeTargets')) planner.recipeTargets=d.recipeTargets;
    if(Object.keys(planner).length) d.planner=planner;
  }
  return d;
}
function migrateGardenBackupDataV1ToV2(data){
  const d=(data&&typeof data==='object')?cloneObj(data):{};
  d.planner=(d.planner&&typeof d.planner==='object')?{...d.planner}:{};
  if(!Object.hasOwn(d.planner,'priorityMode') && Object.hasOwn(d,'plannerPriorityMode')) d.planner.priorityMode=d.plannerPriorityMode;
  if(!Object.hasOwn(d.planner,'recipeTargets') && Object.hasOwn(d,'recipeTargets')) d.planner.recipeTargets=d.recipeTargets;
  if(!Array.isArray(d.observationLogs)) d.observationLogs=[];
  if(!d.bedPlacementPrefs || typeof d.bedPlacementPrefs!=='object') d.bedPlacementPrefs={};
  if(!d.rowHistoryPresets || typeof d.rowHistoryPresets!=='object') d.rowHistoryPresets={};
  if(!d.seasonArchives || typeof d.seasonArchives!=='object') d.seasonArchives={};
  if(d.assistantConfig && typeof d.assistantConfig==='object'){
    d.assistantConfig={...d.assistantConfig};
    delete d.assistantConfig.apiKey;
    delete d.assistantConfig.proxyToken;
  }
  return d;
}
function migrateGardenBackupDataV2ToV3(data){
  const d=(data&&typeof data==='object')?cloneObj(data):{};
  if(!d.taskTracker || typeof d.taskTracker!=='object') d.taskTracker={};
  return d;
}
function migrateGardenBackupPayload(payload){
  const rootIn=(payload&&typeof payload==='object')?cloneObj(payload):{};
  if(rootIn.app && rootIn.app!=='gardenplanner') throw new Error(`Unsupported backup app "${rootIn.app}"`);
  let sourceSchemaVersion=Number(rootIn.schemaVersion);
  sourceSchemaVersion=Number.isFinite(sourceSchemaVersion)?Math.max(0,Math.floor(sourceSchemaVersion)):0;
  if(sourceSchemaVersion>BACKUP_SCHEMA_VERSION){
    throw new Error(`Backup schema v${sourceSchemaVersion} is newer than this app (supports up to v${BACKUP_SCHEMA_VERSION}).`);
  }
  let data;
  if(rootIn.data && typeof rootIn.data==='object') data=cloneObj(rootIn.data);
  else{
    const {app,schemaVersion,exportedAt,gardenProfile,notes,...rest}=rootIn||{};
    data=cloneObj(rest&&typeof rest==='object'&&Object.keys(rest).length?rest:rootIn);
  }
  let curVersion=sourceSchemaVersion;
  const migrationsApplied=[];
  while(curVersion<BACKUP_SCHEMA_VERSION){
    if(curVersion===0){ data=migrateGardenBackupDataV0ToV1(data); migrationsApplied.push('0->1'); curVersion=1; continue; }
    if(curVersion===1){ data=migrateGardenBackupDataV1ToV2(data); migrationsApplied.push('1->2'); curVersion=2; continue; }
    if(curVersion===2){ data=migrateGardenBackupDataV2ToV3(data); migrationsApplied.push('2->3'); curVersion=3; continue; }
    throw new Error(`No migration path from backup schema v${curVersion}.`);
  }
  const migratedRoot={
    app:'gardenplanner',
    schemaVersion:BACKUP_SCHEMA_VERSION,
    exportedAt:rootIn.exportedAt||null,
    gardenProfile:(rootIn.gardenProfile&&typeof rootIn.gardenProfile==='object')?rootIn.gardenProfile:{...GARDEN_PROFILE},
    notes:typeof rootIn.notes==='string'?rootIn.notes:'',
    data
  };
  return {root:migratedRoot,data,sourceSchemaVersion,migrationsApplied};
}
function applyGardenBackupPayload(payload){
  const migrated=migrateGardenBackupPayload(payload);
  const root=migrated.root;
  const data=migrated.data;
  APP_STATE.planningYear=Math.max(2020,Math.min(2100,Number(data.planningYear)||APP_STATE.planningYear||new Date().getFullYear()));
  const planner=(data.planner&&typeof data.planner==='object')?data.planner:{};
  APP_STATE.peopleCount=Math.max(1,Math.min(20,Number(planner.peopleCount)||APP_STATE.peopleCount||2));
  APP_STATE.plannerMode=['fresh','balanced','preserve'].includes(planner.mode)?planner.mode:(APP_STATE.plannerMode||'balanced');
  APP_STATE.plannerSearch=String(planner.search||'').slice(0,80);
  APP_STATE.bedSpaceLimit=Math.max(0,Math.min(5000,Number(planner.bedSpaceLimit)||0));
  APP_STATE.plannerPriorityMode=['balanced','recipe_first','fresh_first'].includes(planner.priorityMode)?planner.priorityMode:'balanced';
  APP_STATE.recipeTargets=normalizeRecipeTargets(planner.recipeTargets||APP_STATE.recipeTargets);
  APP_STATE.beds=normalizeBeds(data.beds);
  APP_STATE.bedPlacementPrefs=normalizeBedPlacementPrefs(data.bedPlacementPrefs,APP_STATE.beds);
  APP_STATE.rowHistoryPresets=normalizeRowHistoryPresets(data.rowHistoryPresets,APP_STATE.beds);
  APP_STATE.seasonArchives=normalizeSeasonArchives(data.seasonArchives,APP_STATE.beds);
  APP_STATE.seasonArchiveDraft={cropOutcomes:[]};
  APP_STATE.observationLogs=normalizeObservationLogs(data.observationLogs);
  APP_STATE.taskTracker=normalizeTaskTracker(data.taskTracker);
  APP_STATE.weather=normalizeWeatherState(data.weather||APP_STATE.weather);
  if(data.assistantConfig && typeof data.assistantConfig==='object'){
    const imported={...ASSISTANT_CONFIG_DEFAULTS,...data.assistantConfig,apiKey:'',proxyToken:''};
    APP_STATE.assistantConfig={...APP_STATE.assistantConfig,...imported};
    safeLocalStorageSet(LS_KEYS.assistantCfg,JSON.stringify(APP_STATE.assistantConfig));
  }
  renderBedsEditor();
  renderRowHistoryPresetControls();
  renderSeasonArchiveControls();
  renderObservationLogPanel();
  clearObservationLogForm();
  syncWeatherUiFromState();
  syncPlannerControlsToUi();
  if(typeof syncAssistantConfigToUi==='function') syncAssistantConfigToUi();
  persistBedAndWeatherState();
  renderRecipeDemandSummary();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
  return {
    sourceSchemaVersion:migrated.sourceSchemaVersion,
    migrationsApplied:migrated.migrationsApplied,
    rowPresetCount:Object.keys(APP_STATE.rowHistoryPresets||{}).length,
    seasonArchiveCount:Object.keys(APP_STATE.seasonArchives||{}).length,
    observationCount:(APP_STATE.observationLogs||[]).length,
    taskTrackerCount:Object.keys(APP_STATE.taskTracker||{}).length,
    bedCount:(APP_STATE.beds||[]).length,
    hasAssistantCfg:Boolean(data.assistantConfig)
  };
}
async function handleGardenBackupFileSelected(evt){
  const file=evt?.target?.files?.[0];
  if(!file){ setBackupStatus('Import canceled.'); return; }
  try{
    const txt=await file.text();
    const payload=JSON.parse(txt);
    const migratedPreview=migrateGardenBackupPayload(payload);
    const root=migratedPreview.root;
    const data=migratedPreview.data;
    const backupName=root.app||'unknown';
    const rowPresetCt=Object.keys((data.rowHistoryPresets&&typeof data.rowHistoryPresets==='object')?data.rowHistoryPresets:{}).length;
    const seasonArchiveCt=Object.keys((data.seasonArchives&&typeof data.seasonArchives==='object')?data.seasonArchives:{}).length;
    const observationCt=Array.isArray(data.observationLogs)?data.observationLogs.length:0;
    const taskTrackerCt=(data.taskTracker&&typeof data.taskTracker==='object')?Object.keys(data.taskTracker).length:0;
    const bedCt=Array.isArray(data.beds)?data.beds.length:0;
    const plannerYear=data.planningYear?` Planning year: ${data.planningYear}.`:'';
    const schemaLine=`\nBackup schema: v${migratedPreview.sourceSchemaVersion||0}${migratedPreview.migrationsApplied.length?` -> v${BACKUP_SCHEMA_VERSION} (${migratedPreview.migrationsApplied.join(', ')})`:''}`;
    const ok=confirmUiAction(`Import backup "${file.name}" (${backupName})? This will overwrite current local data.\n\nBeds: ${bedCt}\nRow-history presets: ${rowPresetCt}\nSeason archives: ${seasonArchiveCt}\nObservations: ${observationCt}\nTask states: ${taskTrackerCt}.${plannerYear}${schemaLine}`);
    if(!ok){ setBackupStatus(`Import canceled for ${file.name}.`); return; }
    const res=applyGardenBackupPayload(payload);
    const migMsg=res.migrationsApplied?.length?` Migrated backup schema v${res.sourceSchemaVersion||0} to v${BACKUP_SCHEMA_VERSION}.`:'';
    setBackupStatus(`Imported backup from ${file.name}: ${res.bedCount} beds, ${res.rowPresetCount} row presets, ${res.seasonArchiveCount} season archives, ${res.observationCount} observations, ${res.taskTrackerCount} task states${res.hasAssistantCfg?' + AI settings (no secrets)':''}.${migMsg}`);
  }catch(err){
    setBackupStatus(`Backup import failed: ${err?.message||err}`);
  }
}
function parseNum(v,min=0,max=9999){
  const n=Number(v);
  if(!Number.isFinite(n))return min;
  return Math.max(min,Math.min(max,Math.floor(n)));
}
function mergeDeep(base,extra){
  const out=cloneObj(base)||{};
  if(!extra||typeof extra!=='object')return out;
  for(const [k,v] of Object.entries(extra)){
    if(v&&typeof v==='object'&&!Array.isArray(v)&&out[k]&&typeof out[k]==='object'&&!Array.isArray(out[k])) out[k]=mergeDeep(out[k],v);
    else out[k]=cloneObj(v);
  }
  return out;
}
function uid(prefix='id'){return `${prefix}-${Math.random().toString(36).slice(2,8)}`}
function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function round1(n){return Number.isFinite(n)?+Number(n).toFixed(1):0}
function parseFloatSafe(v,min=0,max=9999,def=min){
  const n=Number(v);
  if(!Number.isFinite(n))return def;
  return Math.max(min,Math.min(max,n));
}
function computeRowCountForShape(widthFt,rowSpacingIn){
  const w=Math.max(0.5,Number(widthFt)||1), rs=Math.max(6,Number(rowSpacingIn)||12);
  return Math.max(1,Math.floor((w*12)/rs));
}
function normalizeBedRowHistory(history,rowCount){
  const arr=Array.isArray(history)?history:[];
  const out=[];
  for(let i=0;i<rowCount;i++){
    const raw=arr[i];
    const fam=typeof raw==='string'?raw:raw?.family;
    out.push(Object.hasOwn(ROTATION_FAMILY_LABELS,String(fam||''))?String(fam):'none');
  }
  return out;
}
function normalizeWeatherState(input){
  const w=input&&typeof input==='object'?input:{};
  const humidity=['low','medium','high'].includes(w.humidityRisk)?w.humidityRisk:'medium';
  const soil=['workable','damp','wet'].includes(w.soilCondition)?w.soilCondition:'workable';
  return {
    rainLast3dIn:round1(parseFloatSafe(w.rainLast3dIn,0,20,0)),
    rainNext3dIn:round1(parseFloatSafe(w.rainNext3dIn,0,20,0)),
    humidityRisk:humidity,
    soilCondition:soil
  };
}
function normalizeBeds(beds){
  const arr=Array.isArray(beds)?beds:[];
  const out=arr.map((b,i)=>({
    id:String(b?.id||uid('bed')),
    name:String(b?.name||`Bed ${String.fromCharCode(65+i)}`).slice(0,24),
    lengthFt:round1(parseFloatSafe(b?.lengthFt,0,100,8)),
    widthFt:round1(parseFloatSafe(b?.widthFt,0,30,4)),
    sun:['full','part','shade'].includes(b?.sun)?b.sun:'full',
    drainage:['good','average','poor','raised'].includes(b?.drainage)?b.drainage:'average',
    layoutMode:['rows','block'].includes(b?.layoutMode)?b.layoutMode:'rows',
    rowSpacingIn:round1(parseFloatSafe(b?.rowSpacingIn,6,36,12)),
    trellisSide:['none','north','south','east','west'].includes(b?.trellisSide)?b.trellisSide:'none',
    trellisBandFt:round1(parseFloatSafe(b?.trellisBandFt,0.5,4,1))
  })).filter(b=>b.lengthFt>0&&b.widthFt>0).map(b=>{
    const rowCount=computeRowCountForShape(b.widthFt,b.rowSpacingIn);
    return {...b,rowHistory:normalizeBedRowHistory(b.rowHistory,rowCount)};
  });
  return out.length?out:DEFAULT_BEDS.map(b=>({...b}));
}
function normalizeBedPlacementPrefs(prefs,beds=getActiveBeds()){
  const src=(prefs&&typeof prefs==='object')?prefs:{};
  const bedIds=new Set((beds||[]).map(b=>b.id));
  const out={};
  for(const [cropName,val] of Object.entries(src)){
    if(!val || typeof val!=='object') continue;
    const bedId=String(val.bedId||'');
    if(!bedIds.has(bedId)) continue;
    const rowNum=Number(val.rowIndex);
    const rowIndex=Number.isInteger(rowNum)?Math.max(0,rowNum):null;
    out[String(cropName)]={bedId,locked:Boolean(val.locked),rowIndex};
  }
  return out;
}
function getPlacementPref(cropName){return APP_STATE.bedPlacementPrefs?.[cropName]||null}
function setPlacementPref(cropName,patch){
  if(!cropName)return;
  const current=getPlacementPref(cropName)||{};
  APP_STATE.bedPlacementPrefs={...APP_STATE.bedPlacementPrefs,[cropName]:{...current,...patch}};
  APP_STATE.bedPlacementPrefs=normalizeBedPlacementPrefs(APP_STATE.bedPlacementPrefs,getActiveBeds());
}
function removePlacementPref(cropName){
  const next={...(APP_STATE.bedPlacementPrefs||{})};
  delete next[cropName];
  APP_STATE.bedPlacementPrefs=next;
}
function bedSqFt(b){return round1((Number(b?.lengthFt)||0)*(Number(b?.widthFt)||0))}
function getActiveBeds(){return normalizeBeds(APP_STATE.beds)}
function totalBedSqFt(beds=getActiveBeds()){return round1(beds.reduce((s,b)=>s+bedSqFt(b),0))}
function getBedById(bedId){return (APP_STATE.beds||[]).find(b=>b.id===bedId)||null}
function setBedRowHistoryFamily(bedId,rowIndex,family){
  const fam=Object.hasOwn(ROTATION_FAMILY_LABELS,String(family||''))?String(family):'none';
  APP_STATE.beds=normalizeBeds((APP_STATE.beds||[]).map(b=>{
    if(b.id!==bedId) return b;
    const settings=getBedRowSettings(b);
    const rowHistory=normalizeBedRowHistory(b.rowHistory,settings.rowCount);
    rowHistory[Math.max(0,Math.min(settings.rowCount-1,Number(rowIndex)||0))]=fam;
    return {...b,rowHistory};
  }));
}
function handleRowHistoryChange(sel){
  const bedId=sel?.dataset?.bedId;
  const rowIndex=parseInt(sel?.dataset?.rowIndex||'',10);
  if(!bedId || !Number.isInteger(rowIndex)) return;
  setBedRowHistoryFamily(bedId,rowIndex,sel.value);
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function normalizeRowHistoryPresets(presets,beds=getActiveBeds()){
  const src=(presets&&typeof presets==='object')?presets:{};
  const bedIds=new Set((beds||[]).map(b=>b.id));
  const out={};
  for(const [rawName,val] of Object.entries(src)){
    const name=String(rawName||'').trim().slice(0,40);
    if(!name || !val || typeof val!=='object') continue;
    const snapshot=Array.isArray(val.snapshot)?val.snapshot:[];
    const rows=snapshot.map(item=>{
      const bedId=String(item?.bedId||'');
      const bedName=String(item?.bedName||'').slice(0,24);
      const rowHistory=Array.isArray(item?.rowHistory)?item.rowHistory.map(f=>Object.hasOwn(ROTATION_FAMILY_LABELS,String(f||''))?String(f):'none'):[];
      if(!bedId && !bedName) return null;
      return {bedId,bedName,rowHistory};
    }).filter(Boolean);
    out[name]={
      name,
      year:Number.isFinite(Number(val.year))?Math.max(2020,Math.min(2100,Math.trunc(Number(val.year)))):null,
      updatedAt:val.updatedAt?String(val.updatedAt):new Date().toISOString(),
      snapshot:rows.filter(r=>r.bedId?bedIds.size?true:true:true)
    };
  }
  return out;
}
function normalizeSeasonArchives(archives,beds=getActiveBeds()){
  const src=(archives&&typeof archives==='object')?archives:{};
  const out={};
  for(const [rawName,val] of Object.entries(src)){
    const name=String(rawName||'').trim().slice(0,48);
    if(!name || !val || typeof val!=='object') continue;
    const cropOutcomes=normalizeSeasonArchiveCropOutcomes(val.cropOutcomes);
    out[name]={
      name,
      year:Number.isFinite(Number(val.year))?Math.max(2020,Math.min(2100,Math.trunc(Number(val.year)))):null,
      updatedAt:val.updatedAt?String(val.updatedAt):new Date().toISOString(),
      pestPressure:['low','medium','high'].includes(val.pestPressure)?val.pestPressure:'medium',
      diseasePressure:['low','medium','high'].includes(val.diseasePressure)?val.diseasePressure:'medium',
      yieldSummary:String(val.yieldSummary||'').slice(0,220),
      notes:String(val.notes||'').slice(0,1200),
      linkedRowHistoryPreset:String(val.linkedRowHistoryPreset||'').slice(0,40),
      rowHistorySnapshot:normalizeRowHistoryPresets({tmp:{name:'tmp',year:val.year,updatedAt:val.updatedAt,snapshot:val.rowHistorySnapshot}},beds).tmp?.snapshot||[],
      cropOutcomes
    };
  }
  return out;
}
function normalizeSeasonArchiveCropOutcomes(rows){
  const arr=Array.isArray(rows)?rows:[];
  const validCropNames=new Set(V.map(v=>v.name));
  return arr.map(r=>({
    cropName:validCropNames.has(String(r?.cropName||''))?String(r.cropName):'',
    variety:String(r?.variety||'').slice(0,120),
    outcome:['poor','fair','good','great'].includes(r?.outcome)?r.outcome:'good',
    yieldAmount:String(r?.yieldAmount||'').slice(0,120),
    pestIssue:String(r?.pestIssue||'').slice(0,120),
    diseaseIssue:String(r?.diseaseIssue||'').slice(0,120),
    notes:String(r?.notes||'').slice(0,220)
  })).filter(r=>r.cropName || r.variety || r.yieldAmount || r.pestIssue || r.diseaseIssue || r.notes);
}
function normalizeTaskTracker(map){
  const src=(map&&typeof map==='object')?map:{};
  const out={};
  for(const [rawKey,val] of Object.entries(src)){
    const key=String(rawKey||'').slice(0,180).trim();
    if(!key || !val || typeof val!=='object') continue;
    const snooze=/^\d{4}-\d{2}-\d{2}$/.test(String(val.snoozeUntil||''))?String(val.snoozeUntil):'';
    const done=Boolean(val.done);
    const note=String(val.note||'').trim().slice(0,500);
    const updatedAt=String(val.updatedAt||val.doneAt||'').trim().slice(0,40);
    const doneAt=String(val.doneAt||'').trim().slice(0,40);
    if(!done && !snooze && !note) continue;
    out[key]={done,snoozeUntil:snooze,note,updatedAt:updatedAt||new Date().toISOString(),doneAt:done?doneAt||new Date().toISOString():''};
  }
  return out;
}
function todayIsoLocal(){
  const d=new Date();
  const off=d.getTimezoneOffset()*60000;
  return new Date(d.getTime()-off).toISOString().slice(0,10);
}
function addDaysIsoLocal(days=0){
  const d=new Date();
  d.setDate(d.getDate()+Number(days||0));
  const off=d.getTimezoneOffset()*60000;
  return new Date(d.getTime()-off).toISOString().slice(0,10);
}
function normalizeObservationLogs(logs){
  const arr=Array.isArray(logs)?logs:[];
  const validCropNames=new Set(V.map(v=>v.name));
  const beds=getActiveBeds();
  const bedIds=new Set(beds.map(b=>b.id));
  const bedNameById=new Map(beds.map(b=>[b.id,b.name]));
  const rows=arr.map(r=>({
    id:String(r?.id||uid('obs')).slice(0,48),
    date:/^\d{4}-\d{2}-\d{2}$/.test(String(r?.date||''))?String(r.date):todayIsoLocal(),
    cropName:validCropNames.has(String(r?.cropName||''))?String(r.cropName):'',
    bedId:bedIds.has(String(r?.bedId||''))?String(r.bedId):'',
    bedName:String(r?.bedName||'').trim().slice(0,40),
    rowIndex:Number.isInteger(Number(r?.rowIndex))?Math.max(0,Math.trunc(Number(r.rowIndex))):null,
    symptom:String(r?.symptom||'').trim().slice(0,140),
    notes:String(r?.notes||'').trim().slice(0,1200),
    photoRef:String(r?.photoRef||'').trim().slice(0,220),
    createdAt:String(r?.createdAt||r?.date||todayIsoLocal()),
    updatedAt:String(r?.updatedAt||r?.createdAt||r?.date||todayIsoLocal())
  })).map(r=>{
    const liveBedName=r.bedId?bedNameById.get(r.bedId)||'':'';
    return {...r,bedName:(liveBedName||r.bedName||'').slice(0,40)};
  }).filter(r=>r.cropName || r.symptom || r.notes || r.photoRef || r.bedId || r.bedName);
  const seen=new Set();
  return rows
    .filter(r=>{ if(seen.has(r.id)) return false; seen.add(r.id); return true; })
    .sort((a,b)=>String(b.date).localeCompare(String(a.date)) || String(b.updatedAt).localeCompare(String(a.updatedAt)) || a.id.localeCompare(b.id));
}
function setObservationLogStatus(msg){
  const el=document.getElementById('observationLogStatus');
  if(el) el.textContent=msg||'Log field observations (including photo references) to build in-season memory for troubleshooting and next-year planning.';
}
function getRecentObservationLogs(limit=20,cropName=''){
  const rows=normalizeObservationLogs(APP_STATE.observationLogs||[]);
  const filterName=String(cropName||'');
  return (filterName?rows.filter(r=>r.cropName===filterName):rows).slice(0,Math.max(0,limit|0));
}
function populateObservationBedSelect(selected=''){
  const sel=document.getElementById('obsBed');
  if(!sel) return;
  const beds=getActiveBeds();
  const current=selected || sel.value || '';
  sel.innerHTML=`<option value="">(optional)</option>`+beds.map(b=>`<option value="${escapeHtml(b.id)}"${b.id===current?' selected':''}>${escapeHtml(b.name)}</option>`).join('');
  if(current && !beds.some(b=>b.id===current)) sel.value='';
}
function populateObservationRowSelect(bedId='',selected=''){
  const sel=document.getElementById('obsRow');
  if(!sel) return;
  const bed=bedId?getBedById(bedId):null;
  if(!bed){
    sel.innerHTML='<option value="">(optional)</option>';
    sel.value='';
    return;
  }
  const rowCount=getBedRowSettings(bed).rowCount;
  const current=String(selected??sel.value??'');
  sel.innerHTML=`<option value="">(optional)</option>`+Array.from({length:rowCount},(_,i)=>`<option value="${i}"${String(i)===current?' selected':''}>R${i+1}</option>`).join('');
  if(current && !Array.from({length:rowCount},(_,i)=>String(i)).includes(current)) sel.value='';
}
function handleObservationBedChange(){
  const bedId=String(document.getElementById('obsBed')?.value||'');
  populateObservationRowSelect(bedId,'');
}
function formatObservationBedRowLabel(row){
  const bedName=String(row?.bedName||'').trim();
  const rowIdx=Number.isInteger(Number(row?.rowIndex))?Math.trunc(Number(row.rowIndex)):null;
  if(!bedName && rowIdx==null) return '';
  if(!bedName) return `R${rowIdx+1}`;
  if(rowIdx==null) return bedName;
  return `${bedName} / R${rowIdx+1}`;
}
function populateObservationCropSelect(selected=''){
  const sel=document.getElementById('obsCrop');
  if(!sel) return;
  const current=selected || sel.value || '';
  sel.innerHTML=`<option value="">(select crop)</option>`+V.map(v=>`<option value="${escapeHtml(v.name)}"${v.name===current?' selected':''}>${escapeHtml(v.name)} (${escapeHtml(v.cat)})</option>`).join('');
  if(current && !V.some(v=>v.name===current)) sel.value='';
}
function observationFormDataFromUi(){
  const bedId=String(document.getElementById('obsBed')?.value||'');
  const bed=bedId?getBedById(bedId):null;
  const rowRaw=document.getElementById('obsRow')?.value;
  const rowIndex=(rowRaw!=='' && Number.isInteger(Number(rowRaw)))?Math.max(0,Math.trunc(Number(rowRaw))):null;
  return {
    date:String(document.getElementById('obsDate')?.value||todayIsoLocal()),
    cropName:String(document.getElementById('obsCrop')?.value||''),
    bedId:bed?.id||'',
    bedName:bed?.name||'',
    rowIndex,
    symptom:String(document.getElementById('obsSymptom')?.value||'').trim(),
    photoRef:String(document.getElementById('obsPhotoRef')?.value||'').trim(),
    notes:String(document.getElementById('obsNotes')?.value||'').trim()
  };
}
function clearObservationLogForm(keepCrop=false){
  const cropVal=keepCrop?String(document.getElementById('obsCrop')?.value||''):'';
  const dateEl=document.getElementById('obsDate');
  if(dateEl) dateEl.value=todayIsoLocal();
  populateObservationCropSelect(cropVal);
  populateObservationBedSelect('');
  populateObservationRowSelect('','');
  if(!keepCrop && document.getElementById('obsCrop')) document.getElementById('obsCrop').value='';
  const ids=['obsSymptom','obsPhotoRef','obsNotes'];
  ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
}
function prefillObservationFromSelectedCrop(){
  const crop=getSelectedCrop();
  populateObservationCropSelect(crop?.name||'');
  const dateEl=document.getElementById('obsDate');
  if(dateEl && !dateEl.value) dateEl.value=todayIsoLocal();
  const pref=crop?getPlacementPref(crop.name):null;
  populateObservationBedSelect(pref?.bedId||'');
  populateObservationRowSelect(pref?.bedId||'', Number.isInteger(pref?.rowIndex)?String(pref.rowIndex):'');
  setObservationLogStatus(crop?`Observation form prefilled with selected crop: ${crop.name}${pref?.bedId?` (${formatObservationBedRowLabel({bedName:getBedById(pref.bedId)?.name||'',rowIndex:pref.rowIndex})})`:''}.`:'No crop selected in ‚ÄúVarieties & Tips‚Äù; choose a crop from the dropdown.');
}
function saveObservationLogEntry(){
  populateObservationCropSelect();
  const row=observationFormDataFromUi();
  if(!row.cropName){ setObservationLogStatus('Choose a crop before saving an observation.'); return; }
  if(!row.symptom && !row.notes && !row.photoRef){ setObservationLogStatus('Add at least a symptom, notes, or photo reference before saving.'); return; }
  APP_STATE.observationLogs=normalizeObservationLogs([{...row,id:uid('obs'),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},...(APP_STATE.observationLogs||[])]);
  persistBedAndWeatherState();
  renderObservationLogPanel();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
  clearObservationLogForm(true);
  const bedTag=formatObservationBedRowLabel(row);
  setObservationLogStatus(`Saved observation for ${row.cropName}${bedTag?` @ ${bedTag}`:''}${row.symptom?` (${row.symptom})`:''}.`);
}
function deleteObservationLogEntry(id){
  const row=(APP_STATE.observationLogs||[]).find(r=>r.id===id);
  if(!row) return;
  if(!confirmUiAction(`Delete observation for ${row.cropName||'crop'} on ${row.date}?`)) return;
  APP_STATE.observationLogs=normalizeObservationLogs((APP_STATE.observationLogs||[]).filter(r=>r.id!==id));
  persistBedAndWeatherState();
  renderObservationLogPanel();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
  setObservationLogStatus(`Deleted observation from ${row.date}.`);
}
function useObservationForSymptomLookup(id){
  const row=(APP_STATE.observationLogs||[]).find(r=>r.id===id);
  if(!row) return;
  if(row.cropName){
    const idx=V.findIndex(v=>v.name===row.cropName);
    if(idx>=0){
      const el=document.querySelector(`.vi[data-i="${idx}"]`);
      showDet(idx,el||null);
    }
  }
  setTimeout(()=>{
    if(row.symptom && typeof runSymptomLookup==='function'){
      const input=document.getElementById('symptomLookupInput');
      if(input) input.value=row.symptom;
      runSymptomLookup(row.symptom);
    }
  },0);
}
function renderObservationLogPanel(){
  const listEl=document.getElementById('observationLogList');
  const dateEl=document.getElementById('obsDate');
  if(dateEl && !dateEl.value) dateEl.value=todayIsoLocal();
  populateObservationCropSelect(document.getElementById('obsCrop')?.value||'');
  const bedSelVal=String(document.getElementById('obsBed')?.value||'');
  populateObservationBedSelect(bedSelVal);
  populateObservationRowSelect(String(document.getElementById('obsBed')?.value||''), String(document.getElementById('obsRow')?.value||''));
  if(!listEl) return;
  const rows=getRecentObservationLogs(8);
  const selectedCrop=getSelectedCrop()?.name||'';
  if(!rows.length){
    listEl.innerHTML='<div class="pt-bed-summary">No observations logged yet. Add a field note with symptom/notes/photo ref.</div>';
    renderSeasonAnalyticsPanel();
    return;
  }
  listEl.innerHTML=rows.map(r=>{
    const sym=r.symptom?`<div>Symptom: ${escapeHtml(r.symptom)}</div>`:'';
    const notes=r.notes?`<div>Notes: ${escapeHtml(r.notes)}</div>`:'';
    const photo=r.photoRef?`<div>Photo: <code>${escapeHtml(r.photoRef)}</code></div>`:'';
    const loc=formatObservationBedRowLabel(r);
    const locHtml=loc?`<div>Location: <strong>${escapeHtml(loc)}</strong></div>`:'';
    const selectedTag=(selectedCrop && r.cropName===selectedCrop)?' ¬∑ selected crop':'';
    return `<div class="obx-item"><div class="obx-head"><div><b>${escapeHtml(r.cropName||'Unknown crop')}</b><div class="obx-meta">${escapeHtml(r.date)}${selectedTag}</div></div><div class="obx-actions"><button type="button" onclick="useObservationForSymptomLookup('${escapeHtml(r.id)}')">Lookup</button><button type="button" class="danger" onclick="deleteObservationLogEntry('${escapeHtml(r.id)}')">Delete</button></div></div><div class="obx-body">${locHtml}${sym}${notes}${photo}</div></div>`;
  }).join('');
  renderSeasonAnalyticsPanel();
}
function currentRowHistorySnapshot(){
  return getActiveBeds().map(b=>({
    bedId:b.id,
    bedName:b.name,
    rowHistory:normalizeBedRowHistory(b.rowHistory,getBedRowSettings(b).rowCount)
  }));
}
function rowHistoryPresetSelectValue(){
  return String(document.getElementById('rowHistoryPresetSelect')?.value||'').trim();
}
function rowHistoryPresetNameValue(){
  const raw=String(document.getElementById('rowHistoryPresetName')?.value||'').trim();
  if(raw) return raw.slice(0,40);
  return `${Math.max(2020,Math.min(2100,Number(APP_STATE.planningYear)||new Date().getFullYear()))-1} bed state`;
}
function setRowHistoryPresetStatus(msg){
  const el=document.getElementById('rowHistoryPresetStatus');
  if(el) el.textContent=msg||'Save a season/year snapshot of row history, then load it next season.';
}
function setSeasonArchiveStatus(msg){
  const el=document.getElementById('seasonArchiveStatus');
  if(el) el.textContent=msg||'Archive end-of-season outcomes so rotation decisions are backed by real results.';
}
function seasonArchiveSelectValue(){
  return String(document.getElementById('seasonArchiveSelect')?.value||'').trim();
}
function seasonArchiveNameValue(){
  const raw=String(document.getElementById('seasonArchiveName')?.value||'').trim();
  if(raw) return raw.slice(0,48);
  return `${Math.max(2020,Math.min(2100,Number(APP_STATE.planningYear)||new Date().getFullYear()))-1} season review`;
}
function syncPlanningYearFromUi(){
  const inp=document.getElementById('rowHistoryPlanYear');
  APP_STATE.planningYear=Math.max(2020,Math.min(2100,Number(inp?.value)||new Date().getFullYear()));
  if(inp) inp.value=String(APP_STATE.planningYear);
}
function renderRowHistoryPresetControls(statusMsg=''){
  const select=document.getElementById('rowHistoryPresetSelect');
  const nameInput=document.getElementById('rowHistoryPresetName');
  const yearInput=document.getElementById('rowHistoryPlanYear');
  if(yearInput) yearInput.value=String(APP_STATE.planningYear);
  if(!select) return;
  const names=Object.keys(APP_STATE.rowHistoryPresets||{}).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'}));
  const current=rowHistoryPresetSelectValue();
  select.innerHTML=`<option value="">(none)</option>`+names.map(name=>{
    const p=APP_STATE.rowHistoryPresets[name];
    const yr=p?.year?` (${p.year})`:'';
    return `<option value="${escapeHtml(name)}"${name===current?' selected':''}>${escapeHtml(name)}${yr}</option>`;
  }).join('');
  if(current && !APP_STATE.rowHistoryPresets[current]) select.value='';
  if(nameInput && !nameInput.value.trim()){
    const defaultName=`${APP_STATE.planningYear-1} bed state`;
    nameInput.value=defaultName;
  }
  if(statusMsg) setRowHistoryPresetStatus(statusMsg);
}
function handleRowHistoryPresetUiChange(){
  syncPlanningYearFromUi();
  safeLocalStorageSet(LS_KEYS.planningYear,String(APP_STATE.planningYear));
}
function handleRowHistoryPresetSelectionChange(){
  const name=rowHistoryPresetSelectValue();
  const p=APP_STATE.rowHistoryPresets?.[name];
  const nameInput=document.getElementById('rowHistoryPresetName');
  if(name && nameInput) nameInput.value=name;
  if(name && p){
    const when=p.updatedAt?new Date(p.updatedAt).toLocaleString():null;
    setRowHistoryPresetStatus(`Selected "${name}"${p.year?` for ${p.year}`:''}${when?` ¬∑ saved ${when}`:''}.`);
  }else{
    setRowHistoryPresetStatus();
  }
}
function saveRowHistoryPreset(){
  updateBedsFromUi();
  syncPlanningYearFromUi();
  const name=rowHistoryPresetNameValue();
  if(!name){ setRowHistoryPresetStatus('Enter a preset name first.'); return; }
  APP_STATE.rowHistoryPresets=normalizeRowHistoryPresets({
    ...(APP_STATE.rowHistoryPresets||{}),
    [name]:{name,year:APP_STATE.planningYear-1,updatedAt:new Date().toISOString(),snapshot:currentRowHistorySnapshot()}
  },APP_STATE.beds);
  persistBedAndWeatherState();
  renderRowHistoryPresetControls(`Saved row history preset "${name}" (${APP_STATE.planningYear-1}).`);
}
function applyRowHistoryPreset(name){
  const p=APP_STATE.rowHistoryPresets?.[name];
  if(!p){ setRowHistoryPresetStatus(`Preset "${name}" not found.`); return false; }
  const byId=new Map((p.snapshot||[]).map(x=>[x.bedId,x]));
  const byName=new Map((p.snapshot||[]).map(x=>[String(x.bedName||'').toLowerCase(),x]));
  APP_STATE.beds=normalizeBeds((APP_STATE.beds||[]).map(b=>{
    const snap=byId.get(b.id)||byName.get(String(b.name||'').toLowerCase());
    if(!snap) return b;
    const rowCount=getBedRowSettings(b).rowCount;
    return {...b,rowHistory:normalizeBedRowHistory(snap.rowHistory,rowCount)};
  }));
  renderBedsEditor();
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
  const appliedCount=(APP_STATE.beds||[]).filter(b=>{
    const snap=byId.get(b.id)||byName.get(String(b.name||'').toLowerCase());
    return Boolean(snap);
  }).length;
  renderRowHistoryPresetControls(`Loaded "${name}" into ${appliedCount} bed${appliedCount===1?'':'s'} as previous-row history.`);
  return true;
}
function loadSelectedRowHistoryPreset(){
  updateBedsFromUi();
  const name=rowHistoryPresetSelectValue() || rowHistoryPresetNameValue();
  if(!name){ setRowHistoryPresetStatus('Select a saved preset to load.'); return; }
  if(!confirmUiAction(`Load row-history preset "${name}"? This will overwrite the current row-history dropdown values for matching beds.`)) return;
  applyRowHistoryPreset(name);
}
function findPreviousYearPresetName(prevYear){
  const names=Object.keys(APP_STATE.rowHistoryPresets||{});
  const exact=[String(prevYear),`${prevYear} bed state`,`${prevYear} Bed State`,`${prevYear} row history`];
  for(const nm of exact){ if(APP_STATE.rowHistoryPresets?.[nm]) return nm; }
  return names.find(n=>new RegExp(`\\b${prevYear}\\b`).test(n))||'';
}
function loadPreviousYearRowHistoryPreset(){
  updateBedsFromUi();
  syncPlanningYearFromUi();
  const prevYear=Math.max(2020,APP_STATE.planningYear-1);
  const name=findPreviousYearPresetName(prevYear);
  if(!name){
    setRowHistoryPresetStatus(`No preset found for ${prevYear}. Save one first (e.g., "${prevYear} bed state").`);
    return;
  }
  const sel=document.getElementById('rowHistoryPresetSelect');
  if(sel) sel.value=name;
  if(!confirmUiAction(`Load previous-year preset "${name}"? This will overwrite the current row-history dropdown values for matching beds.`)) return;
  applyRowHistoryPreset(name);
}
function deleteSelectedRowHistoryPreset(){
  const name=rowHistoryPresetSelectValue();
  if(!name){ setRowHistoryPresetStatus('Select a preset to delete.'); return; }
  if(!confirmUiAction(`Delete row-history preset "${name}"? This cannot be undone unless you restore from a backup.`)) return;
  const next={...(APP_STATE.rowHistoryPresets||{})};
  delete next[name];
  APP_STATE.rowHistoryPresets=normalizeRowHistoryPresets(next,APP_STATE.beds);
  persistBedAndWeatherState();
  renderRowHistoryPresetControls(`Deleted preset "${name}".`);
}
function seasonArchiveFormDataFromUi(){
  return {
    pestPressure:String(document.getElementById('seasonArchivePestPressure')?.value||'medium'),
    diseasePressure:String(document.getElementById('seasonArchiveDiseasePressure')?.value||'medium'),
    yieldSummary:String(document.getElementById('seasonArchiveYieldSummary')?.value||'').trim(),
    notes:String(document.getElementById('seasonArchiveNotes')?.value||'').trim()
  };
}
function syncSeasonArchiveForm(entry=null){
  const e=entry||null;
  const values={
    seasonArchivePestPressure:e?.pestPressure||'medium',
    seasonArchiveDiseasePressure:e?.diseasePressure||'medium',
    seasonArchiveYieldSummary:e?.yieldSummary||'',
    seasonArchiveNotes:e?.notes||''
  };
  for(const [id,val] of Object.entries(values)){ const el=document.getElementById(id); if(el) el.value=String(val); }
  APP_STATE.seasonArchiveDraft={cropOutcomes:normalizeSeasonArchiveCropOutcomes(e?.cropOutcomes||[])};
  renderSeasonArchiveCropOutcomesEditor();
}
function getSeasonArchiveDraftCropOutcomes(){
  return normalizeSeasonArchiveCropOutcomes(APP_STATE.seasonArchiveDraft?.cropOutcomes||[]);
}
function hasSeasonArchiveDraftContent(){
  const form=seasonArchiveFormDataFromUi();
  const outcomes=getSeasonArchiveDraftCropOutcomes();
  return Boolean(form.yieldSummary||form.notes||outcomes.length);
}
function seasonArchiveTargetYear(){
  return Math.max(2020,Math.min(2100,(Number(APP_STATE.planningYear)||new Date().getFullYear())-1));
}
function observationIssueSignalsForText(text){
  const t=String(text||'').toLowerCase();
  const pest=/\b(aphid|beetle|bug|worm|hornworm|earworm|borer|slug|caterpillar|maggot|mite|stink bug|insect|flea beetle|squash bug)\b/;
  const disease=/\b(blight|mildew|wilt|rot|spot|rust|mosaic|lesion|canker|mold|fung|bacterial|downy)\b/;
  return {pest:pest.test(t),disease:disease.test(t)};
}
function getObservationLogsForSeasonYear(year){
  const y=String(year||'');
  return getRecentObservationLogs(1000).filter(r=>String(r.date||'').startsWith(`${y}-`));
}
function summarizeObservationsForSeasonArchive(year=seasonArchiveTargetYear()){
  const rows=getObservationLogsForSeasonYear(year);
  const byCrop=new Map();
  let pestHits=0,diseaseHits=0,photoCount=0;
  for(const r of rows){
    const txt=[r.symptom,r.notes].filter(Boolean).join(' ');
    const sig=observationIssueSignalsForText(txt);
    if(sig.pest) pestHits++;
    if(sig.disease) diseaseHits++;
    if(r.photoRef) photoCount++;
    if(!r.cropName) continue;
    const cur=byCrop.get(r.cropName)||{cropName:r.cropName,count:0,pest:0,disease:0,symptoms:[],locations:[],latestDate:''};
    cur.count++;
    if(sig.pest) cur.pest++;
    if(sig.disease) cur.disease++;
    if(r.symptom) cur.symptoms.push(r.symptom);
    const loc=formatObservationBedRowLabel(r);
    if(loc) cur.locations.push(loc);
    if(!cur.latestDate || String(r.date)>String(cur.latestDate)) cur.latestDate=r.date;
    byCrop.set(r.cropName,cur);
  }
  const total=rows.length;
  const severityScore=(pestHits+diseaseHits)+(total>=6?1:0)+(total>=12?1:0);
  const pressure=(hits)=>{
    if(hits>=6 || total>=12 && hits>=4) return 'high';
    if(hits>=2 || total>=5) return 'medium';
    return 'low';
  };
  const cropSummaries=[...byCrop.values()].sort((a,b)=>b.count-a.count || a.cropName.localeCompare(b.cropName)).map(c=>{
    const symptomCounts={};
    c.symptoms.forEach(s=>{ const k=String(s).trim(); if(k) symptomCounts[k]=(symptomCounts[k]||0)+1; });
    const topSym=Object.entries(symptomCounts).sort((a,b)=>b[1]-a[1])[0]?.[0]||'';
    const locCounts={};
    c.locations.forEach(l=>{ locCounts[l]=(locCounts[l]||0)+1; });
    const topLoc=Object.entries(locCounts).sort((a,b)=>b[1]-a[1])[0]?.[0]||'';
    return {...c,topSymptom:topSym,topLocation:topLoc};
  });
  return {
    year,total,photoCount,pestHits,diseaseHits,
    pestPressure:pressure(pestHits),
    diseasePressure:pressure(diseaseHits),
    cropSummaries,
    summaryLine:`${total} observations (${photoCount} with photo refs), pests flagged ${pestHits}, disease flags ${diseaseHits}.`
  };
}
function suggestSeasonArchivePressureFromObservations(){
  const s=summarizeObservationsForSeasonArchive();
  if(!s.total){
    setSeasonArchiveStatus(`No observation logs found for ${s.year}. Add observations first or change planning year.`);
    return;
  }
  const pestEl=document.getElementById('seasonArchivePestPressure');
  const disEl=document.getElementById('seasonArchiveDiseasePressure');
  const yldEl=document.getElementById('seasonArchiveYieldSummary');
  const notesEl=document.getElementById('seasonArchiveNotes');
  if(pestEl) pestEl.value=s.pestPressure;
  if(disEl) disEl.value=s.diseasePressure;
  if(yldEl && !String(yldEl.value||'').trim()){
    yldEl.value=`${s.year} observation summary: ${s.summaryLine}`;
  }
  if(notesEl){
    const cropLine=s.cropSummaries.slice(0,5).map(c=>`${c.cropName} (${c.count} logs${c.topLocation?`, ${c.topLocation}`:''}${c.topSymptom?`, ${c.topSymptom}`:''})`).join('; ');
    const append=`Observation summary (${s.year}): ${s.summaryLine}${cropLine?` Top crops: ${cropLine}.`:''}`;
    if(!String(notesEl.value||'').includes(`Observation summary (${s.year})`)){
      notesEl.value=[String(notesEl.value||'').trim(),append].filter(Boolean).join('\n');
    }
  }
  handleSeasonArchiveUiChange();
  setSeasonArchiveStatus(`Suggested pest/disease pressure from ${s.total} observation logs for ${s.year} (pests ${s.pestPressure}, disease ${s.diseasePressure}).`);
}
function mergeObservationLogsIntoSeasonArchiveCropOutcomes(){
  const s=summarizeObservationsForSeasonArchive();
  if(!s.total){
    setSeasonArchiveStatus(`No observation logs found for ${s.year}. Nothing to promote into crop outcomes.`);
    return;
  }
  syncSeasonArchiveCropOutcomesFromUi();
  const current=getSeasonArchiveDraftCropOutcomes();
  const byCrop=new Map(current.map(r=>[r.cropName,r]));
  let added=0,updated=0;
  for(const c of s.cropSummaries){
    const base=byCrop.get(c.cropName) || cropOutcomeRowTemplate({cropName:c.cropName});
    const next={...base};
    if(!next.pestIssue && c.pest>0) next.pestIssue=c.topSymptom||`Observation logs flagged pest-like issues (${c.pest})`;
    if(!next.diseaseIssue && c.disease>0) next.diseaseIssue=c.topSymptom||`Observation logs flagged disease-like issues (${c.disease})`;
    if(!next.notes){
      next.notes=`${c.count} observation log${c.count===1?'':'s'} in ${s.year}${c.topLocation?` ¬∑ frequent location ${c.topLocation}`:''}${c.topSymptom?` ¬∑ top symptom ${c.topSymptom}`:''}`;
    }else if(!/observation log/i.test(next.notes)){
      next.notes=`${next.notes} | ${c.count} observation log${c.count===1?'':'s'} in ${s.year}${c.topLocation?` @ ${c.topLocation}`:''}`;
    }
    if(!byCrop.has(c.cropName)){
      const issueCount=c.pest+c.disease;
      next.outcome=issueCount>=4?'fair':'good';
      current.push(cropOutcomeRowTemplate(next));
      byCrop.set(c.cropName,next);
      added++;
    }else{
      const idx=current.findIndex(r=>r.cropName===c.cropName);
      if(idx>=0){
        current[idx]=cropOutcomeRowTemplate({...current[idx],...next});
        updated++;
      }
    }
  }
  APP_STATE.seasonArchiveDraft={cropOutcomes:normalizeSeasonArchiveCropOutcomes(current)};
  renderSeasonArchiveCropOutcomesEditor();
  handleSeasonArchiveUiChange();
  setSeasonArchiveStatus(`Promoted observation logs (${s.year}) into crop outcomes: ${added} added, ${updated} updated.`);
}
function syncSeasonArchiveCropOutcomesFromUi(){
  const rows=[...document.querySelectorAll('#seasonArchiveCropOutcomesEditor .sa-co-row')];
  APP_STATE.seasonArchiveDraft={cropOutcomes:normalizeSeasonArchiveCropOutcomes(rows.map(r=>({
    cropName:r.querySelector('[data-k=\"cropName\"]')?.value||'',
    variety:r.querySelector('[data-k=\"variety\"]')?.value||'',
    outcome:r.querySelector('[data-k=\"outcome\"]')?.value||'good',
    yieldAmount:r.querySelector('[data-k=\"yieldAmount\"]')?.value||'',
    pestIssue:r.querySelector('[data-k=\"pestIssue\"]')?.value||'',
    diseaseIssue:r.querySelector('[data-k=\"diseaseIssue\"]')?.value||'',
    notes:r.querySelector('[data-k=\"notes\"]')?.value||''
  })))};
}
function cropOutcomeRowTemplate(row={}){
  return {cropName:String(row.cropName||''),variety:String(row.variety||''),outcome:['poor','fair','good','great'].includes(row.outcome)?row.outcome:'good',yieldAmount:String(row.yieldAmount||''),pestIssue:String(row.pestIssue||''),diseaseIssue:String(row.diseaseIssue||''),notes:String(row.notes||'')};
}
function renderSeasonArchiveCropOutcomesEditor(){
  const host=document.getElementById('seasonArchiveCropOutcomesEditor');
  if(!host)return;
  const rows=getSeasonArchiveDraftCropOutcomes();
  const options=`<option value=\"\">(select crop)</option>`+V.map(v=>`<option value=\"${escapeHtml(v.name)}\">${escapeHtml(v.name)} (${escapeHtml(v.cat)})</option>`).join('');
  if(!rows.length){
    host.innerHTML='<div class=\"pt-bed-summary\">No crop outcomes added yet. Use ‚ÄúSeed From Planner‚Äù or add rows manually.</div>';
    return;
  }
  host.innerHTML=rows.map((row,i)=>`<div class=\"sa-co-row\" data-row-index=\"${i}\"><div class=\"pt-bed-row-extra\">\
  <label>Crop<select data-k=\"cropName\" onchange=\"handleSeasonArchiveCropOutcomeChange()\">${options.replace(`value=\\\"${escapeHtml(row.cropName)}\\\"`,`value=\\\"${escapeHtml(row.cropName)}\\\" selected`)}</select></label>\
  <label>Variety<input data-k=\"variety\" maxlength=\"120\" value=\"${escapeHtml(row.variety)}\" oninput=\"handleSeasonArchiveCropOutcomeChange()\" placeholder=\"Variety or winner\"></label>\
  <label>Outcome<select data-k=\"outcome\" onchange=\"handleSeasonArchiveCropOutcomeChange()\"><option value=\"poor\"${row.outcome==='poor'?' selected':''}>Poor</option><option value=\"fair\"${row.outcome==='fair'?' selected':''}>Fair</option><option value=\"good\"${row.outcome==='good'?' selected':''}>Good</option><option value=\"great\"${row.outcome==='great'?' selected':''}>Great</option></select></label>\
  <label>Yield<input data-k=\"yieldAmount\" maxlength=\"120\" value=\"${escapeHtml(row.yieldAmount)}\" oninput=\"handleSeasonArchiveCropOutcomeChange()\" placeholder=\"e.g. 24 lb, 40 quarts\"></label>\
  <button type=\"button\" onclick=\"removeSeasonArchiveCropOutcomeRow(${i})\">Remove</button>\
  </div><div class=\"pt-bed-row-extra\">\
  <label>Pest Issue<input data-k=\"pestIssue\" maxlength=\"120\" value=\"${escapeHtml(row.pestIssue)}\" oninput=\"handleSeasonArchiveCropOutcomeChange()\" placeholder=\"SVB, aphids, beetles...\"></label>\
  <label>Disease Issue<input data-k=\"diseaseIssue\" maxlength=\"120\" value=\"${escapeHtml(row.diseaseIssue)}\" oninput=\"handleSeasonArchiveCropOutcomeChange()\" placeholder=\"blight, mildew, rot...\"></label>\
  <label style=\"grid-column:1/-1\">Notes<input data-k=\"notes\" maxlength=\"220\" value=\"${escapeHtml(row.notes)}\" oninput=\"handleSeasonArchiveCropOutcomeChange()\" placeholder=\"Spacing issue, variety winner, timing lesson...\"></label>\
  </div></div>`).join('');
}
function handleSeasonArchiveCropOutcomeChange(){
  syncSeasonArchiveCropOutcomesFromUi();
  handleSeasonArchiveUiChange();
}
function addSeasonArchiveCropOutcomeRow(seed={}){
  syncSeasonArchiveCropOutcomesFromUi();
  const cur=getSeasonArchiveDraftCropOutcomes();
  cur.push(cropOutcomeRowTemplate(seed));
  APP_STATE.seasonArchiveDraft={cropOutcomes:cur};
  renderSeasonArchiveCropOutcomesEditor();
}
function removeSeasonArchiveCropOutcomeRow(index){
  syncSeasonArchiveCropOutcomesFromUi();
  const cur=getSeasonArchiveDraftCropOutcomes();
  cur.splice(Math.max(0,Number(index)||0),1);
  APP_STATE.seasonArchiveDraft={cropOutcomes:cur};
  renderSeasonArchiveCropOutcomesEditor();
  handleSeasonArchiveUiChange();
}
function seedSeasonArchiveCropOutcomesFromPlanner(){
  const existing=getSeasonArchiveDraftCropOutcomes();
  if(existing.length && !confirmUiAction(`Replace the current crop outcome draft rows (${existing.length}) with a new seeded list from the planner?`)) return;
  const rows=getPlannerRows({ignoreSearch:true}).slice(0,24);
  const seeded=rows.map(r=>({cropName:r.crop.name,outcome:'good',variety:'',yieldAmount:'',pestIssue:'',diseaseIssue:'',notes:''}));
  APP_STATE.seasonArchiveDraft={cropOutcomes:normalizeSeasonArchiveCropOutcomes(seeded)};
  renderSeasonArchiveCropOutcomesEditor();
  setSeasonArchiveStatus(`Seeded ${seeded.length} crop outcome rows from current planner crops.`);
}
function getSeasonArchiveSummaries(limit=4){
  return Object.values(APP_STATE.seasonArchives||{})
    .sort((a,b)=>(Number(b.year)||0)-(Number(a.year)||0) || String(b.updatedAt||'').localeCompare(String(a.updatedAt||'')))
    .slice(0,Math.max(0,limit|0))
    .map(a=>({
      name:a.name,
      year:a.year,
      pestPressure:a.pestPressure,
      diseasePressure:a.diseasePressure,
      yieldSummary:a.yieldSummary,
      notesPreview:(a.notes||'').slice(0,180),
      cropOutcomeCount:(a.cropOutcomes||[]).length,
      linkedRowHistoryPreset:a.linkedRowHistoryPreset||'',
      bedSnapshots:(a.rowHistorySnapshot||[]).length,
      updatedAt:a.updatedAt
    }));
}
function getSeasonArchivesSorted(){
  return Object.values(APP_STATE.seasonArchives||{}).sort((a,b)=>(Number(b.year)||0)-(Number(a.year)||0) || String(b.updatedAt||'').localeCompare(String(a.updatedAt||'')));
}
function getLatestSeasonArchive(){
  return getSeasonArchivesSorted()[0]||null;
}
function getLatestCropOutcome(cropName){
  const name=String(cropName||'');
  if(!name) return null;
  for(const archive of getSeasonArchivesSorted()){
    const hit=(archive.cropOutcomes||[]).find(o=>String(o.cropName||'')===name);
    if(hit) return {...hit,archiveName:archive.name,archiveYear:archive.year,pestPressure:archive.pestPressure,diseasePressure:archive.diseasePressure};
  }
  return null;
}
function getObservationSummaries(limit=8,cropName=''){
  return getRecentObservationLogs(limit,cropName).map(r=>({
    id:r.id,
    date:r.date,
    cropName:r.cropName,
    bedLabel:formatObservationBedRowLabel(r),
    symptom:r.symptom,
    notesPreview:(r.notes||'').slice(0,180),
    photoRef:r.photoRef
  }));
}
function seasonAnalyticsCacheKey(){
  const archives=getSeasonArchivesSorted();
  const archiveSig=archives.slice(0,20).map(a=>`${a.name}|${a.updatedAt||''}|${(a.cropOutcomes||[]).length}`).join('~');
  const obs=(APP_STATE.observationLogs||[]);
  const obsSig=obs.slice(0,30).map(o=>`${o.id||''}|${o.updatedAt||''}|${o.date||''}`).join('~');
  const bedSig=(APP_STATE.beds||[]).map(b=>`${b.id}|${b.name}`).join('~');
  return `a:${archives.length}:${archiveSig}::o:${obs.length}:${obsSig}::b:${bedSig}`;
}
function getSeasonAnalyticsSnapshot(){
  const key=seasonAnalyticsCacheKey();
  if(SEASON_ANALYTICS_CACHE.key===key && SEASON_ANALYTICS_CACHE.value) return SEASON_ANALYTICS_CACHE.value;
  const value=computeSeasonAnalytics();
  SEASON_ANALYTICS_CACHE.key=key;
  SEASON_ANALYTICS_CACHE.value=value;
  return value;
}
function cropDiseaseRiskKeywordHit(sc){
  const txt=(sc?.ipm?.commonDiseases||[]).join(' ').toLowerCase();
  return /\b(mildew|blight|rot|wilt|spot|rust|phytophthora|septoria)\b/.test(txt);
}
function rowLabelForBedLane(bed,laneIndex){
  return `${String(bed?.name||'Bed')} / R${Math.max(0,Number(laneIndex)||0)+1}`;
}
function getRowPlacementAnalyticsForCrop(bed,laneIndex,crop,sc=getStructuredCrop(crop),analytics=getSeasonAnalyticsSnapshot()){
  const out={scoreAdj:0,reasons:[],severity:0,label:rowLabelForBedLane(bed,laneIndex),generic:null,cropHit:null};
  if(!bed||!crop||!analytics) return out;
  const label=out.label;
  const generic=analytics.hotspotByLabel?.[label]||null;
  const cropHit=(analytics.cropHotspotsByName?.[crop.name]||[]).find(h=>h.label===label)||null;
  out.generic=generic; out.cropHit=cropHit;
  let pen=0;
  if(generic){
    if(cropDiseaseRiskKeywordHit(sc) && generic.diseaseHits>=2) pen+=Math.min(5,1+generic.diseaseHits);
    else if(generic.obsCount>=3) pen+=Math.min(2,Math.floor(generic.obsCount/2));
    if(generic.pestHits>=4) pen+=1;
    if(pen) out.reasons.push(`${label} hotspot (${generic.obsCount} obs; pest ${generic.pestHits}, disease ${generic.diseaseHits})`);
  }
  if(cropHit){
    const cropPen=Math.min(6,Math.max(2,Math.round(cropHit.score||0)));
    pen+=cropPen;
    out.reasons.push(`Past ${crop.name} issues logged in ${label} (${cropHit.obsCount} obs)`);
  }
  out.scoreAdj=-pen;
  out.severity=pen;
  return out;
}
function getPlannerAnalyticsForCrop(crop,sc=getStructuredCrop(crop),analytics=getSeasonAnalyticsSnapshot()){
  const cropName=String(crop?.name||'');
  if(!cropName || !analytics) return null;
  return {
    cropTrend:analytics.cropStatsByName?.[cropName]||null,
    varietyWinners:(analytics.varietyByCrop?.[cropName]?.winners||[]).slice(0,2),
    varietyWatch:(analytics.varietyByCrop?.[cropName]?.watchlist||[]).slice(0,2),
    hotspotHits:(analytics.cropHotspotsByName?.[cropName]||[]).slice(0,4),
    diseaseSensitive:cropDiseaseRiskKeywordHit(sc)
  };
}
function bedAnalyticsRiskForCrop(bed,crop,sc=getStructuredCrop(crop),analytics=getSeasonAnalyticsSnapshot()){
  const out={scoreAdj:0,reasons:[],severity:0};
  if(!bed||!crop||!analytics) return out;
  const bedName=String(bed.name||'');
  const bedAgg=analytics.bedHotspotsByBed?.[bedName]||null;
  const cropHits=(analytics.cropHotspotsByName?.[crop.name]||[]).filter(h=>h.bedName===bedName);
  const diseaseSensitive=cropDiseaseRiskKeywordHit(sc);
  if(bedAgg){
    let pen=0;
    if(diseaseSensitive && bedAgg.diseaseHits>=2) pen+=Math.min(5,1+bedAgg.diseaseHits);
    else if(bedAgg.obsCount>=4) pen+=Math.min(3,Math.floor(bedAgg.obsCount/2));
    if(bedAgg.pestHits>=4) pen+=1;
    if(pen){
      out.scoreAdj-=pen;
      out.severity=Math.max(out.severity,pen);
      out.reasons.push(`${bedName} hotspot (${bedAgg.obsCount} logs; pest ${bedAgg.pestHits}, disease ${bedAgg.diseaseHits})`);
    }
  }
  if(cropHits.length){
    const hit=cropHits[0];
    const pen=Math.min(6,Math.max(2,Math.round(hit.score)));
    out.scoreAdj-=pen;
    out.severity=Math.max(out.severity,pen);
    out.reasons.push(`Past ${crop.name} issues in ${hit.label} (${hit.obsCount} obs)`);
  }
  return out;
}
function computeSeasonAnalytics(){
  const archives=getSeasonArchivesSorted();
  const observations=normalizeObservationLogs(APP_STATE.observationLogs||[]);
  const scoreMap={poor:1,fair:2,good:3,great:4};
  const cropStats=new Map(), varietyStats=new Map(), yearStats=new Map(), hotspotStats=new Map(), bedHotspots=new Map(), cropHotspotStats=new Map();
  const ensureCrop=(name)=>{
    if(!cropStats.has(name)) cropStats.set(name,{cropName:name,outcomeCount:0,scoreSum:0,great:0,good:0,fair:0,poor:0,pestHits:0,diseaseHits:0,obsCount:0});
    return cropStats.get(name);
  };
  const ensureYear=(year)=>{
    const key=String(year||'unknown');
    if(!yearStats.has(key)) yearStats.set(key,{year:key,archiveCount:0,outcomeCount:0,scoreSum:0,scoreCt:0,pestHigh:0,diseaseHigh:0});
    return yearStats.get(key);
  };
  for(const a of archives){
    const ys=ensureYear(a.year||'unknown');
    ys.archiveCount++;
    if(a.pestPressure==='high') ys.pestHigh++;
    if(a.diseasePressure==='high') ys.diseaseHigh++;
    for(const row of (a.cropOutcomes||[])){
      if(!row.cropName) continue;
      const cs=ensureCrop(row.cropName);
      const sc=scoreMap[row.outcome]||0;
      cs.outcomeCount++; cs.scoreSum+=sc;
      if(row.outcome==='great') cs.great++; else if(row.outcome==='good') cs.good++; else if(row.outcome==='fair') cs.fair++; else if(row.outcome==='poor') cs.poor++;
      if(row.pestIssue) cs.pestHits++;
      if(row.diseaseIssue) cs.diseaseHits++;
      ys.outcomeCount++; ys.scoreSum+=sc; ys.scoreCt++;
      const variety=String(row.variety||'').trim();
      if(variety){
        const key=`${row.cropName}::${variety}`;
        const vs=varietyStats.get(key)||{cropName:row.cropName,variety,count:0,scoreSum:0,great:0,poor:0,years:new Set()};
        vs.count++; vs.scoreSum+=sc; if(row.outcome==='great') vs.great++; if(row.outcome==='poor') vs.poor++;
        if(a.year) vs.years.add(String(a.year));
        varietyStats.set(key,vs);
      }
    }
  }
  for(const o of observations){
    const txt=[o.symptom,o.notes].filter(Boolean).join(' ');
    const sig=observationIssueSignalsForText(txt);
    if(o.cropName){
      const cs=ensureCrop(o.cropName);
      cs.obsCount++;
      if(sig.pest) cs.pestHits++;
      if(sig.disease) cs.diseaseHits++;
    }
    const loc=formatObservationBedRowLabel(o) || o.bedName || '';
    if(loc){
      const hs=hotspotStats.get(loc)||{label:loc,obsCount:0,pestHits:0,diseaseHits:0,crops:new Set()};
      hs.obsCount++;
      if(sig.pest) hs.pestHits++;
      if(sig.disease) hs.diseaseHits++;
      if(o.cropName) hs.crops.add(o.cropName);
      hotspotStats.set(loc,hs);
      const bedName=String(loc).split(' / ')[0];
      if(bedName){
        const bh=bedHotspots.get(bedName)||{bedName,obsCount:0,pestHits:0,diseaseHits:0,rows:new Set(),crops:new Set()};
        bh.obsCount++;
        if(sig.pest) bh.pestHits++;
        if(sig.disease) bh.diseaseHits++;
        if(/ \/ R\d+$/i.test(loc)) bh.rows.add(loc);
        if(o.cropName) bh.crops.add(o.cropName);
        bedHotspots.set(bedName,bh);
      }
      if(o.cropName){
        const ck=o.cropName;
        const map=cropHotspotStats.get(ck)||new Map();
        const ch=map.get(loc)||{label:loc,bedName:String(loc).split(' / ')[0]||'',obsCount:0,pestHits:0,diseaseHits:0};
        ch.obsCount++;
        if(sig.pest) ch.pestHits++;
        if(sig.disease) ch.diseaseHits++;
        map.set(loc,ch);
        cropHotspotStats.set(ck,map);
      }
    }
  }
  const crops=[...cropStats.values()].map(c=>({
    ...c,
    avgOutcome:c.outcomeCount?c.scoreSum/c.outcomeCount:0,
    issueLoad:c.pestHits+c.diseaseHits
  }));
  const varieties=[...varietyStats.values()].map(v=>({
    ...v,
    avgOutcome:v.count?v.scoreSum/v.count:0,
    yearCount:v.years.size
  }));
  const years=[...yearStats.values()].map(y=>({...y,avgOutcome:y.scoreCt?y.scoreSum/y.scoreCt:0}))
    .sort((a,b)=>(Number(b.year)||0)-(Number(a.year)||0));
  const hotspots=[...hotspotStats.values()].map(h=>({
    ...h,
    cropCount:h.crops.size,
    score:(h.diseaseHits*2)+(h.pestHits*1.25)+(h.obsCount*.25)
  })).sort((a,b)=>b.score-a.score || b.obsCount-a.obsCount || a.label.localeCompare(b.label));
  const hotspotByLabel=Object.fromEntries(hotspots.map(h=>[h.label,h]));
  const bedHotspotRows=[...bedHotspots.values()].map(h=>({
    bedName:h.bedName,
    obsCount:h.obsCount,
    pestHits:h.pestHits,
    diseaseHits:h.diseaseHits,
    rowCount:h.rows.size,
    cropCount:h.crops.size,
    score:(h.diseaseHits*2)+(h.pestHits*1.2)+(h.obsCount*.2)
  })).sort((a,b)=>b.score-a.score || b.obsCount-a.obsCount || a.bedName.localeCompare(b.bedName));
  const cropHotspotsByName=Object.fromEntries([...cropHotspotStats.entries()].map(([cropName,locMap])=>[
    cropName,
    [...locMap.values()].map(h=>({
      ...h,
      score:(h.diseaseHits*2)+(h.pestHits*1.25)+(h.obsCount*.2)
    })).sort((a,b)=>b.score-a.score || b.obsCount-a.obsCount || a.label.localeCompare(b.label))
  ]));
  const topVarietyWinners=varieties.filter(v=>v.count>=1).sort((a,b)=>b.avgOutcome-a.avgOutcome || b.count-a.count || a.cropName.localeCompare(b.cropName)).slice(0,5);
  const topVarietyLosers=varieties.filter(v=>v.count>=1).sort((a,b)=>a.avgOutcome-b.avgOutcome || b.count-a.count || a.cropName.localeCompare(b.cropName)).slice(0,5);
  const recurringCropIssues=crops.filter(c=>c.issueLoad>0 || c.outcomeCount>0).sort((a,b)=>b.issueLoad-a.issueLoad || a.avgOutcome-b.avgOutcome || a.cropName.localeCompare(b.cropName)).slice(0,6);
  const cropStatsByName=Object.fromEntries(crops.map(c=>[c.cropName,c]));
  const bedHotspotsByBed=Object.fromEntries(bedHotspotRows.map(b=>[b.bedName,b]));
  const varietiesByCrop=new Map();
  varieties.forEach(v=>{
    const arr=varietiesByCrop.get(v.cropName)||[];
    arr.push(v);
    varietiesByCrop.set(v.cropName,arr);
  });
  const varietyByCrop=Object.fromEntries([...varietiesByCrop.entries()].map(([cropName,arr])=>[
    cropName,
    {
      winners:[...arr].sort((a,b)=>b.avgOutcome-a.avgOutcome || b.count-a.count || a.variety.localeCompare(b.variety)).slice(0,4),
      watchlist:[...arr].sort((a,b)=>a.avgOutcome-b.avgOutcome || b.count-a.count || a.variety.localeCompare(b.variety)).slice(0,4)
    }
  ]));
  return {
    archiveCount:archives.length,
    observationCount:observations.length,
    yearsTracked:new Set(archives.map(a=>String(a.year||'unknown'))).size,
    cropsWithOutcomes:crops.filter(c=>c.outcomeCount>0).length,
    cropsWithObservations:crops.filter(c=>c.obsCount>0).length,
    topVarietyWinners,
    topVarietyLosers,
    recurringCropIssues,
    hotspots:hotspots.slice(0,6),
    hotspotByLabel,
    bedHotspots:bedHotspotRows.slice(0,6),
    cropStatsByName,
    bedHotspotsByBed,
    cropHotspotsByName,
    varietyByCrop,
    years,
    crops
  };
}
function buildSeasonAnalyticsRecommendations(a){
  const recs=[];
  if(!a.archiveCount) return [{text:'Save at least one Season Archive with crop outcomes to unlock variety winners/losers and year-over-year trends.',tone:'warn'}];
  if(!a.observationCount) recs.push({text:'Start logging observations with bed/row tags so hotspot and issue trend analysis becomes specific.',tone:'warn'});
  const hotspot=a.hotspots[0];
  if(hotspot && hotspot.score>=3){
    recs.push({text:`${hotspot.label} is your current hotspot (${hotspot.obsCount} logs; pest ${hotspot.pestHits}, disease ${hotspot.diseaseHits}). Avoid stacking disease-prone crops there next season without rotation/drainage adjustments.`});
  }
  const cropIssue=a.recurringCropIssues.find(c=>c.issueLoad>=3);
  if(cropIssue){
    recs.push({text:`${cropIssue.cropName} shows recurring pressure (${cropIssue.issueLoad} issue flags). Prioritize resistant varieties, wider spacing/airflow, and early scouting for this crop.`});
  }
  const loser=a.topVarietyLosers.find(v=>v.count>=2 && v.avgOutcome<=2.2);
  if(loser){
    recs.push({text:`Re-evaluate ${loser.variety} (${loser.cropName}) ‚Äî average outcome ${round1(loser.avgOutcome)}/4 across ${loser.count} logged seasons.`,tone:'warn'});
  }
  const winner=a.topVarietyWinners.find(v=>v.count>=2 && v.avgOutcome>=3.2);
  if(winner){
    recs.push({text:`Lean into ${winner.variety} (${winner.cropName}) ‚Äî average outcome ${round1(winner.avgOutcome)}/4 across ${winner.count} logged seasons.`,tone:'good'});
  }
  return recs.slice(0,4);
}
function renderSeasonAnalyticsPanel(){
  const host=document.getElementById('seasonAnalyticsPanel');
  if(!host) return;
  const a=getSeasonAnalyticsSnapshot();
  if(!a.archiveCount && !a.observationCount){
    host.innerHTML='<div class="pt-bed-summary">Add season archives and observations to see trends, winners, and bed/row hotspots.</div>';
    return;
  }
  const recs=buildSeasonAnalyticsRecommendations(a);
  const yearsHtml=a.years.length?`<div class="anx-list">${a.years.slice(0,4).map(y=>`<div class="anx-item"><strong>${escapeHtml(String(y.year))}</strong><span class="meta">${y.archiveCount} archive${y.archiveCount===1?'':'s'} ¬∑ ${y.outcomeCount} crop outcomes ¬∑ avg outcome ${y.scoreCt?`${round1(y.avgOutcome)}/4`:'n/a'} ¬∑ high pressure: pests ${y.pestHigh}, disease ${y.diseaseHigh}</span></div>`).join('')}</div>`:'<div class="anx-empty">No season archives yet.</div>';
  const winnersHtml=a.topVarietyWinners.length?`<div class="anx-list">${a.topVarietyWinners.map(v=>`<div class="anx-item"><strong>${escapeHtml(v.variety)}</strong> <span class="anx-chip">${escapeHtml(v.cropName)}</span><span class="meta">Avg ${round1(v.avgOutcome)}/4 ¬∑ ${v.count} outcome log${v.count===1?'':'s'}${v.yearCount?` ¬∑ ${v.yearCount} year${v.yearCount===1?'':'s'}`:''}</span></div>`).join('')}</div>`:'<div class="anx-empty">Add variety names in crop outcomes to rank winners.</div>';
  const losersHtml=a.topVarietyLosers.length?`<div class="anx-list">${a.topVarietyLosers.map(v=>`<div class="anx-item"><strong>${escapeHtml(v.variety)}</strong> <span class="anx-chip">${escapeHtml(v.cropName)}</span><span class="meta">Avg ${round1(v.avgOutcome)}/4 ¬∑ ${v.count} outcome log${v.count===1?'':'s'}</span></div>`).join('')}</div>`:'<div class="anx-empty">No variety outcome data yet.</div>';
  const issuesHtml=a.recurringCropIssues.length?`<div class="anx-list">${a.recurringCropIssues.map(c=>`<div class="anx-item"><strong>${escapeHtml(c.cropName)}</strong><span class="meta">Issue flags ${c.issueLoad} (pest ${c.pestHits}, disease ${c.diseaseHits}) ¬∑ observations ${c.obsCount} ¬∑ outcomes ${c.outcomeCount}${c.outcomeCount?` ¬∑ avg ${round1(c.avgOutcome)}/4`:''}</span></div>`).join('')}</div>`:'<div class="anx-empty">No crop issue trends yet.</div>';
  const hotspotsHtml=a.hotspots.length?`<div class="anx-list">${a.hotspots.map(h=>`<div class="anx-item"><strong>${escapeHtml(h.label)}</strong><span class="meta">${h.obsCount} observations ¬∑ pest ${h.pestHits} ¬∑ disease ${h.diseaseHits} ¬∑ ${h.cropCount} crop${h.cropCount===1?'':'s'}</span></div>`).join('')}</div>`:'<div class="anx-empty">Tag observations with bed/row to build hotspot tracking.</div>';
  host.innerHTML=`<div class="anx-kpis">
    <div class="anx-kpi"><b>Seasons</b><span>${a.yearsTracked}</span></div>
    <div class="anx-kpi"><b>Archives</b><span>${a.archiveCount}</span></div>
    <div class="anx-kpi"><b>Observations</b><span>${a.observationCount}</span></div>
    <div class="anx-kpi"><b>Crops Tracked</b><span>${Math.max(a.cropsWithOutcomes,a.cropsWithObservations)}</span></div>
  </div>
  <div class="anx-grid">
    <div class="anx-card"><h5>Year Trends</h5>${yearsHtml}</div>
    <div class="anx-card"><h5>Recurring Crop Pressure</h5>${issuesHtml}</div>
    <div class="anx-card"><h5>Variety Winners</h5>${winnersHtml}</div>
    <div class="anx-card"><h5>Variety Watchlist</h5>${losersHtml}</div>
    <div class="anx-card"><h5>Bed/Row Hotspots</h5>${hotspotsHtml}</div>
    <div class="anx-card"><h5>Planning Suggestions</h5><div class="anx-recs">${recs.map(r=>`<div class="anx-rec${r.tone==='warn'?' warn':''}">${escapeHtml(r.text)}</div>`).join('')}</div></div>
  </div>`;
}
function renderSeasonArchiveSummary(){
  const el=document.getElementById('seasonArchiveSummary');
  if(!el) return;
  const entries=Object.values(APP_STATE.seasonArchives||{}).sort((a,b)=>(Number(b.year)||0)-(Number(a.year)||0) || String(b.updatedAt||'').localeCompare(String(a.updatedAt||'')));
  if(!entries.length){
    el.innerHTML='No season archives saved yet.';
    renderSeasonAnalyticsPanel();
    return;
  }
  el.innerHTML=entries.slice(0,4).map(a=>{
    const y=a.year?`<strong>${a.year}</strong>`:'<strong>Season</strong>';
    const rowCt=(a.rowHistorySnapshot||[]).length;
    const cropCt=(a.cropOutcomes||[]).length;
    const yld=a.yieldSummary?escapeHtml(a.yieldSummary):'No yield summary yet';
    return `<div class="pt-ba-item">${y} ¬∑ ${escapeHtml(a.name)} ¬∑ Pests ${escapeHtml(a.pestPressure)} ¬∑ Disease ${escapeHtml(a.diseasePressure)} ¬∑ ${rowCt} bed snapshots ¬∑ ${cropCt} crop outcomes<br><span style="color:#6b7b6b">${yld}</span></div>`;
  }).join('');
  renderSeasonAnalyticsPanel();
}
function renderSeasonArchiveControls(statusMsg=''){
  const select=document.getElementById('seasonArchiveSelect');
  const nameInput=document.getElementById('seasonArchiveName');
  if(!select) return;
  const current=seasonArchiveSelectValue();
  const names=Object.keys(APP_STATE.seasonArchives||{}).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'}));
  select.innerHTML=`<option value="">(none)</option>`+names.map(name=>{
    const a=APP_STATE.seasonArchives[name];
    return `<option value="${escapeHtml(name)}"${name===current?' selected':''}>${escapeHtml(name)}${a?.year?` (${a.year})`:''}</option>`;
  }).join('');
  if(current && !APP_STATE.seasonArchives[current]) select.value='';
  if(nameInput && !nameInput.value.trim()) nameInput.value=`${APP_STATE.planningYear-1} season review`;
  if(!APP_STATE.seasonArchiveDraft || !Array.isArray(APP_STATE.seasonArchiveDraft.cropOutcomes)) APP_STATE.seasonArchiveDraft={cropOutcomes:[]};
  renderSeasonArchiveCropOutcomesEditor();
  renderSeasonArchiveSummary();
  if(statusMsg) setSeasonArchiveStatus(statusMsg);
}
function handleSeasonArchiveUiChange(){
  syncPlanningYearFromUi();
  safeLocalStorageSet(LS_KEYS.planningYear,String(APP_STATE.planningYear));
}
function handleSeasonArchiveSelectionChange(){
  const name=seasonArchiveSelectValue();
  const a=APP_STATE.seasonArchives?.[name];
  const nameInput=document.getElementById('seasonArchiveName');
  if(name && nameInput) nameInput.value=name;
  if(a){
    syncSeasonArchiveForm(a);
    const when=a.updatedAt?new Date(a.updatedAt).toLocaleString():null;
    setSeasonArchiveStatus(`Selected archive "${name}"${a.year?` (${a.year})`:''}${when?` ¬∑ saved ${when}`:''}.`);
  }else{
    setSeasonArchiveStatus();
  }
}
function saveSeasonArchive(){
  updateBedsFromUi();
  syncPlanningYearFromUi();
  syncSeasonArchiveCropOutcomesFromUi();
  const name=seasonArchiveNameValue();
  if(!name){ setSeasonArchiveStatus('Enter an archive name first.'); return; }
  const form=seasonArchiveFormDataFromUi();
  const linkedPreset=rowHistoryPresetSelectValue()||'';
  const cropOutcomes=getSeasonArchiveDraftCropOutcomes();
  APP_STATE.seasonArchives=normalizeSeasonArchives({
    ...(APP_STATE.seasonArchives||{}),
    [name]:{
      name,
      year:APP_STATE.planningYear-1,
      updatedAt:new Date().toISOString(),
      ...form,
      linkedRowHistoryPreset:linkedPreset,
      rowHistorySnapshot:currentRowHistorySnapshot(),
      cropOutcomes
    }
  },APP_STATE.beds);
  persistBedAndWeatherState();
  renderSeasonArchiveControls(`Saved season archive "${name}" (${APP_STATE.planningYear-1}) with ${cropOutcomes.length} crop outcomes.`);
}
function applyRowHistorySnapshotToBeds(snapshot,label='snapshot'){
  const rows=Array.isArray(snapshot)?snapshot:[];
  const byId=new Map(rows.map(x=>[x.bedId,x]));
  const byName=new Map(rows.map(x=>[String(x.bedName||'').toLowerCase(),x]));
  APP_STATE.beds=normalizeBeds((APP_STATE.beds||[]).map(b=>{
    const snap=byId.get(b.id)||byName.get(String(b.name||'').toLowerCase());
    if(!snap) return b;
    const rowCount=getBedRowSettings(b).rowCount;
    return {...b,rowHistory:normalizeBedRowHistory(snap.rowHistory,rowCount)};
  }));
  renderBedsEditor();
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
  const appliedCount=(APP_STATE.beds||[]).filter(b=>Boolean(byId.get(b.id)||byName.get(String(b.name||'').toLowerCase()))).length;
  return appliedCount;
}
function loadSelectedSeasonArchiveToForm(){
  const name=seasonArchiveSelectValue();
  if(!name){ setSeasonArchiveStatus('Select an archive to load into the notes form.'); return; }
  const a=APP_STATE.seasonArchives?.[name];
  if(!a){ setSeasonArchiveStatus(`Archive "${name}" not found.`); return; }
  if(hasSeasonArchiveDraftContent() && !confirmUiAction(`Load archive "${name}" into the form? Unsaved archive form edits/draft crop outcomes will be replaced.`)) return;
  syncSeasonArchiveForm(a);
  setSeasonArchiveStatus(`Loaded archive notes for "${name}" into the form. Use Save if you edit it.`);
}
function applySelectedSeasonArchiveRowHistory(){
  updateBedsFromUi();
  const name=seasonArchiveSelectValue();
  if(!name){ setSeasonArchiveStatus('Select an archive to apply its row history.'); return; }
  const a=APP_STATE.seasonArchives?.[name];
  if(!a){ setSeasonArchiveStatus(`Archive "${name}" not found.`); return; }
  if(!confirmUiAction(`Apply archived row history from "${name}"? This will overwrite current row-history dropdown values for matching beds.`)) return;
  const applied=applyRowHistorySnapshotToBeds(a.rowHistorySnapshot||[],`archive "${name}"`);
  renderSeasonArchiveControls(`Applied row history from archive "${name}" to ${applied} bed${applied===1?'':'s'}.`);
}
function deleteSelectedSeasonArchive(){
  const name=seasonArchiveSelectValue();
  if(!name){ setSeasonArchiveStatus('Select an archive to delete.'); return; }
  if(!confirmUiAction(`Delete season archive "${name}"? This removes notes, crop outcomes, and archived row history for that season.`)) return;
  const next={...(APP_STATE.seasonArchives||{})};
  delete next[name];
  APP_STATE.seasonArchives=normalizeSeasonArchives(next,APP_STATE.beds);
  persistBedAndWeatherState();
  renderSeasonArchiveControls(`Deleted season archive "${name}".`);
}
function syncWeatherUiFromState(){
  const w=normalizeWeatherState(APP_STATE.weather);
  APP_STATE.weather=w;
  const ids={wxRainLast3d:w.rainLast3dIn,wxRainNext3d:w.rainNext3dIn,wxHumidityRisk:w.humidityRisk,wxSoilCondition:w.soilCondition};
  for(const [id,val] of Object.entries(ids)){ const el=document.getElementById(id); if(el)el.value=String(val); }
}
function getWeatherFromUi(){
  return normalizeWeatherState({
    rainLast3dIn:document.getElementById('wxRainLast3d')?.value,
    rainNext3dIn:document.getElementById('wxRainNext3d')?.value,
    humidityRisk:document.getElementById('wxHumidityRisk')?.value,
    soilCondition:document.getElementById('wxSoilCondition')?.value
  });
}
function weatherRiskFlags(crop=null){
  const w=normalizeWeatherState(APP_STATE.weather);
  const flags={avoidClayWork:false,mildewRisk:false,blightRisk:false,wetFootRisk:false,messages:[]};
  flags.avoidClayWork=w.soilCondition==='wet' || w.rainLast3dIn>=1 || (w.soilCondition==='damp'&&w.rainLast3dIn>=0.6);
  flags.mildewRisk=w.humidityRisk==='high' || (w.humidityRisk==='medium'&&w.rainNext3dIn>=1.2);
  flags.blightRisk=(w.humidityRisk==='high'&&w.rainLast3dIn>=0.5) || w.rainNext3dIn>=1.8;
  flags.wetFootRisk=w.soilCondition==='wet' || w.rainLast3dIn>=1.5;
  if(flags.avoidClayWork) flags.messages.push('Heavy clay is likely too wet to work without compaction. Delay digging/tilling and stay on paths.');
  if(flags.mildewRisk) flags.messages.push('Mildew pressure is elevated. Increase airflow, scout lower leaves, and avoid overhead watering.');
  if(flags.blightRisk) flags.messages.push('Leaf disease pressure is elevated after rain/humidity. Mulch and remove lower splash-prone foliage where appropriate.');
  if(crop){
    const sc=getStructuredCrop(crop);
    const diseases=(sc?.ipm?.commonDiseases||[]).join(' ').toLowerCase();
    if(flags.mildewRisk && /\bmildew\b/.test(diseases)) flags.messages.push(`${crop.name} has mildew risk in your IPM list‚Äîscout this crop first.`);
    if(flags.wetFootRisk && /(root rot|phytophthora|rot)/i.test(diseases)) flags.messages.push(`${crop.name} includes rot/wet-foot disease risks‚Äîprioritize drainage and avoid saturated beds.`);
  }
  return flags;
}
function weatherSnapshotLabel(){
  const w=normalizeWeatherState(APP_STATE.weather);
  return `Rain ${w.rainLast3dIn}" last 3d / ${w.rainNext3dIn}" next 3d ¬∑ Humidity ${w.humidityRisk} ¬∑ Soil ${w.soilCondition}`;
}
function persistBedAndWeatherState(){
  safeLocalStorageSet(LS_KEYS.beds,JSON.stringify(APP_STATE.beds));
  safeLocalStorageSet(LS_KEYS.weather,JSON.stringify(APP_STATE.weather));
  safeLocalStorageSet(LS_KEYS.bedPlacementPrefs,JSON.stringify(APP_STATE.bedPlacementPrefs||{}));
  safeLocalStorageSet(LS_KEYS.rowHistoryPresets,JSON.stringify(APP_STATE.rowHistoryPresets||{}));
  safeLocalStorageSet(LS_KEYS.seasonArchives,JSON.stringify(APP_STATE.seasonArchives||{}));
  safeLocalStorageSet(LS_KEYS.observationLogs,JSON.stringify(APP_STATE.observationLogs||[]));
  safeLocalStorageSet(LS_KEYS.taskTracker,JSON.stringify(APP_STATE.taskTracker||{}));
  safeLocalStorageSet(LS_KEYS.planningYear,String(APP_STATE.planningYear||new Date().getFullYear()));
}
function saveBedAndWeatherState(){
  updateBedsFromUi();
  APP_STATE.weather=getWeatherFromUi();
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function loadBedAndWeatherState(){
  try{
    const bedsRaw=safeLocalStorageGet(LS_KEYS.beds);
    APP_STATE.beds=bedsRaw?normalizeBeds(JSON.parse(bedsRaw)):normalizeBeds(DEFAULT_BEDS);
  }catch{ APP_STATE.beds=normalizeBeds(DEFAULT_BEDS); }
  try{
    const prefsRaw=safeLocalStorageGet(LS_KEYS.bedPlacementPrefs);
    APP_STATE.bedPlacementPrefs=prefsRaw?normalizeBedPlacementPrefs(JSON.parse(prefsRaw),APP_STATE.beds):{};
  }catch{ APP_STATE.bedPlacementPrefs={}; }
  try{
    const wxRaw=safeLocalStorageGet(LS_KEYS.weather);
    APP_STATE.weather=wxRaw?normalizeWeatherState(JSON.parse(wxRaw)):normalizeWeatherState(WEATHER_STATE_DEFAULTS);
  }catch{ APP_STATE.weather=normalizeWeatherState(WEATHER_STATE_DEFAULTS); }
  try{
    const presetsRaw=safeLocalStorageGet(LS_KEYS.rowHistoryPresets);
    APP_STATE.rowHistoryPresets=presetsRaw?normalizeRowHistoryPresets(JSON.parse(presetsRaw),APP_STATE.beds):{};
  }catch{ APP_STATE.rowHistoryPresets={}; }
  try{
    const pyRaw=safeLocalStorageGet(LS_KEYS.planningYear);
    APP_STATE.planningYear=Math.max(2020,Math.min(2100,Number(pyRaw)||new Date().getFullYear()));
  }catch{ APP_STATE.planningYear=new Date().getFullYear(); }
  try{
    const archivesRaw=safeLocalStorageGet(LS_KEYS.seasonArchives);
    APP_STATE.seasonArchives=archivesRaw?normalizeSeasonArchives(JSON.parse(archivesRaw),APP_STATE.beds):{};
  }catch{ APP_STATE.seasonArchives={}; }
  try{
    const obsRaw=safeLocalStorageGet(LS_KEYS.observationLogs);
    APP_STATE.observationLogs=obsRaw?normalizeObservationLogs(JSON.parse(obsRaw)):[];
  }catch{ APP_STATE.observationLogs=[]; }
  try{
    const taskRaw=safeLocalStorageGet(LS_KEYS.taskTracker);
    APP_STATE.taskTracker=taskRaw?normalizeTaskTracker(JSON.parse(taskRaw)):{};
  }catch{ APP_STATE.taskTracker={}; }
  renderBedsEditor();
  renderRowHistoryPresetControls();
  renderSeasonArchiveControls();
  renderObservationLogPanel();
  syncWeatherUiFromState();
}
function addBedRow(){
  updateBedsFromUi();
  APP_STATE.beds=[...APP_STATE.beds,{id:uid('bed'),name:`Bed ${String.fromCharCode(65+Math.min(25,APP_STATE.beds.length))}`,lengthFt:8,widthFt:4,sun:'full',drainage:'average'}];
  renderBedsEditor();
  persistBedAndWeatherState();
  handlePlannerControls();
}
function removeBedRow(id){
  updateBedsFromUi();
  APP_STATE.beds=APP_STATE.beds.filter(b=>b.id!==id);
  if(!APP_STATE.beds.length) APP_STATE.beds=normalizeBeds(DEFAULT_BEDS);
  renderBedsEditor();
  persistBedAndWeatherState();
  handlePlannerControls();
}
function resetBeds(){
  APP_STATE.beds=normalizeBeds(DEFAULT_BEDS);
  APP_STATE.bedPlacementPrefs=normalizeBedPlacementPrefs(APP_STATE.bedPlacementPrefs,APP_STATE.beds);
  renderBedsEditor();
  persistBedAndWeatherState();
  handlePlannerControls();
}
function clearPlacementPrefs(){
  APP_STATE.bedPlacementPrefs={};
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function renderBedsEditor(){
  const host=document.getElementById('bedsList');
  if(!host)return;
  APP_STATE.beds=normalizeBeds(APP_STATE.beds);
  host.innerHTML=APP_STATE.beds.map((b,idx)=>`<div data-bed-id="${escapeHtml(b.id)}">
  <div class="pt-bed-row" data-bed-id="${escapeHtml(b.id)}">
    <label>Name<input data-k="name" value="${escapeHtml(b.name)}" oninput="handleBedConfigChange()"></label>
    <label>L (ft)<input data-k="lengthFt" type="number" min="1" max="100" step="0.5" value="${escapeHtml(String(b.lengthFt))}" oninput="handleBedConfigChange()"></label>
    <label>W (ft)<input data-k="widthFt" type="number" min="1" max="30" step="0.5" value="${escapeHtml(String(b.widthFt))}" oninput="handleBedConfigChange()"></label>
    <label>Sun<select data-k="sun" onchange="handleBedConfigChange()"><option value="full"${b.sun==='full'?' selected':''}>Full</option><option value="part"${b.sun==='part'?' selected':''}>Part</option><option value="shade"${b.sun==='shade'?' selected':''}>Shade</option></select></label>
    <label>Drainage<select data-k="drainage" onchange="handleBedConfigChange()"><option value="raised"${b.drainage==='raised'?' selected':''}>Raised</option><option value="good"${b.drainage==='good'?' selected':''}>Good</option><option value="average"${b.drainage==='average'?' selected':''}>Average</option><option value="poor"${b.drainage==='poor'?' selected':''}>Poor</option></select></label>
    <button type="button" onclick="removeBedRow('${escapeHtml(b.id)}')" title="Remove ${escapeHtml(b.name)}" ${APP_STATE.beds.length===1?'disabled':''}>${idx===0&&APP_STATE.beds.length===1?'Keep':'Remove'}</button>
  </div>
  <div class="pt-bed-row-extra" data-bed-id="${escapeHtml(b.id)}">
    <label>Layout<select data-k="layoutMode" onchange="handleBedConfigChange()"><option value="rows"${b.layoutMode==='rows'?' selected':''}>Rows</option><option value="block"${b.layoutMode==='block'?' selected':''}>Block</option></select></label>
    <label>Row Spacing (in)<input data-k="rowSpacingIn" type="number" min="6" max="36" step="1" value="${escapeHtml(String(b.rowSpacingIn||12))}" oninput="handleBedConfigChange()"></label>
    <label>Trellis Side<select data-k="trellisSide" onchange="handleBedConfigChange()"><option value="none"${b.trellisSide==='none'?' selected':''}>None</option><option value="north"${b.trellisSide==='north'?' selected':''}>North</option><option value="south"${b.trellisSide==='south'?' selected':''}>South</option><option value="east"${b.trellisSide==='east'?' selected':''}>East</option><option value="west"${b.trellisSide==='west'?' selected':''}>West</option></select></label>
    <label>Trellis Band (ft)<input data-k="trellisBandFt" type="number" min="0.5" max="4" step="0.5" value="${escapeHtml(String(b.trellisBandFt||1))}" oninput="handleBedConfigChange()"></label>
  </div>
  </div>`).join('');
  updateBedsSummary();
  renderRowHistoryPresetControls();
  renderSeasonArchiveControls();
}
function updateBedsFromUi(){
  const rows=[...document.querySelectorAll('#bedsList > [data-bed-id]')];
  if(!rows.length)return;
  const byId=new Map((APP_STATE.beds||[]).map(b=>[b.id,b]));
  APP_STATE.beds=normalizeBeds(rows.map(r=>{
    const get=k=>r.querySelector(`[data-k="${k}"]`)?.value;
    const id=r.dataset.bedId||uid('bed');
    return {id,name:get('name'),lengthFt:get('lengthFt'),widthFt:get('widthFt'),sun:get('sun'),drainage:get('drainage'),layoutMode:get('layoutMode'),rowSpacingIn:get('rowSpacingIn'),trellisSide:get('trellisSide'),trellisBandFt:get('trellisBandFt'),rowHistory:byId.get(id)?.rowHistory||[]};
  }));
  APP_STATE.bedPlacementPrefs=normalizeBedPlacementPrefs(APP_STATE.bedPlacementPrefs,APP_STATE.beds);
}
function handleBedConfigChange(){
  updateBedsFromUi();
  updateBedsSummary();
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderAssistantPanel();
}
function handleWeatherControls(){
  APP_STATE.weather=getWeatherFromUi();
  persistBedAndWeatherState();
  renderWeatherAlerts();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function updateBedsSummary(){
  const el=document.getElementById('bedsSummary');
  if(!el)return;
  const beds=getActiveBeds();
  const total=totalBedSqFt(beds);
  el.innerHTML=`Beds configured: <strong>${beds.length}</strong> ¬∑ Total area: <strong>${total.toFixed(1)} sq ft</strong>${APP_STATE.bedSpaceLimit>0?` ¬∑ Planner cap: <strong>${APP_STATE.bedSpaceLimit.toFixed(0)} sq ft</strong>`:''}`;
}
function renderWeatherAlerts(crop=getSelectedCrop()){
  const el=document.getElementById('plannerWeatherAlerts');
  if(!el)return;
  const flags=weatherRiskFlags(crop||null),w=normalizeWeatherState(APP_STATE.weather);
  const msgs=[`Snapshot: <strong>${w.rainLast3dIn}"</strong> last 3d ¬∑ <strong>${w.rainNext3dIn}"</strong> next 3d ¬∑ humidity <strong>${w.humidityRisk}</strong> ¬∑ soil <strong>${w.soilCondition}</strong>.`];
  if(flags.messages.length) msgs.push(...flags.messages.map(m=>m));
  else msgs.push('No major clay/mildew risk flags from the current weather inputs.');
  const lead=flags.avoidClayWork||flags.mildewRisk||flags.blightRisk?'<span class="warn">Watch-outs:</span> ':'<span class="good">Conditions look manageable:</span> ';
  el.innerHTML=lead+msgs.join(' ');
}
function drainageRank(v){return ({poor:0,average:1,good:2,raised:3})[v]??1}
function sunRank(v){return ({shade:0,part:1,full:2})[v]??1}
function getRotationFamily(crop,sc=getStructuredCrop(crop)){
  const n=String(crop?.name||'').toLowerCase();
  if(/tomato|pepper|eggplant|tomatillo/.test(n)) return 'solanaceae';
  if(/cucumber|squash|pumpkin|melon/.test(n)) return 'cucurbit';
  if(/pea|bean|edamame|soybean|lima/.test(n)) return 'legume';
  if(/onion|garlic|shallot|scallion|leek/.test(n)) return 'allium';
  if(/broccoli|cabbage|cauliflower|brussels|kale|collard|radish|turnip|rutabaga|kohlrabi/.test(n)) return 'brassica';
  if(/carrot|beet|parsnip|potato|sweet potato/.test(n)) return 'root';
  if(/lettuce|spinach|chard|arugula|celtuce/.test(n)) return 'leafy';
  if(/corn/.test(n)) return 'corn';
  if(/strawberr|raspberr|blackberr|blueberr/.test(n)) return 'berry';
  if(crop?.cat==='Perennials') return 'perennial';
  if(crop?.cat==='Herbs') return 'herb';
  if(crop?.cat==='Leafy Greens') return 'leafy';
  if(crop?.cat==='Root Vegetables') return 'root';
  if(crop?.cat==='Alliums') return 'allium';
  if(crop?.cat==='Brassicas' || crop?.cat==='Cabbages') return 'brassica';
  if(crop?.cat==='Berries') return 'berry';
  return 'none';
}
function familyRotationWarning(prevFamily,currentFamily){
  if(!prevFamily || prevFamily==='none' || !currentFamily || currentFamily==='none') return '';
  if(prevFamily===currentFamily){
    return `Rotation warning: same family (${ROTATION_FAMILY_LABELS[currentFamily]||currentFamily}) in the same row.`;
  }
  if((prevFamily==='solanaceae'&&currentFamily==='cucurbit')||(prevFamily==='cucurbit'&&currentFamily==='solanaceae')){
    return '';
  }
  return '';
}
function bedSuitabilityScoreForCrop(bed,crop,sc){
  let score=0;
  const bedSun=sunRank(bed.sun), wantSun=String(sc?.site?.sun||'').toLowerCase();
  if(wantSun.includes('full')) score += bedSun===2?3:bedSun===1?1:-3;
  else if(wantSun.includes('part')) score += bedSun>=1?2:0;
  const wantDrain=String(sc?.site?.drainage||'').toLowerCase();
  const dRank=drainageRank(bed.drainage);
  if(/well|good|raised|loose/.test(wantDrain)) score += dRank>=2?3:dRank===1?0:-3;
  const wet=weatherRiskFlags(crop).wetFootRisk;
  if(wet && dRank===0) score-=4;
  if(wet && dRank>=2) score+=2;
  const ar=bedAnalyticsRiskForCrop(bed,crop,sc);
  score+=Number(ar.scoreAdj||0);
  return score;
}
function isLikelyTrellisCrop(crop,sc){
  const n=String(crop?.name||'').toLowerCase();
  if(/\bpeas?\b|pole snap beans|pole beans|cucumbers|tomatillos/.test(n)) return true;
  if(/\btomatoes\b/.test(n)) return true;
  if(/\bblackberries|raspberries\b/.test(n)) return true;
  return Boolean(sc?.spacing?.betweenRowsIn && sc.spacing.betweenRowsIn>=30 && /bean|pea|cucumber|tomato|berry/i.test(n));
}
function getBedRowSettings(bed){
  const mode=bed?.layoutMode==='block'?'block':'rows';
  const rowSpacingIn=clamp(Number(bed?.rowSpacingIn)||12,6,36);
  const rowCount=Math.max(1,Math.floor(((Number(bed?.widthFt)||1)*12)/rowSpacingIn));
  const actualRowSpacingIn=round1(((Number(bed?.widthFt)||1)*12)/rowCount);
  const trellisSide=['north','south','east','west'].includes(bed?.trellisSide)?bed.trellisSide:'none';
  const trellisBandFt=clamp(Number(bed?.trellisBandFt)||1,0.5,4);
  return {mode,rowSpacingIn,actualRowSpacingIn,rowCount,trellisSide,trellisBandFt};
}
function buildBedRowSnapLayout(allocation,bed){
  const settings=getBedRowSettings(bed);
  if(settings.mode!=='rows') return null;
  const rowLenFt=Math.max(1,Number(bed?.lengthFt)||1);
  const rowHistory=normalizeBedRowHistory(bed?.rowHistory,settings.rowCount);
  const analytics=getSeasonAnalyticsSnapshot();
  const lanes=Array.from({length:settings.rowCount},(_,i)=>{
    const rowLabel=rowLabelForBedLane(bed,i);
    const rowHotspot=analytics?.hotspotByLabel?.[rowLabel]||null;
    const rowHint=rowHotspot?`${rowHotspot.obsCount} obs ¬∑ pest ${rowHotspot.pestHits} ¬∑ disease ${rowHotspot.diseaseHits}`:'';
    return {index:i,label:`R${i+1}`,rowLabel,remainingFt:rowLenFt,segments:[],overflowFt:0,isTrellis:false,prevFamily:rowHistory[i]||'none',dominantFamily:'none',rotationWarning:'',rowHotspot,rowHint};
  });
  if(settings.trellisSide!=='none'){
    const trellisIndex=(settings.trellisSide==='south' || settings.trellisSide==='west') ? lanes.length-1 : 0;
    if(lanes[trellisIndex]){ lanes[trellisIndex].isTrellis=true; lanes[trellisIndex].label=`R${trellisIndex+1}`; }
  }
  const rowAssignments=[];
  (allocation?.rows||[]).forEach(r=>{
    const hit=(r.allocation?.bedAssignments||[]).find(a=>a.bedId===bed.id);
    if(!hit) return;
    const sc=r.sc||getStructuredCrop(r.crop);
    const pref=getPlacementPref(r.crop.name);
    const preferredRowIndex=(pref?.bedId===bed.id && Number.isInteger(pref?.rowIndex))?Math.max(0,Math.min(lanes.length-1,pref.rowIndex)):null;
    const betweenRowsIn=Number(sc?.spacing?.betweenRowsIn)||settings.actualRowSpacingIn||12;
    const rowFeetNeeded=round1((Number(hit.sqFt)||0)/Math.max(0.5,betweenRowsIn/12));
    const isTrellis=isLikelyTrellisCrop(r.crop,sc);
    const tooTight=betweenRowsIn>(settings.actualRowSpacingIn*1.15);
    const rotationFamily=getRotationFamily(r.crop,sc);
    rowAssignments.push({crop:r.crop,sc,color:cropColor(r.crop.name),plants:hit.plants,sqFt:hit.sqFt,rowFeetNeeded,betweenRowsIn,isTrellis,tooTight,locked:Boolean(r.allocation?.lockedToBed),preferredBedId:r.allocation?.preferredBedId||null,preferredRowIndex,rotationFamily});
  });
  rowAssignments.sort((a,b)=>(b.isTrellis?1:0)-(a.isTrellis?1:0)||b.rowFeetNeeded-a.rowFeetNeeded||a.crop.name.localeCompare(b.crop.name));
  for(const item of rowAssignments){
    let need=Math.max(0,item.rowFeetNeeded||0);
    const laneOrder=lanes
      .map((lane,idx)=>{
        const rowAnalytics=getRowPlacementAnalyticsForCrop(bed,idx,item.crop,item.sc,analytics);
        const sameFamilyRotation=(lane.prevFamily && lane.prevFamily!=='none' && item.rotationFamily && item.rotationFamily!=='none' && lane.prevFamily===item.rotationFamily);
        const rotationPenalty=sameFamilyRotation?120:0;
        const score=(item.preferredRowIndex===idx?200:0)+(item.isTrellis&&lane.isTrellis?100:0)+(lane.isTrellis&&!item.isTrellis?-4:0)+(lane.remainingFt*1.2)+(Number(rowAnalytics.scoreAdj||0)*8)-rotationPenalty;
        return {lane,idx,score,rowAnalytics,rotationPenalty,sameFamilyRotation};
      })
      .sort((a,b)=>b.score-a.score||a.idx-b.idx);
    item.suggestedRowIndex=laneOrder[0]?.idx??null;
    item.suggestedRowReason=laneOrder[0]?.sameFamilyRotation?'rotation break':(laneOrder[0]?.rowAnalytics?.severity?'row hotspot avoidance':(item.isTrellis?'trellis lane':'row capacity'));
    for(const {lane} of laneOrder){
      if(need<=0) break;
      if(lane.remainingFt<=0) continue;
      const take=round1(Math.min(need,lane.remainingFt));
      if(take<=0) continue;
      const usedFt=round1(rowLenFt-lane.remainingFt);
      const laneRisk=getRowPlacementAnalyticsForCrop(bed,lane.index,item.crop,item.sc,analytics);
      lane.segments.push({cropName:item.crop.name,color:item.color,startFt:usedFt,lenFt:take,plants:item.plants,sqFt:item.sqFt,tight:item.tooTight,locked:item.locked,betweenRowsIn:item.betweenRowsIn,isTrellis:item.isTrellis,preferredRow:Boolean(item.preferredRowIndex===lane.index),rotationFamily:item.rotationFamily,rowRiskSeverity:laneRisk.severity||0,rowRiskHit:Boolean(laneRisk.severity)});
      lane.remainingFt=round1(Math.max(0,lane.remainingFt-take));
      need=round1(Math.max(0,need-take));
    }
    if(need>0){
      const targetLane=laneOrder[0]?.lane||lanes[0];
      if(targetLane) targetLane.overflowFt=round1((targetLane.overflowFt||0)+need);
    }
  }
  lanes.forEach(lane=>{
    const famLengths={};
    lane.segments.forEach(seg=>{
      const f=seg.rotationFamily||'none';
      famLengths[f]=(famLengths[f]||0)+(seg.lenFt||0);
    });
    const dominant=Object.entries(famLengths).sort((a,b)=>b[1]-a[1])[0]?.[0]||'none';
    lane.dominantFamily=dominant;
    lane.rotationWarning=familyRotationWarning(lane.prevFamily,dominant);
    if(!lane.rotationWarning && lane.rowHotspot && (lane.rowHotspot.diseaseHits>=2 || lane.rowHotspot.obsCount>=4)){
      lane.analyticsHint=`Historical row hotspot: ${lane.rowHint}. Planner scores this row lower for susceptible crops.`;
    }else{
      lane.analyticsHint=lane.rowHotspot?`Row history logs: ${lane.rowHint}.`:''; 
    }
  });
  return {settings,rowLenFt,lanes,rowAssignments};
}
function getVarietyRecipeTags(crop,variety){
  const rules=VARIETY_RECIPE_TAG_RULES[crop?.name]||[];
  const name=String(variety?.n||'');
  const tags=new Set();
  const roles=[];
  for(const rule of rules){
    if(rule.match.test(name)){
      (rule.tags||[]).forEach(t=>tags.add(t));
      if(rule.role)roles.push(rule.role);
    }
  }
  return {tags:[...tags],roles:[...new Set(roles)]};
}
function getRecipeVarietySuggestions(crop){
  if(!crop||!Array.isArray(crop.vars)) return [];
  const activeRecipes=Object.entries(APP_STATE.recipeTargets||{}).filter(([,v])=>Number(v)>0).map(([k])=>RECIPE_TARGET_TO_PROFILE[k]).filter(Boolean);
  if(!activeRecipes.length) return [];
  return crop.vars.map(vr=>({variety:vr,tags:getVarietyRecipeTags(crop,vr)}))
    .filter(x=>x.tags.tags.some(t=>activeRecipes.includes(t)))
    .map(x=>({name:x.variety.n,tags:x.tags.tags.filter(t=>activeRecipes.includes(t)),roles:x.tags.roles}))
    .slice(0,4);
}
function inferMethodCode(method){
  const m=String(method||'').toLowerCase();
  if(m.includes('indoor'))return 'indoor_transplant';
  if(m.includes('direct sow'))return 'direct_sow';
  if(m.includes('fall plant'))return 'fall_plant';
  if(m.includes('buy'))return 'transplant_or_purchase';
  return 'mixed';
}
const IPM_ISSUE_LIBRARY={
  categories:{
    'Tomato Family':[
      {id:'early-blight',label:'Early blight',type:'disease',symptoms:['brown leaf spots with rings','lower leaves yellowing upward'],scout:['check lower leaves weekly after rains','watch splash zone after storms'],prevention:['mulch soil splash zone','prune lower leaves for airflow','avoid overhead watering'],actionThreshold:'Act when spots are spreading beyond lower leaves or defoliation starts climbing the plant.',treatmentNotes:['remove worst infected leaves','improve airflow immediately']},
      {id:'septoria',label:'Septoria leaf spot',type:'disease',symptoms:['many small dark spots on lower leaves','rapid yellowing/leaf drop'],scout:['inspect lower canopy after humid periods'],prevention:['mulch + stake/cage','sanitize fallen leaves'],actionThreshold:'Act at first clear spread in humid weather to preserve canopy.'},
      {id:'hornworm',label:'Tomato hornworm',type:'pest',symptoms:['large chunks missing from leaves','dark droppings on leaves/soil'],scout:['check stems/undersides at dusk or morning','look for frass before searching'],prevention:['hand-pick early','encourage beneficial wasps'],actionThreshold:'Act immediately when found; a few worms can strip a plant fast.'}
    ],
    'Squash Family':[
      {id:'cuke-beetle',label:'Cucumber beetles',type:'pest',symptoms:['striped/spotted beetles on seedlings','chewed cotyledons/leaves','sudden wilt from bacterial wilt risk'],scout:['check seedlings daily after emergence/transplant','monitor flowers for beetles'],prevention:['row cover before bloom','trap crop/fast scouting','trellis + sanitation'],actionThreshold:'Act immediately on seedlings or if beetles are persistent on young plants.'},
      {id:'powdery-mildew',label:'Powdery mildew',type:'disease',symptoms:['white powdery patches on leaves','older leaves yellowing'],scout:['inspect oldest leaves first during humid spells'],prevention:['airflow spacing','trellis where possible','avoid excess shade'],actionThreshold:'Act when patches appear on multiple leaves or spread despite pruning.'},
      {id:'squash-bug',label:'Squash bugs',type:'pest',symptoms:['bronzed/stippled leaves','egg clusters on leaf undersides','wilting from heavy feeding'],scout:['flip leaves weekly for bronze egg clusters'],prevention:['destroy egg clusters','clean vines/debris','row cover pre-bloom'],actionThreshold:'Act when eggs/nymphs are found; early control is much easier than adults.'}
    ],
    'Brassicas':[
      {id:'cabbage-worms',label:'Cabbage worms',type:'pest',symptoms:['chewed holes plus green frass','damage in head centers'],scout:['check undersides weekly','inspect growing points'],prevention:['row cover','BT timing','hand-pick'],actionThreshold:'Act at first frass/larvae in head-forming crops.'},
      {id:'flea-beetles',label:'Flea beetles',type:'pest',symptoms:['shot-hole damage on young leaves'],scout:['check seedlings and transplants daily in warm dry weather'],prevention:['row cover early','fast growth with moisture'],actionThreshold:'Act if seedlings are heavily peppered or growth stalls.'},
      {id:'black-rot',label:'Black rot',type:'disease',symptoms:['yellow V-shaped lesions from leaf edge','darkened veins'],scout:['inspect outer leaves after warm wet periods'],prevention:['sanitation','rotation','avoid working wet foliage'],actionThreshold:'Remove infected leaves/plants promptly at first clear symptoms.'}
    ],
    'Beans':[
      {id:'bacterial-blight',label:'Bacterial blight',type:'disease',symptoms:['water-soaked to brown leaf spots','pod spotting'],scout:['check after rain or overhead watering'],prevention:['do not work foliage wet','rotation','spacing for airflow'],actionThreshold:'Act immediately on sanitation and avoid handling when wet if spots appear.'},
      {id:'bean-beetles',label:'Bean beetles',type:'pest',symptoms:['skeletonized leaves','yellow egg masses'],scout:['check leaf undersides and new growth weekly'],prevention:['succession planting','hand-pick eggs/larvae'],actionThreshold:'Act when feeding is increasing on young plants or pods are targeted.'}
    ],
    'Corn':[
      {id:'earworm',label:'Corn earworm',type:'pest',symptoms:['silk feeding','damaged ear tips/kernels'],scout:['inspect silks and tips during ear set'],prevention:['timely harvest','silk protection methods'],actionThreshold:'Act during fresh silk stage if pressure is recurring in your garden.'}
    ],
    'Berries':[
      {id:'swd',label:'Spotted wing drosophila',type:'pest',symptoms:['soft berries collapsing quickly','larvae in ripe fruit'],scout:['check ripening fruit frequently in warm humid weather'],prevention:['frequent harvest','sanitation','netting where practical'],actionThreshold:'Act before peak ripening if you have prior-season SWD pressure.'}
    ]
  },
  crops:{
    'Tomatoes':[
      {id:'late-blight',label:'Late blight',type:'disease',symptoms:['water-soaked dark lesions','fast collapse in cool wet weather','fruit greasy brown spots'],scout:['check after rainy humid stretches','watch forecasts + nearby reports'],prevention:['airflow + spacing','avoid overhead watering','sanitation'],actionThreshold:'Act immediately at first suspected symptoms; spread can be rapid.'}
    ],
    'Peppers':[
      {id:'phytophthora',label:'Phytophthora blight',type:'disease',symptoms:['sudden wilt after rain','stem/crown dark rot','fruit rot near soil splash'],scout:['check low/wet spots after heavy rain'],prevention:['raised/fast-draining beds','mulch','avoid saturated soil'],actionThreshold:'Act immediately and avoid replanting susceptible crops in saturated spots.'},
      {id:'bacterial-leaf-spot',label:'Bacterial leaf spot',type:'disease',symptoms:['small angular leaf spots','shot-hole leaves','fruit lesions'],scout:['inspect after warm wet weather'],prevention:['avoid wet foliage handling','mulch splash zone','rotation'],actionThreshold:'Act on sanitation and handling practices at first spread.'}
    ],
    'Cucumbers':[
      {id:'bacterial-wilt',label:'Bacterial wilt',type:'disease',symptoms:['sudden daytime wilt progressing to collapse','often after cucumber beetle feeding'],scout:['flag wilted runners quickly','monitor beetles early'],prevention:['cucumber beetle control early','row cover before bloom'],actionThreshold:'Remove badly wilted vines and prioritize beetle control at first suspects.'},
      {id:'downy-mildew',label:'Downy mildew',type:'disease',symptoms:['angular yellow lesions','gray-purple growth underside'],scout:['check after humid/rainy periods, especially late season'],prevention:['airflow and trellis','avoid overhead irrigation'],actionThreshold:'Act when lesions spread across multiple leaves.'}
    ],
    'Zucchini/Summer Squash':[
      {id:'svb',label:'Squash vine borer',type:'pest',symptoms:['sudden wilt despite moist soil','frass at vine base'],scout:['inspect vine bases several times per week during borer season'],prevention:['stem wraps','row cover pre-bloom','succession planting'],actionThreshold:'Act immediately when frass/wilt is seen on susceptible squash.'}
    ],
    'Sweet Corn':[
      {id:'raccoons',label:'Raccoons',type:'pest',symptoms:['ears stripped overnight','stalks bent/broken'],scout:['watch as ears fill and sweeten'],prevention:['timing + deterrents/fencing','harvest promptly'],actionThreshold:'Act before milk stage if raccoon pressure is a known issue.'}
    ],
    'Okra':[
      {id:'okra-leafspot',label:'Leaf spot / mildew pressure',type:'disease',symptoms:['leaf spots or mildew in dense humid growth'],scout:['check lower canopy in humid stretches'],prevention:['space for airflow','harvest frequently to keep plants manageable'],actionThreshold:'Act when lower-canopy spotting begins to climb upward.'}
    ],
    'Basil (Genovese)':[
      {id:'basil-downy',label:'Basil downy mildew',type:'disease',symptoms:['yellowing between veins','gray-purple fuzz underside'],scout:['check undersides in humid weather'],prevention:['airflow','morning harvest','avoid wet foliage overnight'],actionThreshold:'Act immediately at first fuzzy underside growth to protect usable harvest.'}
    ]
  }
};
function normalizeIpmIssueRecords(records){
  const arr=Array.isArray(records)?records:[];
  const out=[];
  for(const raw of arr){
    if(!raw||typeof raw!=='object') continue;
    const label=String(raw.label||raw.name||'').trim();
    if(!label) continue;
    out.push({
      id:String(raw.id||slugify(label)).slice(0,64),
      label:label.slice(0,80),
      type:raw.type==='disease'?'disease':'pest',
      symptoms:(Array.isArray(raw.symptoms)?raw.symptoms:[]).map(x=>String(x).trim()).filter(Boolean).slice(0,6),
      scout:(Array.isArray(raw.scout)?raw.scout:[]).map(x=>String(x).trim()).filter(Boolean).slice(0,5),
      prevention:(Array.isArray(raw.prevention)?raw.prevention:[]).map(x=>String(x).trim()).filter(Boolean).slice(0,6),
      actionThreshold:String(raw.actionThreshold||raw.threshold||'').trim().slice(0,220),
      treatmentNotes:(Array.isArray(raw.treatmentNotes||raw.actions)?(raw.treatmentNotes||raw.actions):[]).map(x=>String(x).trim()).filter(Boolean).slice(0,5)
    });
  }
  const seen=new Set();
  return out.filter(r=>{ const k=r.id||slugify(r.label); if(seen.has(k)) return false; seen.add(k); return true; });
}
function synthesizeIpmIssueRecordsFromLists(ipm){
  if(!ipm) return [];
  const pests=(ipm.commonPests||[]).slice(0,3).map(name=>({label:String(name),type:'pest',symptoms:[],scout:[`Scout ${String(name)} during active growth.`],prevention:(ipm.prevention||[]).slice(0,3),actionThreshold:'Act when feeding/damage increases or plants are stressed.'}));
  const diseases=(ipm.commonDiseases||[]).slice(0,3).map(name=>({label:String(name),type:'disease',symptoms:[],scout:[`Scout for ${String(name)} symptoms after rain/humidity events.`],prevention:(ipm.prevention||[]).slice(0,3),actionThreshold:'Act at first clear spread to protect healthy foliage.'}));
  return normalizeIpmIssueRecords([...pests,...diseases]);
}
function getStructuredIpmForCrop(crop,merged){
  const ipm=mergeDeep({},merged?.ipm||{});
  const catIssues=IPM_ISSUE_LIBRARY.categories[crop?.cat]||[];
  const cropIssues=IPM_ISSUE_LIBRARY.crops[crop?.name]||[];
  const rawIssues=[...(Array.isArray(ipm.issueRecords)?ipm.issueRecords:[]),...catIssues,...cropIssues];
  const issueRecords=normalizeIpmIssueRecords(rawIssues);
  ipm.issueRecords=issueRecords.length?issueRecords:synthesizeIpmIssueRecordsFromLists(ipm);
  return ipm;
}
function findIpmIssuesByQuestion(sc,q){
  const issues=sc?.ipm?.issueRecords||[];
  const nq=String(q||'').toLowerCase();
  if(!nq) return [];
  const hits=issues.filter(issue=>{
    const hay=[issue.label,...(issue.symptoms||[]),...(issue.scout||[]),...(issue.prevention||[])].join(' ').toLowerCase();
    const tokens=String(issue.label||'').toLowerCase().split(/[^a-z0-9]+/).filter(t=>t.length>=3);
    return tokens.some(t=>nq.includes(t)) || (hay && (nq.includes(issue.id) || hay.includes(nq)));
  });
  return hits.slice(0,3);
}
function getSymptomLookupChips(sc,limit=10){
  const issues=sc?.ipm?.issueRecords||[];
  const seen=new Set();
  const out=[];
  for(const issue of issues){
    for(const s of (issue.symptoms||[])){
      const key=String(s||'').toLowerCase().trim();
      if(!key || seen.has(key)) continue;
      seen.add(key);
      out.push(String(s));
      if(out.length>=limit) return out;
    }
  }
  return out;
}
function buildSymptomLookupResultHtml(crop,query=''){
  const sc=getStructuredCrop(crop);
  const issues=sc?.ipm?.issueRecords||[];
  if(!issues.length) return 'No structured IPM issue records are available for this crop yet.';
  const q=String(query||'').trim();
  const matched=q?findIpmIssuesByQuestion(sc,q):issues.slice(0,3);
  if(q && !matched.length){
    return `No direct IPM issue match for ‚Äú${escapeHtml(q)}‚Äù. Try a symptom phrase from the chips below or ask the Master Gardener panel.`;
  }
  const intro=q?`Likely IPM matches for ‚Äú${escapeHtml(q)}‚Äù:`:'Top IPM issues for this crop:';
  const blocks=matched.map(issue=>{
    const symptoms=(issue.symptoms||[]).slice(0,2).join('; ');
    const scout=(issue.scout||[]).slice(0,2).join('; ');
    const prevention=(issue.prevention||[]).slice(0,2).join('; ');
    const threshold=issue.actionThreshold||'No threshold note yet.';
    return `<div class="symx-issue"><b>${escapeHtml(issue.label)}</b> <span style="color:#6b7b6b">(${escapeHtml(issue.type)})</span>${symptoms?`<br><span>Symptoms: ${escapeHtml(symptoms)}</span>`:''}${scout?`<br><span>Scout: ${escapeHtml(scout)}</span>`:''}${prevention?`<br><span>Prevention: ${escapeHtml(prevention)}</span>`:''}<br><span style="color:#92400e">Threshold: ${escapeHtml(threshold)}</span></div>`;
  }).join('');
  return `<div>${intro}</div>${blocks}`;
}
function runSymptomLookup(queryOverride=''){
  const crop=getSelectedCrop();
  const out=document.getElementById('symptomLookupResult');
  if(!crop || !out) return;
  const input=document.getElementById('symptomLookupInput');
  const q=String(queryOverride || input?.value || '').trim();
  if(input && queryOverride) input.value=q;
  out.innerHTML=buildSymptomLookupResultHtml(crop,q);
}
function useSymptomLookupChip(symptom){
  const input=document.getElementById('symptomLookupInput');
  if(input) input.value=String(symptom||'');
  runSymptomLookup(String(symptom||''));
}
function getStructuredCrop(crop){
  if(!crop)return null;
  const key=crop.name;
  if(STRUCT_CACHE.has(key))return STRUCT_CACHE.get(key);
  const base=CATEGORY_SCHEMA_DEFAULTS[crop.cat]||{};
  const over=CROP_SCHEMA_OVERRIDES[crop.name]||{};
  const merged=mergeDeep(base,over);
  const structuredIpm=getStructuredIpmForCrop(crop,merged);
  const out={
    id:slugify(crop.name),
    category:crop.cat,
    name:crop.name,
    method:inferMethodCode(crop.method),
    season:crop.season,
    calendar:{events:(crop.mo||[]).map(e=>({month:e.m,type:e.t}))},
    site:merged.site||null,
    spacing:merged.spacing||null,
    yield:merged.yield||null,
    householdPlanning:merged.householdPlanning||null,
    preservation:merged.preservation||null,
    recipeProfiles:Array.isArray(merged.recipeProfiles)?merged.recipeProfiles:[],
    ipm:structuredIpm||null,
    notes:{summary:stripHtml(crop.cn),clayTips:(crop.tips||[]).map(stripHtml).filter(t=>/clay|drain|wet feet|compost|raised bed/i.test(t)).slice(0,2)}
  };
  STRUCT_CACHE.set(key,out);
  return out;
}
function monthActionsForCrop(crop,month){
  return ['i','t','d','f','h'].filter(k=>(crop.mo||[]).some(e=>e.m===month&&e.t===k));
}
function fmtRange(r,sfx=''){
  if(!r||!Array.isArray(r)||r.length<2)return 'N/A';
  return `${r[0]}-${r[1]}${sfx}`;
}
function fmtPhRange(r){
  if(!r||!Array.isArray(r)||r.length<2)return 'N/A';
  return `${r[0]}-${r[1]}`;
}
function fmtSpacing(sp){
  if(!sp)return 'N/A';
  const a=sp.inRowIn?`${sp.inRowIn}" in-row`:'';
  const b=sp.betweenRowsIn?`${sp.betweenRowsIn}" rows`:'';
  const c=sp.squareFootQty?`${sp.squareFootQty}/sq ft`:'';
  return [a,b,c].filter(Boolean).join(' ¬∑ ')||'N/A';
}
function getRecipeTargetsFromUi(){
  return {
    salsaPints:parseNum(document.getElementById('rtSalsaPints')?.value,0,500),
    pickleQuarts:parseNum(document.getElementById('rtPickleQuarts')?.value,0,500),
    pestoBatches:parseNum(document.getElementById('rtPestoBatches')?.value,0,500),
    curryPots:parseNum(document.getElementById('rtCurryPots')?.value,0,500)
  };
}
function getRecipeDemandBoostLegacy(crop){
  const targets=APP_STATE.recipeTargets||RECIPE_TARGET_DEFAULTS;
  let plants=0;
  const reasons=[];
  for(const [targetKey, rules] of Object.entries(RECIPE_RULES)){
    const units=Number(targets[targetKey]||0);
    if(!units)continue;
    for(const rule of rules){
      if(rule.match.test(crop.name)){
        const add=units*rule.plantsPerUnit;
        plants+=add;
        reasons.push(`${rule.label}: +${add.toFixed(1)} (${targetKey})`);
      }
    }
  }
  return {plantsRaw:plants,plantsRounded:Math.ceil(plants),reasons,mode:'legacy'};
}
function getRecipeDemandBoost(crop){
  const sc=getStructuredCrop(crop);
  const targets=APP_STATE.recipeTargets||RECIPE_TARGET_DEFAULTS;
  const profiles=Array.isArray(sc?.recipeProfiles)?sc.recipeProfiles:[];
  if(!profiles.length) return getRecipeDemandBoostLegacy(crop);
  let plants=0;
  const reasons=[];
  const profileHits=[];
  for(const profile of profiles){
    const targetKey=Object.keys(RECIPE_TARGET_TO_PROFILE).find(k=>RECIPE_TARGET_TO_PROFILE[k]===profile.recipe);
    if(!targetKey)continue;
    const units=Number(targets[targetKey]||0);
    if(!units)continue;
    const unitsPerPlant=Math.max(.01,Number(profile.unitsPerPlant)||0);
    if(!unitsPerPlant)continue;
    const add=units/unitsPerPlant;
    plants+=add;
    profileHits.push({recipe:profile.recipe,units,unitsPerPlant,add});
    const pref=(profile.preferredVarieties||[]).slice(0,2).join(' / ');
    reasons.push(`${profile.recipe}: +${add.toFixed(1)} (${units} target units${pref?`; prefer ${pref}`:''})`);
  }
  if(!profileHits.length) return getRecipeDemandBoostLegacy(crop);
  return {plantsRaw:plants,plantsRounded:Math.ceil(plants),reasons,mode:'profile',profileHits};
}
function renderRecipeDemandSummary(){
  const el=document.getElementById('recipeDemandSummary');
  if(!el)return;
  const t=APP_STATE.recipeTargets;
  const active=Object.entries(t).filter(([,v])=>v>0);
  if(!active.length){
    el.textContent='Recipe target boosts are off (all set to 0).';
    return;
  }
  el.innerHTML=`Recipe demand enabled: ${active.map(([k,v])=>`<strong>${v}</strong> ${RECIPE_TARGET_LABELS[k]||k}`).join(' ¬∑ ')}. Planner uses crop recipe profiles when available (with legacy fallback matching for the rest).`;
}
function getTaskEngineUiState(){
  const winEl=document.getElementById('taskWindowMode');
  const focusEl=document.getElementById('taskFocusMode');
  if(winEl && ['today','week','month'].includes(winEl.value)) TASK_ENGINE_STATE.windowMode=winEl.value;
  if(focusEl && ['auto','selected','all'].includes(focusEl.value)) TASK_ENGINE_STATE.focus=focusEl.value;
  return {...TASK_ENGINE_STATE};
}
function syncTaskEngineControlsToUi(){
  const winEl=document.getElementById('taskWindowMode');
  const focusEl=document.getElementById('taskFocusMode');
  if(winEl) winEl.value=TASK_ENGINE_STATE.windowMode||'week';
  if(focusEl) focusEl.value=TASK_ENGINE_STATE.focus||'auto';
}
function handleTaskEngineControlsChange(){
  getTaskEngineUiState();
  renderPeoplePlanner();
}
function getTaskTrackerEntry(key){
  return normalizeTaskTracker({tmp:(APP_STATE.taskTracker||{})[String(key||'')]}).tmp||{done:false,snoozeUntil:'',note:'',updatedAt:'',doneAt:''};
}
function setTaskTrackerEntry(key,patch={}){
  const k=String(key||'').trim().slice(0,180);
  if(!k) return;
  const cur=getTaskTrackerEntry(k);
  const next=normalizeTaskTracker({[k]:{...cur,...patch,updatedAt:new Date().toISOString()}})[k];
  const map={...(APP_STATE.taskTracker||{})};
  if(next && (next.done || next.snoozeUntil || next.note)) map[k]=next;
  else delete map[k];
  APP_STATE.taskTracker=normalizeTaskTracker(map);
  persistBedAndWeatherState();
}
function clearTaskTrackerEntry(key){
  const k=String(key||'').trim();
  if(!k) return;
  const map={...(APP_STATE.taskTracker||{})};
  delete map[k];
  APP_STATE.taskTracker=normalizeTaskTracker(map);
  persistBedAndWeatherState();
}
function toggleTaskDone(key){
  const cur=getTaskTrackerEntry(key);
  if(cur.done) setTaskTrackerEntry(key,{done:false,doneAt:''});
  else setTaskTrackerEntry(key,{done:true,doneAt:new Date().toISOString(),snoozeUntil:''});
  renderPeoplePlanner();
}
function snoozeTaskByDays(key,days){
  const cur=getTaskTrackerEntry(key);
  setTaskTrackerEntry(key,{done:false,snoozeUntil:addDaysIsoLocal(days||1),doneAt:cur.doneAt||''});
  renderPeoplePlanner();
}
function clearTaskSnooze(key){
  const cur=getTaskTrackerEntry(key);
  if(cur.note && !cur.done) setTaskTrackerEntry(key,{snoozeUntil:''});
  else if(cur.done || cur.note) setTaskTrackerEntry(key,{snoozeUntil:''});
  else clearTaskTrackerEntry(key);
  renderPeoplePlanner();
}
function clearTaskTrackerState(key){
  clearTaskTrackerEntry(key);
  renderPeoplePlanner();
}
function editTaskNote(key){
  const cur=getTaskTrackerEntry(key);
  const next=prompt('Task note (saved locally):', cur.note||'');
  if(next===null) return;
  const note=String(next||'').trim().slice(0,500);
  if(!note && !cur.done && !cur.snoozeUntil){ clearTaskTrackerEntry(key); }
  else setTaskTrackerEntry(key,{note});
  renderPeoplePlanner();
}
function taskPriorityRank(p){ return p==='high'?3:p==='med'?2:1 }
function addTaskItem(tasks,item){
  if(!item || !item.title) return;
  const key=String(item.key||`${item.title}|${item.crop||''}|${item.source||''}`);
  if(tasks.some(t=>t.key===key)) return;
  tasks.push({
    key,
    priority:['high','med','low'].includes(item.priority)?item.priority:'med',
    title:String(item.title).slice(0,180),
    detail:String(item.detail||'').slice(0,420),
    source:String(item.source||'planner'),
    crop:String(item.crop||''),
    location:String(item.location||''),
    when:String(item.when||'')
  });
}
function taskMonthNamesForWindow(mode=TASK_ENGINE_STATE.windowMode){
  const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  if(mode==='today') return {months:[CAL_MONTH],label:'today',monthNames};
  if(mode==='month') return {months:[CAL_MONTH],label:'this month',monthNames};
  return {months:[CAL_MONTH,NEXT_MONTH].filter((m,i,a)=>a.indexOf(m)===i),label:'this week',monthNames};
}
function taskActionLabel(code){
  return ({i:'start indoors',t:'transplant outdoors',d:'direct sow',f:'fall sow / succession',h:'harvest'})[code]||code;
}
function recentObservationDayDelta(iso){
  if(!/^\d{4}-\d{2}-\d{2}$/.test(String(iso||''))) return 999;
  const now=new Date();
  const dt=new Date(`${iso}T00:00:00`);
  return Math.max(0,Math.floor((now-dt)/(1000*60*60*24)));
}
function cropMatchesTaskFocus(crop){
  const focus=getTaskEngineUiState().focus;
  if(focus==='all') return true;
  const sel=getSelectedCrop();
  if(focus==='selected') return sel?sel.name===crop.name:false;
  if(sel && (crop.name===sel.name || crop.cat===sel.cat)) return true;
  return true;
}
function generateTaskEngineItems(rankedRows=[],allocation=null){
  const tasks=[];
  const {months,label:windowLabel,monthNames}=taskMonthNamesForWindow(getTaskEngineUiState().windowMode);
  const selectedCrop=getSelectedCrop();
  const wx=weatherRiskFlags(selectedCrop||null);
  const analytics=getSeasonAnalyticsSnapshot();
  const rows=Array.isArray(rankedRows)?rankedRows:[];
  const allocRows=allocation?.rows||rows;
  const allocByCrop=new Map(allocRows.map(r=>[r.crop?.name,r]));
  const rowSuggestionMap=allocation?buildPlannerRowSuggestionMap(allocation):{};

  if(wx.avoidClayWork){
    addTaskItem(tasks,{priority:'high',source:'weather',when:windowLabel,title:'Avoid working wet clay soil',detail:'Delay digging/tilling and stay on paths until soil is workable to avoid compaction in heavy Kentucky red clay.'});
  }
  if(wx.mildewRisk || wx.blightRisk){
    const riskCrop=(selectedCrop && cropDiseaseRiskKeywordHit(getStructuredCrop(selectedCrop))) ? selectedCrop : rows.find(r=>cropDiseaseRiskKeywordHit(r.sc||getStructuredCrop(r.crop)))?.crop;
    addTaskItem(tasks,{priority:wx.blightRisk?'high':'med',source:'weather',crop:riskCrop?.name||'',when:windowLabel,title:'Increase disease scouting after rain/humidity',detail:`${weatherSnapshotLabel()}. Scout lower leaves, improve airflow, and avoid overhead watering while pressure is elevated${riskCrop?` (start with ${riskCrop.name})`:''}.`});
  }

  const actionCodes=['i','t','d','f','h'];
  for(const code of actionCodes){
    let count=0;
    for(const row of rows){
      if(count>=3) break;
      const crop=row.crop;
      if(!crop || !cropMatchesTaskFocus(crop)) continue;
      const acts=months.flatMap(m=>monthActionsForCrop(crop,m).map(a=>({month:m,code:a}))).filter(a=>a.code===code);
      if(!acts.length) continue;
      const uniqMonths=[...new Set(acts.map(a=>a.month))];
      const alloc=allocByCrop.get(crop.name)?.allocation||null;
      const rowSuggests=(rowSuggestionMap[crop.name]||[]).slice(0,2);
      const monthTxt=uniqMonths.map(m=>monthNames[m]).join(', ');
      const detailParts=[`${taskActionLabel(code)} in ${monthTxt}`, row.plan?.recPlants?`planner target ${row.plan.recPlants} plants`:''];
      if(alloc?.status==='partial' || alloc?.status==='defer') detailParts.push(`space status: ${plannerStatusLabel(alloc,row.plan)}`);
      if(rowSuggests.length) detailParts.push(`row suggestion: ${rowSuggests.map(s=>`${s.bedName} ${s.rowLabel}`).join(', ')}`);
      addTaskItem(tasks,{
        priority:(code==='t'||code==='d'||code==='f')?'med':(code==='h'?'low':'med'),
        source:'calendar',
        crop:crop.name,
        when:windowLabel,
        title:`${crop.name}: ${taskActionLabel(code)}`,
        detail:detailParts.filter(Boolean).join(' ¬∑ ')
      });
      count++;
    }
  }

  const recentObs=getRecentObservationLogs(12).filter(o=>recentObservationDayDelta(o.date)<=14);
  for(const o of recentObs.slice(0,4)){
    if(o.cropName && !cropMatchesTaskFocus({name:o.cropName,cat:(V.find(v=>v.name===o.cropName)?.cat||'')})) continue;
    const sig=observationIssueSignalsForText([o.symptom,o.notes].filter(Boolean).join(' '));
    const loc=formatObservationBedRowLabel(o);
    const urgency=sig.disease?'high':sig.pest?'med':'low';
    addTaskItem(tasks,{
      priority:urgency,
      source:'observation',
      crop:o.cropName||'',
      location:loc||'',
      when:`${recentObservationDayDelta(o.date)}d ago`,
      title:`Re-check observation: ${o.cropName||'crop'}${o.symptom?` (${o.symptom})`:''}`,
      detail:`Logged ${o.date}${loc?` at ${loc}`:''}. Re-scout, compare spread, and record what changed${o.photoRef?` (photo ref: ${o.photoRef})`:''}.`
    });
  }

  const recurring=analytics.recurringCropIssues||[];
  for(const c of recurring.slice(0,4)){
    const crop=V.find(v=>v.name===c.cropName);
    if(!crop || !cropMatchesTaskFocus(crop)) continue;
    if(!months.some(m=>hasMonthAction(crop,m))) continue;
    addTaskItem(tasks,{
      priority:c.issueLoad>=6?'high':'med',
      source:'analytics',
      crop:c.cropName,
      when:windowLabel,
      title:`Priority scouting: ${c.cropName}`,
      detail:`Recurring issue load ${c.issueLoad} (pest ${c.pestHits}, disease ${c.diseaseHits})${c.outcomeCount?` ¬∑ avg outcome ${round1(c.avgOutcome)}/4`:''}. Scout early this ${windowLabel}.`
    });
  }
  for(const h of (analytics.hotspots||[]).slice(0,3)){
    addTaskItem(tasks,{
      priority:h.diseaseHits>=2?'high':'med',
      source:'analytics',
      location:h.label,
      when:windowLabel,
      title:`Hotspot watch: ${h.label}`,
      detail:`${h.obsCount} observations with pest ${h.pestHits} / disease ${h.diseaseHits}. Sanitize debris, check drainage, and avoid repeating susceptible families in this spot.`
    });
  }

  if(allocation?.rows?.some(r=>r.allocation?.status==='partial' || r.allocation?.status==='defer')){
    const partialCt=allocation.rows.filter(r=>r.allocation?.status==='partial').length;
    const deferCt=allocation.rows.filter(r=>r.allocation?.status==='defer').length;
    addTaskItem(tasks,{
      priority:'med',
      source:'planner',
      when:windowLabel,
      title:'Resolve planner space conflicts',
      detail:`${partialCt} partial and ${deferCt} deferred crop plans. Review bed caps, drag crops between beds/rows, or reduce lower-priority crops.`
    });
  }

  return tasks
    .sort((a,b)=>taskPriorityRank(b.priority)-taskPriorityRank(a.priority) || String(a.source).localeCompare(String(b.source)) || a.title.localeCompare(b.title))
    .slice(0,14);
}
function renderTaskEngineList(rankedRows=[],allocation=null){
  syncTaskEngineControlsToUi();
  const host=document.getElementById('taskEngineList');
  if(!host) return;
  const today=todayIsoLocal();
  const tasks=generateTaskEngineItems(rankedRows,allocation).map(t=>({...t,_state:getTaskTrackerEntry(t.key)}));
  const visible=tasks.filter(t=>!(t._state.snoozeUntil && t._state.snoozeUntil>today) || t._state.done);
  const hiddenSnoozed=tasks.filter(t=>t._state.snoozeUntil && t._state.snoozeUntil>today && !t._state.done);
  if(!tasks.length){
    host.innerHTML='<div class="tx-empty">No tasks generated for the current filters. Try switching task focus to ‚ÄúAll crops‚Äù or adjusting planner filters.</div>';
    return;
  }
  if(!visible.length){
    host.innerHTML=`<div class="tx-empty">All current tasks are snoozed or completed.${hiddenSnoozed.length?` ${hiddenSnoozed.length} snoozed task${hiddenSnoozed.length===1?'':'s'} hidden until later.`:''}</div>`;
    return;
  }
  const summaryBits=[];
  const doneCt=tasks.filter(t=>t._state.done).length;
  if(doneCt) summaryBits.push(`${doneCt} done`);
  if(hiddenSnoozed.length) summaryBits.push(`${hiddenSnoozed.length} snoozed`);
  const summaryHtml=summaryBits.length?`<div class="tx-empty" style="padding:6px 8px">${summaryBits.join(' ¬∑ ')} (hidden items remain saved locally).</div>`:'';
  host.innerHTML=summaryHtml+visible.map(t=>{
    const st=t._state||{};
    const priLabel=t.priority==='high'?'HIGH':t.priority==='med'?'MED':'LOW';
    const meta=[t.source,t.crop,t.location,t.when,st.snoozeUntil?`snoozed to ${st.snoozeUntil}`:'',st.done?'done':''].filter(Boolean).map(x=>`<span>${escapeHtml(String(x))}</span>`).join('');
    const noteHtml=st.note?`<div style="margin-top:4px;color:#355335"><strong>Note:</strong> ${escapeHtml(st.note)}</div>`:'';
    const actions=`<div class="tx-actions">
      <button type="button" class="done" onclick="toggleTaskDone(${JSON.stringify(t.key).replace(/"/g,'&quot;')})">${st.done?'Undo':'Done'}</button>
      <button type="button" class="warn" onclick="snoozeTaskByDays(${JSON.stringify(t.key).replace(/"/g,'&quot;')},1)">+1d</button>
      <button type="button" class="warn" onclick="snoozeTaskByDays(${JSON.stringify(t.key).replace(/"/g,'&quot;')},7)">+1w</button>
      <button type="button" class="note" onclick="editTaskNote(${JSON.stringify(t.key).replace(/"/g,'&quot;')})">${st.note?'Edit Note':'Add Note'}</button>
      ${st.snoozeUntil?`<button type="button" onclick="clearTaskSnooze(${JSON.stringify(t.key).replace(/"/g,'&quot;')})">Clear Snooze</button>`:''}
      ${(st.note||st.done)?`<button type="button" onclick="clearTaskTrackerState(${JSON.stringify(t.key).replace(/"/g,'&quot;')})">Reset</button>`:''}
    </div>`;
    return `<div class="tx-item${st.done?' done':''}${st.snoozeUntil&&st.snoozeUntil>today?' snoozed':''}"><div class="tx-pri ${t.priority}">${priLabel}</div><div class="tx-body"><div class="tx-title">${escapeHtml(t.title)}</div><div>${escapeHtml(t.detail)}</div>${noteHtml}${meta?`<div class="tx-meta">${meta}</div>`:''}${actions}</div></div>`;
  }).join('');
}
function getTaskEngineSummaries(limit=8){
  const ranked=getPlannerRows({ignoreSearch:true});
  const alloc=allocatePlannerRows(ranked);
  const today=todayIsoLocal();
  return generateTaskEngineItems(ranked,alloc)
    .map(t=>({...t,_state:getTaskTrackerEntry(t.key)}))
    .filter(t=>!(t._state.snoozeUntil && t._state.snoozeUntil>today) || t._state.done)
    .slice(0,Math.max(0,limit|0)).map(t=>({
    priority:t.priority,
    title:t.title,
    crop:t.crop||'',
    location:t.location||'',
    source:t.source,
    when:t.when,
    done:Boolean(t._state?.done),
    snoozeUntil:t._state?.snoozeUntil||'',
    note:Boolean(t._state?.note)
  }));
}
function estimateCropPlan(crop,people=APP_STATE.peopleCount,mode=APP_STATE.plannerMode){
  const sc=getStructuredCrop(crop),hp=sc?.householdPlanning,sp=sc?.spacing;
  if(!hp)return null;
  const rawRange=mode==='preserve'?hp.preserveRange:(mode==='fresh'?hp.freshRange:[Math.round((hp.freshRange?.[0]||0)*1.2),Math.round((hp.freshRange?.[1]||0)*1.35)]);
  const multiplier=Math.max(1,Number(people)||1);
  const baseSuccess=Math.min(.95,Math.max(.45,hp.successFactor||.75));
  const latestOutcome=getLatestCropOutcome(crop.name);
  const analytics=getPlannerAnalyticsForCrop(crop,sc);
  const outcomeMultMap={poor:.86,fair:.93,good:1.02,great:1.08};
  const historySuccessMultiplier=latestOutcome?Math.max(.8,Math.min(1.15,Number(outcomeMultMap[latestOutcome.outcome]||1))):1;
  let analyticsSuccessMultiplier=1;
  const trend=analytics?.cropTrend||null;
  if(trend){
    if(trend.outcomeCount>=2){
      if(trend.avgOutcome<=2.1) analyticsSuccessMultiplier*=.92;
      else if(trend.avgOutcome<=2.5) analyticsSuccessMultiplier*=.96;
      else if(trend.avgOutcome>=3.4) analyticsSuccessMultiplier*=1.05;
      else if(trend.avgOutcome>=3.1) analyticsSuccessMultiplier*=1.02;
    }
    if(trend.issueLoad>=8) analyticsSuccessMultiplier*=.9;
    else if(trend.issueLoad>=4) analyticsSuccessMultiplier*=.95;
    else if(trend.outcomeCount>=2 && trend.issueLoad===0) analyticsSuccessMultiplier*=1.02;
  }
  analyticsSuccessMultiplier=Math.max(.84,Math.min(1.12,analyticsSuccessMultiplier));
  const success=Math.min(.95,Math.max(.45,baseSuccess*historySuccessMultiplier*analyticsSuccessMultiplier));
  const baseMin=Math.ceil((rawRange[0]*multiplier)/success);
  const baseMax=Math.ceil((rawRange[1]*multiplier)/success);
  const baseRec=Math.ceil(((rawRange[0]+rawRange[1])/2*multiplier)/success);
  const recipeBoost=getRecipeDemandBoost(crop);
  const minPlants=baseMin+(recipeBoost.plantsRounded?Math.max(0,Math.floor(recipeBoost.plantsRounded*.7)):0);
  const maxPlants=baseMax+recipeBoost.plantsRounded;
  const recPlants=baseRec+recipeBoost.plantsRounded;
  let areaSqFt=null;
  if(sp?.squareFootQty) areaSqFt=+(recPlants/Math.max(0.05,sp.squareFootQty)).toFixed(1);
  else if(sp?.inRowIn&&sp?.betweenRowsIn) areaSqFt=+((recPlants*(sp.inRowIn*sp.betweenRowsIn))/144).toFixed(1);
  const areaPerPlant=areaSqFt&&recPlants?+(areaSqFt/recPlants).toFixed(3):null;
  const historyAdjustment=latestOutcome?{applied:Math.abs(historySuccessMultiplier-1)>.01,outcome:latestOutcome.outcome,multiplier:+historySuccessMultiplier.toFixed(2),baseSuccess:+baseSuccess.toFixed(2),archiveYear:latestOutcome.archiveYear||null,archiveName:latestOutcome.archiveName||'',variety:latestOutcome.variety||'',yieldAmount:latestOutcome.yieldAmount||'',pestIssue:latestOutcome.pestIssue||'',diseaseIssue:latestOutcome.diseaseIssue||'',notes:latestOutcome.notes||''}:null;
  const analyticsAdjustment=trend?{
    applied:Math.abs(analyticsSuccessMultiplier-1)>.01,
    multiplier:+analyticsSuccessMultiplier.toFixed(2),
    outcomeCount:trend.outcomeCount||0,
    avgOutcome:Number.isFinite(trend.avgOutcome)?+trend.avgOutcome.toFixed(2):0,
    issueLoad:trend.issueLoad||0,
    obsCount:trend.obsCount||0,
    winners:analytics?.varietyWinners||[],
    watchlist:analytics?.varietyWatch||[],
    hotspots:analytics?.hotspotHits||[]
  }:null;
  return {minPlants,maxPlants,recPlants,areaSqFt,areaPerPlant,success,baseSuccess,rangeBase:rawRange,spacingText:fmtSpacing(sp),recipeBoost,baseRec,historyAdjustment,analyticsAdjustment};
}
function getRecipeTargetWeight(){
  const t=APP_STATE.recipeTargets||RECIPE_TARGET_DEFAULTS;
  return Object.values(t).reduce((a,b)=>a+(Number(b)||0),0);
}
function computePlannerPriorityScore(row){
  const {crop,plan,sc}=row;
  let score=0;
  const priorityMode=APP_STATE.plannerPriorityMode||'balanced';
  const hasRecipeBoost=plan.recipeBoost?.plantsRounded||0;
  if(priorityMode==='recipe_first') score+=hasRecipeBoost*8;
  if(priorityMode==='fresh_first') score+=Math.max(0,(plan.baseRec||0)-(plan.recipeBoost?.plantsRounded||0))*.35;
  if(priorityMode==='balanced') score+=hasRecipeBoost*5 + (plan.baseRec||0)*.2;
  if(APP_STATE.selectedCropIndex!=null && V[APP_STATE.selectedCropIndex]?.name===crop.name) score+=20;
  if(sc?.preservation?.bestUses?.includes('storage') || sc?.preservation?.bestUses?.includes('curing')) score+=3;
  if(crop.season==='cool' && (CAL_MONTH<=3 || CAL_MONTH>=7)) score+=2;
  if(crop.season==='warm' && CAL_MONTH>=3 && CAL_MONTH<=8) score+=2;
  if(plan.areaSqFt && plan.areaSqFt>0) score+=Math.max(0,6-Math.min(6,plan.areaSqFt/10));
  const aa=plan.analyticsAdjustment;
  if(aa?.winners?.length && (aa.winners[0]?.avgOutcome||0)>=3.2) score+=2;
  if(aa?.watchlist?.length && (aa.watchlist[0]?.count||0)>=2 && (aa.watchlist[0]?.avgOutcome||0)<=2.2) score-=1.5;
  if(aa?.hotspots?.length && aa.hotspots[0]?.score>=4) score-=.75;
  if(getRecipeTargetWeight()===0 && priorityMode==='recipe_first') score+=0;
  return +score.toFixed(2);
}
function allocatePlannerRows(rows){
  const beds=getActiveBeds();
  const bedsTotal=totalBedSqFt(beds);
  const manualCap=Math.max(0,Number(APP_STATE.bedSpaceLimit)||0);
  const hasBeds=beds.length>0;
  const budget=hasBeds?(manualCap>0?Math.min(manualCap,bedsTotal):bedsTotal):manualCap;
  if(!budget){
    return {rows:rows.map(r=>({...r,allocation:{status:'fit',assignedSqFt:r.plan.areaSqFt,assignedPlants:r.plan.recPlants,remainingAfter:null,bedAssignments:[]}})),budgetSqFt:0,usedSqFt:rows.reduce((s,r)=>s+(r.plan.areaSqFt||0),0),limited:false,beds:[],bedsTotalSqFt:bedsTotal,bedUsage:[]};
  }
  const bedPool=hasBeds
    ? beds.map(b=>({bed:{...b},remainingSqFt:bedSqFt(b),assignedSqFt:0}))
    : [{bed:{id:'budget-only',name:'Planner budget',lengthFt:0,widthFt:0,sun:'full',drainage:'average'},remainingSqFt:budget,assignedSqFt:0}];
  let remaining=budget;
  let used=0;
  const withAlloc=rows.map(r=>{
    const area=r.plan.areaSqFt;
    const areaPerPlant=r.plan.areaPerPlant||null;
    if(!area || area<=0 || !areaPerPlant) return {...r,allocation:{status:'n/a',assignedSqFt:null,assignedPlants:r.plan.recPlants,remainingAfter:+remaining.toFixed(1),bedAssignments:[]}};
    let plantsToPlace=r.plan.recPlants;
    const assignments=[];
    const sc=r.sc;
    const pref=getPlacementPref(r.crop.name);
    const lockedBedId=pref?.locked?pref.bedId:null;
    const rankedBeds=bedPool
      .map((p,idx)=>{
        let score=bedSuitabilityScoreForCrop(p.bed,r.crop,sc);
        if(pref?.bedId && p.bed.id===pref.bedId) score+=pref.locked?1000:120;
        return {p,idx,score};
      })
      .filter(item=>!lockedBedId || item.p.bed.id===lockedBedId)
      .sort((a,b)=>b.score-a.score||b.p.remainingSqFt-a.p.remainingSqFt||a.idx-b.idx);
    for(const item of rankedBeds){
      if(plantsToPlace<=0)break;
      if(item.p.remainingSqFt<Math.max(.25,areaPerPlant))continue;
      const maxPlantsHere=Math.floor(item.p.remainingSqFt/areaPerPlant);
      if(maxPlantsHere<=0)continue;
      const place=Math.min(plantsToPlace,maxPlantsHere);
      const placedSqFt=round1(place*areaPerPlant);
      item.p.remainingSqFt=round1(Math.max(0,item.p.remainingSqFt-placedSqFt));
      item.p.assignedSqFt=round1(item.p.assignedSqFt+placedSqFt);
      plantsToPlace-=place;
      assignments.push({bedId:item.p.bed.id,bedName:item.p.bed.name,plants:place,sqFt:placedSqFt,score:item.score});
    }
    const assignedPlants=assignments.reduce((s,a)=>s+a.plants,0);
    const assignedSqFt=round1(assignments.reduce((s,a)=>s+a.sqFt,0));
    used=round1(used+assignedSqFt);
    remaining=round1(Math.max(0,budget-used));
    if(assignedPlants>=r.plan.recPlants) return {...r,allocation:{status:'fit',assignedSqFt:assignedSqFt||area,assignedPlants:r.plan.recPlants,remainingAfter:remaining,bedAssignments:assignments,lockedToBed:Boolean(lockedBedId),preferredBedId:pref?.bedId||null}};
    if(assignedPlants>0) return {...r,allocation:{status:'partial',assignedSqFt:assignedSqFt,assignedPlants,remainingAfter:remaining,bedAssignments:assignments,lockedToBed:Boolean(lockedBedId),preferredBedId:pref?.bedId||null}};
    return {...r,allocation:{status:'defer',assignedSqFt:0,assignedPlants:0,remainingAfter:+remaining.toFixed(1),bedAssignments:[],lockedToBed:Boolean(lockedBedId),preferredBedId:pref?.bedId||null}};
  });
  const bedUsage=bedPool.filter(b=>b.assignedSqFt>0).map(b=>({name:b.bed.name,assignedSqFt:round1(b.assignedSqFt),remainingSqFt:round1(b.remainingSqFt),sqFt:bedSqFt(b.bed)}));
  return {rows:withAlloc,budgetSqFt:budget,usedSqFt:used,remainingSqFt:+remaining.toFixed(1),limited:true,beds,hasBeds,bedsTotalSqFt:bedsTotal,bedUsage,manualCapSqFt:manualCap||0};
}
function plannerStatusLabel(allocation,plan){
  if(!allocation) return 'N/A';
  if(allocation.status==='fit') return 'Fits';
  if(allocation.status==='n/a') return 'No area model';
  if(allocation.status==='partial') return `Partial (${allocation.assignedPlants}/${plan.recPlants})`;
  if(allocation.status==='defer') return 'Deferred';
  return allocation.status;
}
function cropColor(name){
  const s=String(name||'crop');
  let h=0;
  for(let i=0;i<s.length;i++) h=(h*31+s.charCodeAt(i))%360;
  return `hsl(${h} 60% 72%)`;
}
function contrastTextForHslFill(){ return '#173117' }
function proportionalCellCounts(items,totalCells){
  if(!items.length || totalCells<=0) return [];
  const totalVal=items.reduce((s,x)=>s+Math.max(0,Number(x.value)||0),0);
  if(totalVal<=0) return items.map(()=>0);
  const raw=items.map(x=>(Math.max(0,Number(x.value)||0)/totalVal)*totalCells);
  const base=raw.map(v=>Math.floor(v));
  let used=base.reduce((a,b)=>a+b,0);
  const order=raw.map((v,i)=>({i,frac:v-base[i]})).sort((a,b)=>b.frac-a.frac);
  for(let k=0; used<totalCells && k<order.length; k++, used++) base[order[k].i]+=1;
  return base;
}
function buildBedMapEntries(allocation,bed){
  const rows=allocation?.rows||[];
  const entries=[];
  rows.forEach(r=>{
    (r.allocation?.bedAssignments||[]).forEach(a=>{
      if(a.bedId!==bed.id)return;
      const pref=getPlacementPref(r.crop.name);
      entries.push({cropName:r.crop.name,plants:a.plants,sqFt:a.sqFt,color:cropColor(r.crop.name),status:r.allocation.status,locked:Boolean(pref?.locked&&pref?.bedId===bed.id),preferredBedId:pref?.bedId||null});
    });
  });
  return entries.sort((a,b)=>b.sqFt-a.sqFt||a.cropName.localeCompare(b.cropName));
}
function handleBedMapDragStart(evt){
  const cropName=evt?.currentTarget?.dataset?.crop||evt?.target?.dataset?.crop;
  if(!cropName)return;
  if(evt.dataTransfer){
    evt.dataTransfer.setData('text/plain',cropName);
    evt.dataTransfer.effectAllowed='move';
  }
  evt.currentTarget?.classList?.add('dragging');
}
function handleBedMapDragEnd(evt){
  evt.currentTarget?.classList?.remove('dragging');
  document.querySelectorAll('.pt-bed-map-grid.drop-target').forEach(el=>el.classList.remove('drop-target'));
}
function handleBedMapDragOver(evt){
  evt.preventDefault();
  if(evt.dataTransfer) evt.dataTransfer.dropEffect='move';
}
function handleBedMapDragEnter(evt){
  evt.preventDefault();
  evt.currentTarget?.classList?.add('drop-target');
}
function handleBedMapDragLeave(evt){
  if(!evt.currentTarget?.contains(evt.relatedTarget)) evt.currentTarget?.classList?.remove('drop-target');
}
function setCropPlacement(cropName,bedId,{lock=false,rowIndex=undefined}={}){
  if(!cropName||!bedId)return;
  const current=getPlacementPref(cropName);
  const patch={bedId,locked:lock?true:Boolean(current?.locked)};
  if(rowIndex!==undefined) patch.rowIndex=(rowIndex==null?null:Math.max(0,Number(rowIndex)||0));
  else if(current?.bedId!==bedId) patch.rowIndex=null;
  setPlacementPref(cropName,patch);
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function handleBedMapDrop(evt){
  evt.preventDefault();
  const bedId=evt?.currentTarget?.dataset?.bedId;
  const cropName=(evt.dataTransfer?.getData('text/plain')||'').trim();
  evt.currentTarget?.classList?.remove('drop-target');
  if(!cropName||!bedId)return;
  setCropPlacement(cropName,bedId,{lock:false,rowIndex:null});
}
function handleRowLaneDrop(evt){
  evt.preventDefault();
  const bedId=evt?.currentTarget?.dataset?.bedId;
  const rowIndex=parseInt(evt?.currentTarget?.dataset?.rowIndex||'',10);
  const cropName=(evt.dataTransfer?.getData('text/plain')||'').trim();
  evt.currentTarget?.classList?.remove('drop-target');
  if(!cropName||!bedId||!Number.isInteger(rowIndex))return;
  setCropPlacement(cropName,bedId,{lock:false,rowIndex});
}
function toggleCropPlacementLock(cropName,bedId){
  if(!cropName||!bedId)return;
  const cur=getPlacementPref(cropName);
  const nextLocked=!(cur?.locked && cur?.bedId===bedId);
  setPlacementPref(cropName,{bedId,locked:nextLocked,rowIndex:cur?.rowIndex??null});
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function clearCropPlacementPref(cropName){
  if(!cropName)return;
  removePlacementPref(cropName);
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function toggleCropPlacementLockBtn(btn){
  const cropName=btn?.dataset?.crop;
  const bedId=btn?.dataset?.bedId;
  toggleCropPlacementLock(cropName,bedId);
}
function clearCropPlacementPrefBtn(btn){
  const cropName=btn?.dataset?.crop;
  clearCropPlacementPref(cropName);
}
function renderRowSnapMapHtml(allocation,bed){
  const snap=buildBedRowSnapLayout(allocation,bed);
  if(!snap) return '';
  const s=snap.settings;
  const head=`Rows mode ¬∑ target spacing ${s.rowSpacingIn}" ¬∑ actual ${s.actualRowSpacingIn}" ¬∑ ${s.rowCount} rows${s.trellisSide!=='none'?` ¬∑ trellis ${s.trellisSide}`:''}`;
  const lanesHtml=snap.lanes.map(lane=>{
    const segs=lane.segments.map(seg=>{
      const left=((seg.startFt/snap.rowLenFt)*100).toFixed(2);
      const width=Math.max(1.2,(seg.lenFt/snap.rowLenFt)*100).toFixed(2);
      const short=escapeHtml(seg.cropName.split(' ').slice(0,2).join(' '));
      return `<div class="pt-rowlane-seg${seg.tight?' tight':''}" draggable="true" data-crop="${escapeHtml(seg.cropName)}" ondragstart="handleBedMapDragStart(event)" ondragend="handleBedMapDragEnd(event)" style="left:${left}%;width:${width}%;background:${seg.color}" title="${escapeHtml(seg.cropName)} ¬∑ ~${seg.lenFt.toFixed(1)} row-ft ¬∑ spacing rows ${seg.betweenRowsIn}${seg.preferredRow?' ¬∑ preferred row':''}${seg.rowRiskHit?' ¬∑ row hotspot history present':''}\"><span>${short}${seg.preferredRow?'*':''}</span></div>`;
    }).join('');
    return `<div>
      <div class="pt-rowlane">
        <div class="pt-rowlane-label">${escapeHtml(lane.label)}${lane.isTrellis?` <span class="trellis">T</span>`:''}${lane.rowHotspot?` <span class="risk" title="Row hotspot history: ${escapeHtml(lane.rowHint||'')}">!risk</span>`:''}
          <span class="pt-rowlane-prev"><select data-bed-id="${escapeHtml(bed.id)}" data-row-index="${lane.index}" onchange="handleRowHistoryChange(this)">${Object.entries(ROTATION_FAMILY_LABELS).map(([k,label])=>`<option value="${escapeHtml(k)}"${lane.prevFamily===k?' selected':''}>${escapeHtml(label)}</option>`).join('')}</select></span>
        </div>
        <div class="pt-rowlane-track${lane.isTrellis?' trellis':''}" data-bed-id="${escapeHtml(bed.id)}" data-row-index="${lane.index}" ondragover="handleBedMapDragOver(event)" ondragenter="handleBedMapDragEnter(event)" ondragleave="handleBedMapDragLeave(event)" ondrop="handleRowLaneDrop(event)" title="${lane.isTrellis?'Trellis-preferred row. ':''}${lane.rowHotspot?`Historical row hotspot: ${lane.rowHint}. `:''}Drop a crop here to set preferred row">${segs}</div>
      </div>
      ${lane.analyticsHint?`<div class="pt-rowlane-hint">${escapeHtml(lane.analyticsHint)}</div>`:''}
      ${lane.rotationWarning?`<div class="pt-rowlane-warning">${escapeHtml(lane.rotationWarning)}</div>`:''}
      ${lane.overflowFt?`<div class="pt-rowlane-overflow">Overflow: ~${lane.overflowFt.toFixed(1)} row-ft (bed too tight for row spacing / airflow at current allocation)</div>`:''}
    </div>`;
  }).join('');
  return `<div class="pt-bed-rowmap"><div class="pt-bed-rowmap-head">${head}</div>${lanesHtml}</div>`;
}
function collectRotationWarnings(allocation){
  const warnings=[];
  for(const bed of (allocation?.beds||[])){
    const snap=buildBedRowSnapLayout(allocation,bed);
    if(!snap) continue;
    snap.lanes.forEach(lane=>{
      if(lane.rotationWarning){
        warnings.push({bed:bed.name,row:`R${lane.index+1}`,warning:lane.rotationWarning,prevFamily:lane.prevFamily,currentFamily:lane.dominantFamily});
      }
    });
  }
  return warnings;
}
function buildPlannerRowSuggestionMap(allocation){
  const out={};
  for(const bed of (allocation?.beds||[])){
    const snap=buildBedRowSnapLayout(allocation,bed);
    if(!snap) continue;
    for(const item of (snap.rowAssignments||[])){
      if(!item?.crop?.name || !Number.isInteger(item.suggestedRowIndex)) continue;
      if(!out[item.crop.name]) out[item.crop.name]=[];
      out[item.crop.name].push({bedId:bed.id,bedName:bed.name,rowIndex:item.suggestedRowIndex,rowLabel:`R${item.suggestedRowIndex+1}`,reason:item.suggestedRowReason||''});
    }
  }
  return out;
}
function renderPlannerBedMaps(allocation){
  const host=document.getElementById('plannerBedMaps');
  if(!host)return;
  if(!allocation?.hasBeds){
    host.innerHTML='';
    return;
  }
  const beds=allocation.beds||[];
  host.innerHTML=beds.map(bed=>{
    const bedSettings=getBedRowSettings(bed);
    const bedArea=Math.max(1,Math.round(bedSqFt(bed)));
    const rows=Math.max(1,Math.round(Number(bed.widthFt)||1));
    const cols=Math.max(1,Math.ceil(bedArea/rows));
    const entries=buildBedMapEntries(allocation,bed);
    const counts=proportionalCellCounts(entries.map(e=>({value:e.sqFt})),Math.min(240,bedArea));
    const cells=[];
    entries.forEach((e,idx)=>{ for(let i=0;i<(counts[idx]||0);i++) cells.push(e); });
    while(cells.length<Math.min(240,bedArea)) cells.push(null);
    const gridStyle=`grid-template-columns:repeat(${cols}, minmax(8px,1fr));`;
    const usedSqFt=round1(entries.reduce((s,e)=>s+e.sqFt,0));
    const legends=entries.map(e=>{
      const pref=getPlacementPref(e.cropName);
      const lockedHere=Boolean(pref?.locked && pref?.bedId===bed.id);
      const preferredElsewhere=pref?.bedId && pref.bedId!==bed.id;
      const rowPrefHere=(pref?.bedId===bed.id && Number.isInteger(pref?.rowIndex))?` ¬∑ row R${pref.rowIndex+1}`:'';
      return `<span class="pt-bed-legend-item ${lockedHere?'locked':''}" draggable="true" data-crop="${escapeHtml(e.cropName)}" ondragstart="handleBedMapDragStart(event)" ondragend="handleBedMapDragEnd(event)" title="Drag to another bed to move preference">
        <span class="pt-bed-legend-swatch" style="background:${e.color}"></span>${escapeHtml(e.cropName)} ¬∑ ${e.plants} plants ¬∑ ${e.sqFt.toFixed(1)} sq ft${preferredElsewhere?' ¬∑ split':''}${rowPrefHere}
        <button type="button" data-crop="${escapeHtml(e.cropName)}" data-bed-id="${escapeHtml(bed.id)}" onclick="toggleCropPlacementLockBtn(this)" title="${lockedHere?'Unlock placement':'Lock to this bed'}">${lockedHere?'Unlock':'Lock'}</button>
        <button type="button" data-crop="${escapeHtml(e.cropName)}" onclick="clearCropPlacementPrefBtn(this)" title="Clear saved preference">Clear</button>
      </span>`;
    }).join('');
    return `<div class="pt-bed-map-card">
      <div class="pt-bed-map-head">
        <b>${escapeHtml(bed.name)}</b>
        <div class="pt-bed-map-meta">${bed.lengthFt}x${bed.widthFt} ft ¬∑ ${bedSqFt(bed).toFixed(1)} sq ft ¬∑ ${bedSettings.mode} ¬∑ sun ${escapeHtml(bed.sun)} ¬∑ drainage ${escapeHtml(bed.drainage)} ¬∑ used ${usedSqFt.toFixed(1)} sq ft</div>
      </div>
      ${renderRowSnapMapHtml(allocation,bed)}
      <div class="pt-bed-map-grid" data-bed-id="${escapeHtml(bed.id)}" ondragover="handleBedMapDragOver(event)" ondragenter="handleBedMapDragEnter(event)" ondragleave="handleBedMapDragLeave(event)" ondrop="handleBedMapDrop(event)" style="${gridStyle}" title="${escapeHtml(bed.name)} layout map (approx by area) ¬∑ drop crop blocks here to move">
        ${cells.map((cell,i)=>{
          if(!cell) return `<div class="pt-bed-cell empty" title="Open space"></div>`;
          const label=i===0 || (i>0 && cells[i-1]?.cropName!==cell.cropName)?escapeHtml(cell.cropName.split(' ').slice(0,2).join(' ')):'';
          return `<div class="pt-bed-cell${cell.locked?' locked':''}" draggable="true" data-crop="${escapeHtml(cell.cropName)}" ondragstart="handleBedMapDragStart(event)" ondragend="handleBedMapDragEnd(event)" style="background:${cell.color}" title="${escapeHtml(cell.cropName)} (${cell.plants} plants, ${cell.sqFt.toFixed(1)} sq ft approx)${cell.locked?' ¬∑ locked to this bed':''}"><span style="color:${contrastTextForHslFill()}">${label}</span></div>`;
        }).join('')}
      </div>
      ${legends?`<div class="pt-bed-legend">${legends}</div>`:`<div class="pt-bed-empty">No crop blocks assigned yet for this bed.</div>`}
    </div>`;
  }).join('');
}
function getPlannerAllocationForCrop(cropName){
  if(!cropName) return null;
  const rows=allocatePlannerRows(getPlannerRows({ignoreSearch:true})).rows;
  return rows.find(r=>r.crop?.name===cropName)||null;
}
function getPlannerRows(opts={}){
  const q=opts.ignoreSearch?'':(APP_STATE.plannerSearch||'').toLowerCase();
  return V.map(crop=>{
    const plan=estimateCropPlan(crop);
    if(!plan)return null;
    if(q && !crop.name.toLowerCase().includes(q) && !crop.cat.toLowerCase().includes(q)) return null;
    const sc=getStructuredCrop(crop);
    const row={crop,plan,sc};
    row.priorityScore=computePlannerPriorityScore(row);
    return row;
  }).filter(Boolean).sort((a,b)=>(b.priorityScore||0)-(a.priorityScore||0)||a.crop.cat.localeCompare(b.crop.cat)||a.crop.name.localeCompare(b.crop.name));
}
function renderPlannerBedAllocationSummary(allocation){
  const el=document.getElementById('plannerBedAllocSummary');
  if(!el)return;
  if(!allocation?.hasBeds){
    el.innerHTML='Bed-level allocation is using the planner budget only. Add named beds above to allocate crops to actual beds.';
    return;
  }
  const usage=(allocation.bedUsage||[]);
  if(!usage.length){
    el.innerHTML=`Beds are configured (${(allocation.bedsTotalSqFt||0).toFixed(1)} sq ft total), but no crop area has been allocated yet.`;
    return;
  }
  const rotationWarns=collectRotationWarnings(allocation);
  el.innerHTML=`Bed allocation: ${usage.map(b=>`<code>${escapeHtml(b.name)}</code> ${b.assignedSqFt.toFixed(1)}/${b.sqFt.toFixed(1)} sq ft`).join(' ¬∑ ')}${allocation.remainingSqFt!=null?` ¬∑ Remaining pool: <strong>${allocation.remainingSqFt.toFixed(1)} sq ft</strong>`:''}${rotationWarns.length?` ¬∑ <span class="warn">${rotationWarns.length} rotation warning${rotationWarns.length>1?'s':''}</span>`:''}`;
}
function renderPeoplePlanner(){
  const body=document.getElementById('plannerTableBody'),sum=document.getElementById('plannerSummary');
  if(!body||!sum)return;
  const rankedRows=getPlannerRows();
  renderRecipeDemandSummary();
  renderWeatherAlerts();
  updateBedsSummary();
  if(!rankedRows.length){
    body.innerHTML='<tr><td colspan="6">No crops match the current filter.</td></tr>';
    sum.textContent='No planner rows matched your filter.';
    const emptyAlloc={rows:[],bedUsage:[],hasBeds:getActiveBeds().length>0,beds:getActiveBeds(),budgetSqFt:0,usedSqFt:0,remainingSqFt:0,bedsTotalSqFt:totalBedSqFt()};
    renderTaskEngineList([],emptyAlloc);
    renderPlannerBedAllocationSummary(emptyAlloc);
    renderPlannerBedMaps(emptyAlloc);
    return;
  }
  const allocation=allocatePlannerRows(rankedRows);
  const rows=allocation.rows;
  renderTaskEngineList(rankedRows,allocation);
  const rowSuggestionMap=buildPlannerRowSuggestionMap(allocation);
  let totalSqFt=0,totalRecipePlants=0;
  const selected=getSelectedCrop();
  body.innerHTML=rows.map(({crop,plan,sc,priorityScore,allocation:alloc})=>{
    totalSqFt+=plan.areaSqFt||0;
    totalRecipePlants+=plan.recipeBoost?.plantsRounded||0;
    const note=[`Range ${plan.minPlants}-${plan.maxPlants}`,`Success ${(plan.success*100).toFixed(0)}%`];
    if(plan.historyAdjustment?.applied){
      note.push(`History ${plan.historyAdjustment.outcome} (${plan.historyAdjustment.archiveYear||'last'}): ${Math.round((plan.baseSuccess||plan.success)*100)}%‚Üí${Math.round(plan.success*100)}%`);
      if(plan.historyAdjustment.variety) note.push(`Var winner: ${plan.historyAdjustment.variety}`);
    }
    if(plan.analyticsAdjustment?.applied){
      note.push(`Analytics ${plan.analyticsAdjustment.outcomeCount} seasons: avg ${round1(plan.analyticsAdjustment.avgOutcome)}/4, issue load ${plan.analyticsAdjustment.issueLoad} (${Math.round((plan.analyticsAdjustment.multiplier||1)*100)}% factor)`);
    }
    if(plan.analyticsAdjustment?.winners?.length){
      const win=plan.analyticsAdjustment.winners[0];
      note.push(`Top variety trend: ${win.variety} (${round1(win.avgOutcome)}/4)`);
    }
    if(plan.analyticsAdjustment?.watchlist?.length){
      const bad=plan.analyticsAdjustment.watchlist[0];
      if((bad.count||0)>=2 && (bad.avgOutcome||0)<=2.4) note.push(`Watchlist variety: ${bad.variety} (${round1(bad.avgOutcome)}/4)`);
    }
    if(plan.analyticsAdjustment?.hotspots?.length){
      note.push(`Hotspots: ${plan.analyticsAdjustment.hotspots.slice(0,2).map(h=>`${h.label}`).join(', ')}`);
    }
    if(plan.recipeBoost?.plantsRounded)note.push(`Recipe +${plan.recipeBoost.plantsRounded}${plan.recipeBoost.mode==='profile'?' (profile)':''}`);
    if(sc.recipeProfiles?.length) note.push(`Recipes: ${sc.recipeProfiles.map(p=>p.recipe).join(', ')}`);
    const picks=getRecipeVarietySuggestions(crop);
    if(picks.length) note.push(`Varieties: ${picks.map(p=>`${p.name} [${p.tags.join('/')}]`).slice(0,2).join('; ')}`);
    if(alloc?.lockedToBed && alloc?.preferredBedId) note.push(`Locked placement`);
    note.push(`Priority ${selected?.name===crop.name?'selected + ':''}${Number(priorityScore||0).toFixed(1)}`);
    if(alloc?.bedAssignments?.length){
      const analytics=getSeasonAnalyticsSnapshot();
      const bedNotes=alloc.bedAssignments.map(a=>{
        const bed=(allocation.beds||[]).find(b=>b.id===a.bedId) || {name:a.bedName};
        const risk=bedAnalyticsRiskForCrop(bed,crop,sc,analytics);
        return `${a.bedName} (${a.plants})${risk.severity>=4?' !risk':''}`;
      });
      note.push(`Beds: ${bedNotes.join(', ')}`);
    }
    const rowSugs=(rowSuggestionMap[crop.name]||[]).filter(s=>alloc?.bedAssignments?.some(a=>a.bedId===s.bedId)).slice(0,3);
    if(rowSugs.length){
      note.push(`Rows: ${rowSugs.map(s=>`${s.bedName} ${s.rowLabel}${s.reason?` (${s.reason})`:''}`).join(', ')}`);
    }
    const plantsCell=alloc?.status==='partial'?`<strong>${plan.recPlants}</strong><br><span style="color:#6b7b6b;font-size:.9em">fit ${alloc.assignedPlants}</span>`:`<strong>${plan.recPlants}</strong>`;
    const sqFtCell=alloc?.status==='partial'?`${plan.areaSqFt??'N/A'}<br><span style="color:#6b7b6b;font-size:.9em">fit ${alloc.assignedSqFt}</span>`:(plan.areaSqFt??'N/A');
    return `<tr><td><div><strong>${crop.name}</strong></div><div class="pt-chip">${crop.cat}</div></td><td>${plan.spacingText}</td><td>${plantsCell}</td><td>${sqFtCell}</td><td>${plannerStatusLabel(alloc,plan)}</td><td>${note.filter(Boolean).join(' ¬∑ ')}</td></tr>`;
  }).join('');
  renderPlannerBedAllocationSummary(allocation);
  renderPlannerBedMaps(allocation);
  const limitTxt=APP_STATE.bedSpaceLimit>0
    ? ` ¬∑ Manual cap: <strong>${APP_STATE.bedSpaceLimit.toFixed(0)} sq ft</strong> ¬∑ Fit: <strong>${allocation.usedSqFt?.toFixed?allocation.usedSqFt.toFixed(1):allocation.usedSqFt} sq ft</strong>${allocation.remainingSqFt!=null?` ¬∑ Remaining: <strong>${allocation.remainingSqFt.toFixed(1)} sq ft</strong>`:''}`
    : '';
  const bedsTxt=allocation.hasBeds?` ¬∑ Beds total: <strong>${(allocation.bedsTotalSqFt||0).toFixed(1)} sq ft</strong>`:'';
  const analytics=getSeasonAnalyticsSnapshot();
  const analyticsTxt=(analytics.archiveCount||analytics.observationCount)?` ¬∑ Analytics: <strong>${analytics.archiveCount}</strong> archives / <strong>${analytics.observationCount}</strong> observations`:'';
  sum.innerHTML=`Planner rows: <strong>${rows.length}</strong> ¬∑ Household: <strong>${APP_STATE.peopleCount}</strong> ¬∑ Goal: <strong>${APP_STATE.plannerMode}</strong> ¬∑ Space priority: <strong>${(APP_STATE.plannerPriorityMode||'balanced').replace('_',' ')}</strong> ¬∑ Recipe boost: <strong>+${totalRecipePlants}</strong> plants ¬∑ Estimated bed footprint: <strong>${totalSqFt.toFixed(1)} sq ft</strong>${bedsTxt}${limitTxt}${analyticsTxt}`;
}
function handlePlannerControls(){
  const people=document.getElementById('peopleCountInput');
  const mode=document.getElementById('plannerMode');
  const bedSpace=document.getElementById('bedSpaceLimitInput');
  const priority=document.getElementById('plannerPriorityMode');
  const search=document.getElementById('plannerSearch');
  if(people)APP_STATE.peopleCount=Math.max(1,Math.min(20,Number(people.value)||2));
  if(mode)APP_STATE.plannerMode=mode.value||'balanced';
  if(bedSpace)APP_STATE.bedSpaceLimit=Math.max(0,Math.min(5000,Number(bedSpace.value)||0));
  if(priority)APP_STATE.plannerPriorityMode=priority.value||'balanced';
  if(search)APP_STATE.plannerSearch=search.value||'';
  APP_STATE.recipeTargets=getRecipeTargetsFromUi();
  APP_STATE.weather=getWeatherFromUi();
  updateBedsFromUi();
  persistBedAndWeatherState();
  renderPeoplePlanner();
  renderSelectedStructuredPanel();
  renderAssistantPanel();
}
function buildStructuredPanelHtml(crop){
  const sc=getStructuredCrop(crop),plan=estimateCropPlan(crop);
  if(!sc)return '';
  const pests=(sc.ipm?.commonPests||[]).slice(0,5).map(p=>`<span>${p}</span>`).join('');
  const diseases=(sc.ipm?.commonDiseases||[]).slice(0,5).map(d=>`<span>${d}</span>`).join('');
  const ipmIssues=(sc.ipm?.issueRecords||[]).slice(0,4).map(issue=>{
    const symptom=(issue.symptoms||[])[0]||'';
    const scout=(issue.scout||[])[0]||'';
    const threshold=issue.actionThreshold||'';
    return `<div class="tdx-item"><b>IPM ${escapeHtml(issue.type)}</b>${escapeHtml(issue.label)}${symptom?`<br><span style="color:#6b7b6b">Symptom: ${escapeHtml(symptom)}</span>`:''}${scout?`<br><span style="color:#6b7b6b">Scout: ${escapeHtml(scout)}</span>`:''}${threshold?`<br><span style="color:#92400e">Threshold: ${escapeHtml(threshold)}</span>`:''}</div>`;
  }).join('');
  const preservation=(sc.preservation?.bestUses||[]).slice(0,6).map(u=>`<span>${u}</span>`).join('');
  const varietyPicks=getRecipeVarietySuggestions(crop).map(v=>`<div class="tdx-item"><b>Recipe Variety Pick</b>${escapeHtml(v.name)}<br><span style="color:#6b7b6b">${escapeHtml(v.tags.join(', '))}${v.roles?.length?` ¬∑ ${escapeHtml(v.roles.join(', '))}`:''}</span></div>`).join('');
  const recipeProfiles=(sc.recipeProfiles||[]).slice(0,4).map(p=>{
    const pref=(p.preferredVarieties||[]).slice(0,2).join(' / ');
    return `<div class="tdx-item"><b>${escapeHtml(p.recipe)} Profile</b>~1 plant / ${escapeHtml(String(p.unitsPerPlant))} target units${pref?`<br><span style="color:#6b7b6b">Prefer: ${escapeHtml(pref)}</span>`:''}</div>`;
  }).join('');
  const clay=(sc.notes?.clayTips||[]).map(t=>`<div class="tdx-item"><b>Clay Note</b>${t}</div>`).join('');
  const weather=weatherRiskFlags(crop);
  const weatherBox=weather.messages.length?`<div class="tdx-item"><b>Weather / Clay Alert</b>${escapeHtml(weather.messages[0])}</div>`:'';
  const latestObs=getRecentObservationLogs(1,crop.name)[0]||null;
  const obsLoc=latestObs?formatObservationBedRowLabel(latestObs):'';
  const obsBox=latestObs?`<div class="tdx-item"><b>Latest Observation</b>${escapeHtml(latestObs.date)}${obsLoc?` ¬∑ ${escapeHtml(obsLoc)}`:''}${latestObs.symptom?` ¬∑ ${escapeHtml(latestObs.symptom)}`:''}${latestObs.photoRef?`<br><span style="color:#6b7b6b">Photo: ${escapeHtml(latestObs.photoRef)}</span>`:''}</div>`:'';
  const plannerBox=plan?`<div class="tdx-item"><b>People Planner (${APP_STATE.peopleCount}, ${APP_STATE.plannerMode})</b>${plan.recPlants} plants (~${plan.areaSqFt??'N/A'} sq ft)<br><span style="color:#6b7b6b">Range ${plan.minPlants}-${plan.maxPlants}${plan.recipeBoost?.plantsRounded?` ¬∑ Recipe +${plan.recipeBoost.plantsRounded}`:''}</span></div>`:'';
  const symptomChips=getSymptomLookupChips(sc,10);
  const symptomLookup=(sc.ipm?.issueRecords||[]).length?`<div class="symx"><div class="symx-head">Symptom Lookup (MVP)</div><div class="symx-row"><input id="symptomLookupInput" type="text" placeholder="Describe what you see (e.g., yellow spots lower leaves)" onkeydown="if(event.key==='Enter'){runSymptomLookup()}"><button type="button" onclick="runSymptomLookup()">Analyze</button><button type="button" onclick="runSymptomLookup('')">Top Issues</button></div>${symptomChips.length?`<div class="symx-chips">${symptomChips.map(s=>`<button type="button" onclick="useSymptomLookupChip(${JSON.stringify(s).replace(/"/g,'&quot;')})">${escapeHtml(s)}</button>`).join('')}</div>`:''}<div id="symptomLookupResult" class="symx-result">${buildSymptomLookupResultHtml(crop,'')}</div></div>`:'';
  return `<div class="tdx"><h4>Structured Planning & IPM (MVP)</h4><div class="tdx-grid"><div class="tdx-item"><b>Crop ID</b>${sc.id}</div><div class="tdx-item"><b>Spacing</b>${fmtSpacing(sc.spacing)}</div><div class="tdx-item"><b>Yield Model</b>${sc.yield?`${sc.yield.unit} (${fmtRange(sc.yield.perPlantRange,'/plant')})`:'N/A'}</div><div class="tdx-item"><b>Site</b>${sc.site?`${sc.site.sun||'N/A'} sun ¬∑ pH ${fmtPhRange(sc.site.phRange)} ¬∑ ${sc.site.drainage||'drainage N/A'}`:'N/A'}</div>${plannerBox}${weatherBox}${obsBox}${recipeProfiles}${ipmIssues}${varietyPicks}${clay}</div>${symptomLookup}${preservation?`<div class="tdx-tags" title="Preservation uses">${preservation}</div>`:''}${pests?`<div class="tdx-tags" title="Common pests">${pests}</div>`:''}${diseases?`<div class="tdx-tags" title="Common diseases">${diseases}</div>`:''}</div>`;
}
function getSelectedCrop(){return Number.isInteger(APP_STATE.selectedCropIndex)?V[APP_STATE.selectedCropIndex]||null:null}
function getAssistantConfigFromUi(){
  return {
    mode:document.getElementById('mgMode')?.value||'local',
    proxyEndpoint:(document.getElementById('mgProxyEndpoint')?.value||'').trim()||ASSISTANT_CONFIG_DEFAULTS.proxyEndpoint,
    proxyToken:(document.getElementById('mgProxyToken')?.value||'').trim(),
    endpoint:(document.getElementById('mgEndpoint')?.value||'').trim(),
    model:(document.getElementById('mgModel')?.value||'').trim()||ASSISTANT_CONFIG_DEFAULTS.model,
    apiKey:(document.getElementById('mgApiKey')?.value||'').trim()
  };
}
function syncAssistantConfigToUi(){
  const c=APP_STATE.assistantConfig||ASSISTANT_CONFIG_DEFAULTS;
  const mode=document.getElementById('mgMode'), proxyEndpoint=document.getElementById('mgProxyEndpoint'), proxyToken=document.getElementById('mgProxyToken'), endpoint=document.getElementById('mgEndpoint'), model=document.getElementById('mgModel'), key=document.getElementById('mgApiKey');
  if(mode)mode.value=c.mode||'local';
  if(proxyEndpoint)proxyEndpoint.value=c.proxyEndpoint||ASSISTANT_CONFIG_DEFAULTS.proxyEndpoint||'';
  if(proxyToken)proxyToken.value=c.proxyToken||'';
  if(endpoint)endpoint.value=c.endpoint||'';
  if(model)model.value=c.model||ASSISTANT_CONFIG_DEFAULTS.model;
  if(key)key.value=c.apiKey||'';
}
function assistantConfigSummary(){
  const c=APP_STATE.assistantConfig||ASSISTANT_CONFIG_DEFAULTS;
  if(c.mode==='local') return 'Using local fallback responses.';
  if(c.mode==='proxy'){
    if(!c.proxyEndpoint) return 'Proxy mode selected, but proxy URL is missing. Falling back locally.';
    return `Proxy mode ready (${c.model||ASSISTANT_CONFIG_DEFAULTS.model}) ‚Üí ${c.proxyEndpoint}`;
  }
  if(!c.endpoint||!c.model||!c.apiKey) return 'API mode selected, but endpoint/model/key are incomplete. Falling back locally.';
  return `API mode ready (${c.model}) ‚Üí ${c.endpoint}`;
}
function setAssistantStatus(msg){
  const el=document.getElementById('mgStatus');
  if(el)el.textContent=msg;
}
function handleAssistantConfigChange(){
  APP_STATE.assistantConfig={...APP_STATE.assistantConfig,...getAssistantConfigFromUi()};
  setAssistantStatus(assistantConfigSummary());
  renderAssistantPanel();
}
function loadAssistantConfig(){
  const raw=safeLocalStorageGet(LS_KEYS.assistantCfg);
  if(!raw){APP_STATE.assistantConfig={...ASSISTANT_CONFIG_DEFAULTS};syncAssistantConfigToUi();setAssistantStatus(assistantConfigSummary());return;}
  try{
    const parsed=JSON.parse(raw);
    APP_STATE.assistantConfig={...ASSISTANT_CONFIG_DEFAULTS,...parsed};
  }catch{
    APP_STATE.assistantConfig={...ASSISTANT_CONFIG_DEFAULTS};
  }
  syncAssistantConfigToUi();
  setAssistantStatus(assistantConfigSummary());
}
function saveAssistantConfig(){
  APP_STATE.assistantConfig={...APP_STATE.assistantConfig,...getAssistantConfigFromUi()};
  safeLocalStorageSet(LS_KEYS.assistantCfg,JSON.stringify(APP_STATE.assistantConfig));
  setAssistantStatus(`Saved AI settings. ${assistantConfigSummary()}`);
  renderAssistantPanel();
}
function clearAssistantConfig(){
  APP_STATE.assistantConfig={...ASSISTANT_CONFIG_DEFAULTS};
  safeLocalStorageRemove(LS_KEYS.assistantCfg);
  syncAssistantConfigToUi();
  setAssistantStatus('Cleared AI settings. Using local fallback responses.');
  renderAssistantPanel();
}
function buildAssistantSystemPrompt(){
  return [
    'You are a master gardener assistant for one garden in Shepherdsville, Kentucky (zip 40165, zone 6b/7a).',
    'Use the provided garden context first: selected crop, planner recommendations, recipe targets, bed layout/allocation, weather snapshot, and soil profile (heavy Kentucky red clay).',
    'Give practical KY-first advice. If uncertain, say what is missing.',
    'Separate what comes from the garden data vs general guidance.',
    'For canning/pickling safety, advise using tested recipes and do not improvise unsafe preservation instructions.'
  ].join(' ');
}
async function callRemoteMasterGardener(question,context){
  const cfg=APP_STATE.assistantConfig||ASSISTANT_CONFIG_DEFAULTS;
  if(cfg.mode!=='api' || !cfg.endpoint || !cfg.apiKey) throw new Error('API mode not configured');
  const payload={
    model:cfg.model||ASSISTANT_CONFIG_DEFAULTS.model,
    messages:[
      {role:'system',content:buildAssistantSystemPrompt()},
      {role:'user',content:`Question: ${question}\n\nGarden context JSON:\n${JSON.stringify(context,null,2)}`}
    ],
    temperature:0.3
  };
  const res=await fetch(cfg.endpoint,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${cfg.apiKey}`},
    body:JSON.stringify(payload)
  });
  if(!res.ok){
    const txt=await res.text().catch(()=>'');
    throw new Error(`Remote AI error ${res.status}: ${txt.slice(0,200)}`);
  }
  const data=await res.json();
  const content=data?.choices?.[0]?.message?.content ?? data?.output_text ?? data?.output?.[0]?.content?.[0]?.text;
  if(!content) throw new Error('Remote AI response did not contain text content');
  return {text:String(content),source:'remote'};
}
async function callProxyMasterGardener(question,context){
  const cfg=APP_STATE.assistantConfig||ASSISTANT_CONFIG_DEFAULTS;
  if(cfg.mode!=='proxy' || !cfg.proxyEndpoint) throw new Error('Proxy mode not configured');
  const res=await fetch(cfg.proxyEndpoint,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      ...(cfg.proxyToken?{'X-Garden-Proxy-Token':cfg.proxyToken}:{})
    },
    body:JSON.stringify({
      question,
      context,
      model:cfg.model||ASSISTANT_CONFIG_DEFAULTS.model,
      systemPrompt:buildAssistantSystemPrompt()
    })
  });
  if(!res.ok){
    const txt=await res.text().catch(()=>'');
    throw new Error(`Proxy AI error ${res.status}: ${txt.slice(0,200)}`);
  }
  const data=await res.json();
  const content=data?.answer ?? data?.text ?? data?.content;
  if(!content) throw new Error('Proxy response did not contain answer text');
  return {text:String(content),source:'proxy',sources:Array.isArray(data?.sources)?data.sources:null};
}
function getSanitizedAssistantConfig(){
  const c=APP_STATE.assistantConfig||ASSISTANT_CONFIG_DEFAULTS;
  return {...c,apiKey:c.apiKey?'[redacted]':'',proxyToken:c.proxyToken?'[redacted]':''};
}
function buildAssistantContext(){
  const crop=getSelectedCrop();
  const sc=crop?getStructuredCrop(crop):null;
  const plan=crop?estimateCropPlan(crop):null;
  const allocation=crop?getPlannerAllocationForCrop(crop.name):null;
  const beds=getActiveBeds();
  const fullAllocation=allocatePlannerRows(getPlannerRows({ignoreSearch:true}));
  const rotationWarnings=collectRotationWarnings(fullAllocation).slice(0,10);
  return {
    date:CAL_NOW.toISOString().slice(0,10),
    zip:GARDEN_PROFILE.zip,
    zone:GARDEN_PROFILE.zone,
    county:GARDEN_PROFILE.county,
    soilProfile:{type:GARDEN_PROFILE.soilType},
    weatherSnapshot:{...normalizeWeatherState(APP_STATE.weather),alerts:weatherRiskFlags(crop||null).messages.slice(0,3)},
    beds:{totalSqFt:totalBedSqFt(beds),items:beds.map(b=>({name:b.name,lengthFt:b.lengthFt,widthFt:b.widthFt,sqFt:bedSqFt(b),sun:b.sun,drainage:b.drainage,layoutMode:b.layoutMode,rowSpacingIn:b.rowSpacingIn,trellisSide:b.trellisSide,rowHistory:b.rowHistory}))},
    placementPrefs:Object.fromEntries(Object.entries(APP_STATE.bedPlacementPrefs||{}).slice(0,20)),
    recipeTargets:{...APP_STATE.recipeTargets},
    uiContext:{activeTab:document.querySelector('.tab.active')?.textContent?.trim()||null,selectedCropId:sc?.id||null,selectedCropName:crop?.name||null},
    planner:{peopleCount:APP_STATE.peopleCount,mode:APP_STATE.plannerMode,bedSpaceLimitSqFt:APP_STATE.bedSpaceLimit||0,spacePriorityMode:APP_STATE.plannerPriorityMode||'balanced',selectedCropRecommendation:plan?{plants:plan.recPlants,areaSqFt:plan.areaSqFt,range:[plan.minPlants,plan.maxPlants],recipeBoost:plan.recipeBoost?.plantsRounded||0,recipeBoostMode:plan.recipeBoost?.mode||'legacy',historyAdjustment:plan.historyAdjustment||null,allocation:allocation?.allocation?{status:allocation.allocation.status,assignedPlants:allocation.allocation.assignedPlants,assignedSqFt:allocation.allocation.assignedSqFt,beds:(allocation.allocation.bedAssignments||[]).map(a=>({name:a.bedName,plants:a.plants,sqFt:a.sqFt}))}:null}:null},
    rotationWarnings,
    seasonArchives:getSeasonArchiveSummaries(5),
    observations:{recent:getObservationSummaries(8),selectedCrop:getObservationSummaries(5,crop?.name||'')},
    taskEngine:{...getTaskEngineUiState(),top:getTaskEngineSummaries(8)},
    timing:crop?{currentMonth:MONTHS[CAL_MONTH],nextMonth:MONTHS[NEXT_MONTH],currentMonthActions:monthActionsForCrop(crop,CAL_MONTH).map(k=>TM[k].t),nextMonthActions:monthActionsForCrop(crop,NEXT_MONTH).map(k=>TM[k].t)}:null,
    structuredCrop:sc?{id:sc.id,spacing:sc.spacing,yield:sc.yield,site:sc.site,preservation:sc.preservation,ipm:sc.ipm,recipeProfiles:sc.recipeProfiles}:null,
    recipeVarietySuggestions:crop?getRecipeVarietySuggestions(crop):[],
    assistantMode:getSanitizedAssistantConfig()
  };
}
function renderAssistantPanel(){
  const ctxEl=document.getElementById('mgContextPayload'), cropEl=document.getElementById('mgCropContext');
  if(ctxEl)ctxEl.textContent=JSON.stringify(buildAssistantContext(),null,2);
  if(cropEl){
    const crop=getSelectedCrop();
    cropEl.textContent=crop?`Selected crop: ${crop.name} (${crop.cat}) ‚Ä¢ Soil: ${GARDEN_PROFILE.soilType} ‚Ä¢ Weather: ${weatherSnapshotLabel()} ‚Ä¢ Household: ${APP_STATE.peopleCount}`:'Select a crop in ‚ÄúVarieties & Tips‚Äù to ask crop-specific questions.';
  }
  setAssistantStatus(assistantConfigSummary());
}
function answerMasterGardener(question){
  const q=(question||'').toLowerCase().trim();
  const crop=getSelectedCrop();
  const recentArchives=getSeasonArchiveSummaries(3);
  const recentObs=getObservationSummaries(5);
  const topTasks=getTaskEngineSummaries(6);
  if(/\b(task|to-?do|what should i do|this week plan|today plan)\b/.test(q)){
    if(!topTasks.length) return `No task suggestions are available yet. Render the Planner tab first, then add beds/observations/archives for richer task guidance.`;
    const cropFilter=(crop && /\b(this crop|selected crop|for this)\b/.test(q))?crop.name:'';
    const list=(cropFilter?topTasks.filter(t=>t.crop===cropFilter):topTasks).slice(0,5);
    if(!list.length) return `I don't have task suggestions for ${crop.name} yet. Switch Task Engine focus to All crops or add more observations/archives.`;
    return `Top ${getTaskEngineUiState().windowMode==='today'?'today':'this-week'} tasks${cropFilter?` for ${cropFilter}`:''}: ${list.map(t=>`${t.priority.toUpperCase()} ${t.title}${t.location?` @ ${t.location}`:''}${t.crop && !t.title.includes(t.crop)?` (${t.crop})`:''}`).join(' | ')}. See the Task Engine panel in Planner for full details and row suggestions.`;
  }
  if(!crop && /\barchive|last year|yield|what worked|pest pressure|disease pressure|season review\b/.test(q)){
    if(!recentArchives.length) return `No season archives saved yet. Use the Beds panel to save an end-of-season archive with yield notes, pest pressure, and row history.`;
    return `Recent season archives: ${recentArchives.map(a=>`${a.year||'Season'} ${a.name} (pests ${a.pestPressure}, disease ${a.diseasePressure}${a.yieldSummary?`; ${a.yieldSummary}`:''})`).join(' | ')}. You can load an archive's row history into the planner from the Beds panel.`;
  }
  if(!crop && /\bobservation|observed|log|photo|symptom note\b/.test(q)){
    if(!recentObs.length) return `No observation logs yet. Use the Observation Log section in the Planner/Beds panel to save date + crop + symptom + notes + photo reference entries.`;
    return `Recent observations: ${recentObs.map(o=>`${o.date} ${o.cropName}${o.bedLabel?` @ ${o.bedLabel}`:''}${o.symptom?` (${o.symptom})`:''}${o.photoRef?` [photo: ${o.photoRef}]`:''}`).join(' | ')}. Select a crop for crop-specific troubleshooting and symptom lookup.`;
  }
  if(!crop){
    return `Select a crop in the ‚ÄúVarieties & Tips‚Äù tab first, then ask again. I can answer timing, spacing, pests, clay-soil notes, and household plant counts using your planner data.`;
  }
  const sc=getStructuredCrop(crop), plan=estimateCropPlan(crop), currentActs=monthActionsForCrop(crop,CAL_MONTH), nextActs=monthActionsForCrop(crop,NEXT_MONTH);
  const wxFlags=weatherRiskFlags(crop);
  const timingNow=currentActs.length?currentActs.map(k=>TM[k].t).join(', '):'No listed actions this month';
  const timingNext=nextActs.length?nextActs.map(k=>TM[k].t).join(', '):'No listed actions next month';
  if(/\bspace|spacing|apart|row\b/.test(q)){
    return `${crop.name}: spacing target is ${fmtSpacing(sc.spacing)}. For your heavy clay, keep airflow and access in mind and avoid crowding even if square-foot density looks possible.`;
  }
  if(/\bhow many|how much|people|household|grow for\b/.test(q)){
    if(!plan)return `I don't have a household planning model for ${crop.name} yet.`;
    const allocRow=((APP_STATE.bedSpaceLimit||0)>0 || getActiveBeds().length>0)?getPlannerAllocationForCrop(crop.name):null;
    const bedNames=allocRow?.allocation?.bedAssignments?.length?` Beds: ${allocRow.allocation.bedAssignments.map(a=>`${a.bedName} (${a.plants})`).join(', ')}.`:'';
    const allocMsg=allocRow?.allocation?` With your ${APP_STATE.bedSpaceLimit||totalBedSqFt()} sq ft planning limit and ${APP_STATE.plannerPriorityMode.replace('_',' ')} priority, this crop is currently ${plannerStatusLabel(allocRow.allocation,allocRow.plan).toLowerCase()}${allocRow.allocation.status==='partial'?` at ~${allocRow.allocation.assignedPlants} plants` :''}.${bedNames}`:'';
    const hist=plan.historyAdjustment?.applied?` Historical outcome adjustment applied from ${plan.historyAdjustment.archiveYear||'your last archive'} (${plan.historyAdjustment.outcome}${plan.historyAdjustment.variety?`, ${plan.historyAdjustment.variety}`:''}), shifting success buffer from ${Math.round((plan.baseSuccess||plan.success)*100)}% to ${Math.round(plan.success*100)}%.`:``;
    return `For ${APP_STATE.peopleCount} people (${APP_STATE.plannerMode}), plan about ${plan.recPlants} ${crop.name} plants (range ${plan.minPlants}-${plan.maxPlants}), needing roughly ${plan.areaSqFt??'N/A'} sq ft. This estimate includes a ${(plan.success*100).toFixed(0)}% success factor buffer${plan.recipeBoost?.plantsRounded?` and a recipe-target boost of +${plan.recipeBoost.plantsRounded} plants`:''}.${hist}${allocMsg}`;
  }
  if(/\brotation|same row|after last year|previous season|row warning\b/.test(q)){
    const fam=getRotationFamily(crop,sc);
    const fullAllocation=allocatePlannerRows(getPlannerRows({ignoreSearch:true}));
    const warns=collectRotationWarnings(fullAllocation).filter(w=>{
      const alloc=getPlannerAllocationForCrop(crop.name);
      return (alloc?.allocation?.bedAssignments||[]).some(a=>a.bedName===w.bed);
    });
    const assignedRows=(getPlannerAllocationForCrop(crop.name)?.allocation?.bedAssignments||[]).map(a=>a.bedName).join(', ')||'no assigned beds yet';
    const archNote=recentArchives.length?` Latest archived season: ${recentArchives[0].year||'n/a'} (${recentArchives[0].name}) with pests ${recentArchives[0].pestPressure} and disease ${recentArchives[0].diseasePressure}.`:'';
    return `Rotation family for ${crop.name}: ${ROTATION_FAMILY_LABELS[fam]||fam}. Assigned beds: ${assignedRows}. ${warns.length?`Current row warnings affecting assigned beds: ${warns.map(w=>`${w.bed} ${w.row}: ${w.warning}`).join(' ')}`:'No row-family repeat warnings right now based on the row history dropdowns in your bed map.'}${archNote}`;
  }
  if(/\barchive|last year|season review|yield|what worked\b/.test(q)){
    if(!recentArchives.length) return `No season archives saved yet. Save one in the Beds panel to track yields, pest/disease pressure, and notes alongside row history.`;
    const top=recentArchives[0];
    const cropOutcome=getLatestCropOutcome(crop.name);
    const cropMsg=cropOutcome?` Latest ${crop.name} outcome: ${cropOutcome.outcome}${cropOutcome.yieldAmount?` ¬∑ yield ${cropOutcome.yieldAmount}`:''}${cropOutcome.variety?` ¬∑ variety ${cropOutcome.variety}`:''}${cropOutcome.pestIssue?` ¬∑ pest ${cropOutcome.pestIssue}`:''}${cropOutcome.diseaseIssue?` ¬∑ disease ${cropOutcome.diseaseIssue}`:''}.`:` No crop-specific outcome is archived for ${crop.name} yet.`;
    return `Latest season archive: ${top.year||'Season'} ${top.name}. Pest pressure: ${top.pestPressure}. Disease pressure: ${top.diseasePressure}. Yield summary: ${top.yieldSummary||'not entered'}. ${top.notesPreview?`Notes preview: ${top.notesPreview}`:''}${cropMsg} Use ‚ÄúApply Archive Row History‚Äù in Beds to reuse that season‚Äôs row history for rotation planning.`;
  }
  if(/\bobservation|observed|log|photo|symptom note\b/.test(q)){
    const cropObs=getObservationSummaries(5,crop.name);
    if(!cropObs.length) return `No observation logs are saved for ${crop.name} yet. Use the Observation Log section to record dates, symptoms, notes, and photo refs, then I can use them in troubleshooting.`;
    const latest=cropObs[0];
    return `Recent observations for ${crop.name}: ${cropObs.map(o=>`${o.date}${o.bedLabel?` ¬∑ ${o.bedLabel}`:''}${o.symptom?` ¬∑ ${o.symptom}`:''}${o.photoRef?` ¬∑ photo ${o.photoRef}`:''}`).join(' | ')}. Latest note preview: ${latest.notesPreview||'no notes'}. You can click ‚ÄúLookup‚Äù on an observation to open symptom lookup for that crop.`;
  }
  if(/\bweather|rain|humid|humidity|mildew risk|can i work|soil too wet\b/.test(q)){
    const wx=normalizeWeatherState(APP_STATE.weather);
    const msgs=wxFlags.messages.slice(0,3).join(' ');
    return `Weather snapshot: ${wx.rainLast3dIn}" rain last 3 days, ${wx.rainNext3dIn}" forecast next 3 days, humidity ${wx.humidityRisk}, soil marked ${wx.soilCondition}. ${msgs||'No major weather-based clay/mildew flags right now.'}`;
  }
  if(/\bsymptom|symptoms|what am i seeing|scout|scouting|threshold|when should i act|action threshold|treat|treatment\b/.test(q)){
    const issues=sc.ipm?.issueRecords||[];
    if(!issues.length) return `I don't have structured IPM issue records for ${crop.name} yet. I do have common pests/diseases and general scouting notes.`;
    const hits=findIpmIssuesByQuestion(sc,q);
    const chosen=hits.length?hits:issues.slice(0,3);
    const header=hits.length?`Matched IPM issue${hits.length>1?'s':''}`:`Top IPM issues`;
    const wxNote=wxFlags.mildewRisk||wxFlags.blightRisk?` Weather risk is elevated (${weatherSnapshotLabel()}) so scout more often.`:'';
    return `${header} for ${crop.name}: ${chosen.map(issue=>`${issue.label} [${issue.type}]${issue.symptoms?.length?` ¬∑ symptoms: ${issue.symptoms.slice(0,2).join('; ')}`:''}${issue.scout?.length?` ¬∑ scout: ${issue.scout.slice(0,2).join('; ')}`:''}${issue.actionThreshold?` ¬∑ threshold: ${issue.actionThreshold}`:''}`).join(' | ')}.${wxNote}`;
  }
  if(/\bpest|bug|disease|blight|mildew|worm|aphid|beetle|rot\b/.test(q)){
    const ipm=sc.ipm||{};
    const issues=(ipm.issueRecords||[]).slice(0,3);
    const wxNote=wxFlags.mildewRisk||wxFlags.blightRisk?` Weather risk is elevated right now (${weatherSnapshotLabel()}) so increase scouting frequency.`:'';
    const issueLead=issues.length?` Structured issues: ${issues.map(i=>`${i.label} (${i.type})`).join(', ')}.`:'';
    return `${crop.name} IPM focus in your app (MVP): common pests: ${(ipm.commonPests||[]).join(', ')||'N/A'}; common diseases: ${(ipm.commonDiseases||[]).join(', ')||'N/A'}. Scout for ${(ipm.scoutFor||[]).join(', ')||'symptoms'} and prioritize ${(ipm.prevention||[]).join(', ')||'prevention basics'}.${issueLead}${wxNote}`;
  }
  if(/\bwhen|now|this week|start|sow|transplant|plant\b/.test(q)){
    return `Timing for ${crop.name}: ${MONTHS[CAL_MONTH]} actions: ${timingNow}. ${MONTHS[NEXT_MONTH]} preview: ${timingNext}. Your crop detail calendar remains the source of truth for exact month windows.`;
  }
  if(/\bclay|soil|drain|wet\b/.test(q)){
    const clayTips=sc.notes?.clayTips||[];
    const weatherLead=wxFlags.avoidClayWork?`Current weather flag: avoid working clay until it drains/crumbles.`:`Current weather flag: clay looks more workable if it passes a crumble test.`;
    return clayTips.length?`Clay-soil notes for ${crop.name}: ${clayTips.join(' ')} ${weatherLead}`:`No crop-specific clay note is structured yet. Default rule for your heavy KY red clay: protect structure (don't work wet soil), top-dress compost, and prioritize drainage/raised rows for rot-prone crops. ${weatherLead}`;
  }
  if(/\brecipe|salsa|pickle|pesto|curry|preserv/.test(q)){
    const uses=(sc.preservation?.bestUses||[]).join(', ')||'no structured preservation tags yet';
    const rb=plan?.recipeBoost?.plantsRounded||0;
    const prof=(sc.recipeProfiles||[]).map(p=>`${p.recipe} (~1 plant per ${p.unitsPerPlant} target units)`).slice(0,3).join('; ');
    const varPicks=getRecipeVarietySuggestions(crop);
    const varMsg=varPicks.length?` Variety picks from your selected list: ${varPicks.map(v=>`${v.name} [${v.tags.join('/')}]`).join('; ')}.`:'';
    return `${crop.name} preservation/recipe tags: ${uses}. Current recipe targets add ${rb} plants to this crop's household recommendation${plan?.recipeBoost?.reasons?.length?` (${plan.recipeBoost.reasons.slice(0,3).join('; ')})`:''}.${prof?` Structured recipe profiles: ${prof}.`:''}${varMsg}`;
  }
  return `For ${crop.name}, I can help with timing (${MONTHS[CAL_MONTH]}: ${timingNow}), spacing (${fmtSpacing(sc.spacing)}), household counts (${plan?`${plan.recPlants} plants for ${APP_STATE.peopleCount} people`: 'model pending'}), and IPM focus (${(sc.ipm?.commonPests||[]).slice(0,2).join(', ')||'N/A'} / ${(sc.ipm?.commonDiseases||[]).slice(0,2).join(', ')||'N/A'}${sc.ipm?.issueRecords?.length?` ¬∑ ${sc.ipm.issueRecords.length} issue records`:''}).`;
}
async function askMasterGardener(){
  const input=document.getElementById('mgQuestion'), out=document.getElementById('mgResponse');
  if(!out)return;
  const q=input?.value?.trim()||'';
  if(!q){out.textContent='Ask something specific (for example: spacing, what should I do now, pests, or how many for my household).';renderAssistantPanel();return;}
  out.innerHTML='<div><strong>Question:</strong> '+escapeHtml(q)+'</div><div style="margin-top:6px"><strong>Answer:</strong> Thinking...</div>';
  const context=buildAssistantContext();
  let answer='',sources=[],statusMsg='';
  try{
    const cfg=APP_STATE.assistantConfig||ASSISTANT_CONFIG_DEFAULTS;
    if(cfg.mode==='proxy' && cfg.proxyEndpoint){
      const proxied=await callProxyMasterGardener(q,context);
      answer=proxied.text;
      sources=proxied.sources?.length?proxied.sources:['Proxy AI','Garden Context Payload','Your Garden Data'];
      statusMsg=`Proxy AI response received (${cfg.model||ASSISTANT_CONFIG_DEFAULTS.model}).`;
    }else if(cfg.mode==='api' && cfg.endpoint && cfg.model && cfg.apiKey){
      const remote=await callRemoteMasterGardener(q,context);
      answer=remote.text;
      sources=['Remote AI', 'Garden Context Payload', 'Your Garden Data'];
      statusMsg=`Remote AI response received (${cfg.model}).`;
    }else{
      answer=answerMasterGardener(q);
      sources=['Your Garden Data','Planner Metadata','KY-first Garden Rules (local profile)'];
      statusMsg=assistantConfigSummary();
    }
  }catch(err){
    const local=answerMasterGardener(q);
    answer=`Remote AI request failed, so I used the local garden-aware fallback.\n\n${local}\n\n(Reason: ${err?.message||err})`;
    sources=['Local Fallback','Your Garden Data','Planner Metadata'];
    statusMsg='Remote request failed. Using local fallback responses.';
  }
  out.innerHTML=`<div><strong>Question:</strong> ${escapeHtml(q)}</div><div style="margin-top:6px"><strong>Answer:</strong> ${escapeHtml(answer).replace(/\\n/g,'<br>')}</div><div class="mg-src">${sources.map(s=>`<span>${escapeHtml(s)}</span>`).join('')}</div>`;
  setAssistantStatus(statusMsg);
  renderAssistantPanel();
}
function useQuickPrompt(kind){
  const prompts={what_now:'What should I do now for this crop?',spacing:'What spacing should I use for this crop?',how_many:'How many should I grow for my household?',pests:'What pests and diseases should I watch for?',weather:'Is my soil too wet to work, and what weather risks should I watch?'};
  const input=document.getElementById('mgQuestion');
  if(input)input.value=prompts[kind]||'';
  askMasterGardener();
}
function renderSelectedStructuredPanel(){
  const crop=getSelectedCrop();
  if(!crop)return;
  const host=document.getElementById('dMain');
  if(!host)return;
  const panelHtml=buildStructuredPanelHtml(crop);
  const existing=host.querySelector('.tdx');
  if(existing)existing.outerHTML=panelHtml;
}
function buildTable(){
  const tb=document.getElementById('tb');tb.innerHTML='';let lc='';
  V.forEach((c,i)=>{
    if(c.cat!==lc){lc=c.cat;const r=document.createElement('tr');r.className='ch';r.innerHTML=`<td colspan="15">${c.cat.toUpperCase()}</td>`;tb.appendChild(r)}
    const tr=document.createElement('tr');
    const inCurrent=hasMonthAction(c,CAL_MONTH),inNext=hasMonthAction(c,NEXT_MONTH);
    tr.dataset.i=i;tr.dataset.s=c.season;tr.dataset.n=inCurrent?'1':'0';tr.dataset.m=inNext?'1':'0';tr.dataset.nm=c.name.toLowerCase();
    if(inCurrent)tr.className='hl';
    let h=`<td>${c.name}</td><td>${c.method}</td>`;
    for(let m=0;m<12;m++){
      const es=(c.mo||[]).filter(e=>e.m===m);
      const codes=['i','t','d','f','h'].filter(k=>es.some(e=>e.t===k));
      let cls='',txt='',title='';
      if(codes.length===1){
        cls=TM[codes[0]].c;
        txt=TM[codes[0]].t;
      }else if(codes.length>1){
        cls=`${TM[codes[0]].c}`;
        txt=`<div class="ms">${codes.map(k=>TM[k].t).join('<br>')}</div>`;
        title=` title="${codes.map(k=>TM[k].t).join(', ')}"`;
      }
      h+=`<td class="${cls}${m===CAL_MONTH?' tc2':''}"${title}>${txt}</td>`;
    }
    h+=`<td class="nc">${c.cn||''}</td>`;tr.innerHTML=h;tb.appendChild(tr);
  });
  highlightCurrentMonthHeader();
}
let CF='all';
function setFilter(f,b){document.querySelectorAll('.fbtn').forEach(x=>x.classList.remove('active'));b.classList.add('active');CF=f;filterTable()}
function filterTable(){
  const s=document.getElementById('searchBox').value.toLowerCase(),rows=document.querySelectorAll('#tb tr');
  let lr=null,lv=false;
  rows.forEach(r=>{
    if(r.classList.contains('ch')){lr=r;lv=false;r.classList.add('hid');return}
    const nm=r.dataset.nm||'',se=r.dataset.s||'';let sh=true;
    const crop=V[Number(r.dataset.i)];
    if(s&&!nm.includes(s))sh=false;
    if(sh&&CF==='current'&&!hasMonthAction(crop,CAL_MONTH))sh=false;
    if(sh&&CF==='next'&&!hasMonthAction(crop,NEXT_MONTH))sh=false;
    if(sh&&CF==='cool'&&se!=='cool')sh=false;
    if(sh&&CF==='warm'&&se!=='warm')sh=false;
    r.classList.toggle('hid',!sh);
    if(sh&&lr&&!lv){lr.classList.remove('hid');lv=true}
  });
}

// Varieties & Tips sidebar
function buildVL(){
  const c=document.getElementById('vli');let lc='';
  V.forEach((v,i)=>{
    if(v.cat!==lc){lc=v.cat;const d=document.createElement('div');d.className='vc2';d.textContent=v.cat;c.appendChild(d)}
    const el=document.createElement('div');el.className='vi';el.dataset.i=i;el.dataset.nm=v.name.toLowerCase();el.dataset.ct=v.cat.toLowerCase();
    const hv=v.vars&&v.vars.length>0;
    el.innerHTML=`<span>${v.name} <span class="tg ${v.season==='cool'?'tg-c':'tg-w'}">${v.season}</span></span>${hv?`<span class="vnc">${v.vars.length} var</span>`:''}`;
    el.onclick=()=>showDet(i,el);c.appendChild(el);
  });
}
function filterVL(){
  const s=document.getElementById('vegSearch').value.toLowerCase();
  const els=document.querySelectorAll('#vli .vi, #vli .vc2');let lc=null,cv=false;
  els.forEach(e=>{
    if(e.classList.contains('vc2')){if(lc&&!cv)lc.classList.add('hid');lc=e;cv=false;e.classList.remove('hid');return}
    const ok=!s||e.dataset.nm.includes(s)||e.dataset.ct.includes(s);
    e.classList.toggle('hid',!ok);if(ok)cv=true;
  });if(lc&&!cv)lc.classList.add('hid');
}
function showDet(idx,el){
  APP_STATE.selectedCropIndex=idx;
  document.querySelectorAll('.vi').forEach(x=>x.classList.remove('act'));
  if(el)el.classList.add('act');
  const v=V[idx],mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let sw=[],tp=[],hv=[];
  (v.mo||[]).forEach(m=>{
    if(m.t==='d'||m.t==='f')sw.push(mn[m.m]);
    if(m.t==='i')sw.push(mn[m.m]+' (indoors)');
    if(m.t==='t')tp.push(mn[m.m]);
    if(m.t==='h')hv.push(mn[m.m]);
  });
  sw=[...new Set(sw)];tp=[...new Set(tp)];hv=[...new Set(hv)];
  let h=`<div class="dc"><div class="dch"><h2>${v.name}</h2><div class="mt">${v.cat} ¬∑ ${v.season==='cool'?'‚ùÑÔ∏è Cool Season':'‚òÄÔ∏è Warm Season'} ¬∑ ${v.method}</div></div><div class="dcb">`;
  h+=`<div class="ig"><div class="ib"><div class="il">Sow / Start</div><div class="iv">${sw.join(', ')||'N/A'}</div></div><div class="ib"><div class="il">Transplant</div><div class="iv">${tp.join(', ')||'N/A'}</div></div><div class="ib"><div class="il">Harvest</div><div class="iv">${hv.join(', ')||'N/A'}</div></div><div class="ib"><div class="il">Season</div><div class="iv">${v.season==='cool'?'Cool (frost tolerant)':'Warm (frost sensitive)'}</div></div></div>`;
  if(v.tips&&v.tips.length){
    h+=`<div class="st">üí° Tips & Tricks for Shepherdsville</div>`;
    v.tips.forEach(t=>{h+=`<div class="tp">${t}</div>`});
  }
  if(v.vars&&v.vars.length){
    h+=`<div class="st">üå± Selected Varieties</div>`;
    v.vars.forEach(vr=>{
      const vt=getVarietyRecipeTags(v,vr);
      const vTagsHtml=(vt.tags.length||vt.roles.length)?`<div class="vrtags">${vt.tags.map(t=>`<span class="vrtag recipe">${escapeHtml(t)}</span>`).join('')}${vt.roles.map(t=>`<span class="vrtag role">${escapeHtml(t)}</span>`).join('')}</div>`:'';
      h+=`<div class="vc"><h3>${vr.n}</h3><div class="vm">${vr.d} days ¬∑ ${vr.tp}</div><div class="vd">${vr.desc}</div>`;
      h+=vTagsHtml;
      if(vr.qt)h+=`<div class="qt">${vr.qt}</div>`;
      if(vr.det){h+=`<div class="vdt">`;Object.entries(vr.det).forEach(([k,val])=>{h+=`<div class="vdi"><span class="vdl">${k}:</span><span class="vdv">${val}</span></div>`});h+=`</div>`}
      if(vr.src){h+=`<div style="margin-top:8px">`;vr.src.split(', ').forEach(s=>{h+=`<span class="stg">${s}</span>`});h+=`</div>`}
      h+=`</div>`;
    });
  }else{
    h+=`<div class="st">üå± Selected Varieties</div><div class="nv">No varieties selected yet ‚Äî we haven't picked these together! Ask me anytime.</div>`;
  }
  h+=buildStructuredPanelHtml(v);
  h+=`</div></div>`;
  document.getElementById('dMain').innerHTML=h;
  renderObservationLogPanel();
  renderAssistantPanel();
}
function switchTab(id,btn){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tc').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');document.getElementById('tab-'+id).classList.add('active');
  if(id==='plan'){renderPeoplePlanner();renderAssistantPanel();}
}
buildTable();buildVL();
initCalendarButtons();
renderTodaySummary();
filterTable();
loadBedAndWeatherState();
loadAssistantConfig();
handleBackupControlsChange();
handlePlannerControls();
renderAssistantPanel();
</script>
</body>
</html>
